<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>RuneSaga â€” Generations</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&family=Orbitron:wght@700;900&display=swap');

:root{
  --bg0:#07070e;--bg1:#0c0c18;--bg2:#111120;--bg3:#161630;
  --border:#1e1e38;--border2:#2a2a48;--border3:#3a3a5a;
  --txt:#c8cce8;--txt2:#7880a0;--txt3:#4a5070;
  --amber:#f0a828;--amber2:#c07810;--violet:#9050e8;--violet2:#6030b0;
  --cyan:#30d0c0;--green:#40e078;--red:#e04040;--red2:#a02020;
  --gold:#d4a017;--shield:#4878f0;
  --legacy:#d4a017;--salvage:#30c0a0;

  /* Responsive chrome sizing (JS keeps these in sync) */
  --header-h:44px;
  --footer-h:44px;
}

*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{
  background:var(--bg0);color:var(--txt);
  font-family:'Rajdhani',sans-serif;font-size:14px;
  background-image:
    radial-gradient(ellipse at 20% 50%,rgba(80,30,160,.08) 0%,transparent 50%),
    radial-gradient(ellipse at 80% 20%,rgba(30,80,160,.06) 0%,transparent 40%);
}

#game{display:grid;grid-template-rows:44px 1fr 44px;height:100dvh;}
#header{
  background:var(--bg1);border-bottom:1px solid var(--border2);
  display:flex;align-items:center;gap:12px;padding:0 14px;
  position:relative;z-index:10;
}
#header::after{
  content:'';position:absolute;bottom:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,var(--violet2) 30%,var(--amber2) 70%,transparent);
}
#main{display:grid;grid-template-columns:248px 1fr 260px;overflow:hidden;}
#footer{
  background:var(--bg1);border-top:1px solid var(--border2);
  display:flex;align-items:center;gap:10px;padding:0 14px;
}

.panel{
  background:var(--bg1);overflow-y:auto;padding:10px 12px;border-right:1px solid var(--border);
  -webkit-overflow-scrolling:touch;
}
#right-panel{border-right:none;border-left:1px solid var(--border);}
#center-panel{display:flex;flex-direction:column;overflow:hidden;border:none;padding:0;}
#center-content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;}
#log-wrap{
  height:170px;background:var(--bg0);border-top:1px solid var(--border);
  display:flex;flex-direction:column;
}
#log-head{
  display:flex;justify-content:space-between;align-items:center;
  padding:4px 10px;border-bottom:1px solid var(--border);
  background:var(--bg1);flex-shrink:0;
}
#combat-log{
  flex:1;overflow-y:auto;padding:5px 10px;
  font-family:'Share Tech Mono',monospace;font-size:11px;line-height:1.55;
  -webkit-overflow-scrolling:touch;
}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:var(--bg0)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}

/* Typography */
.logo{
  font-family:'Orbitron',sans-serif;font-size:12px;font-weight:900;
  color:var(--violet);letter-spacing:2px;
  text-shadow:0 0 12px rgba(144,80,232,.5);
}
.sec-title{
  font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;
  color:var(--txt3);border-bottom:1px solid var(--border);
  padding-bottom:5px;margin:10px 0 7px;
}
.sec-title:first-child{margin-top:2px;}
.wave-num{font-family:'Orbitron',sans-serif;font-size:12px;font-weight:700;color:var(--cyan);}

/* Stats */
.srow{display:flex;justify-content:space-between;align-items:center;margin:3px 0;}
.sl{color:var(--txt2);font-size:12px;}
.sv{color:var(--txt);font-weight:700;font-size:12px;}
.sdp{color:var(--green);font-size:11px;}
.sdn{color:var(--red);font-size:11px;}

/* Bars */
.bar-wrap{margin:5px 0 2px;}
.bar{height:11px;background:var(--bg3);border-radius:2px;overflow:visible;position:relative;border:1px solid var(--border);}
.bar-fill{height:100%;border-radius:1px;transition:width .2s;}
.bar-hp .bar-fill{background:linear-gradient(90deg,#1a8040,var(--green));}
.bar-shield-ovl{height:100%;position:absolute;top:0;background:rgba(72,120,240,.6);border-radius:1px;border-right:2px solid var(--shield);transition:all .2s;}
.bar-xp{height:3px;background:var(--bg3);border-radius:1px;margin-top:2px;}
.bar-xp-fill{height:100%;background:linear-gradient(90deg,var(--violet2),var(--violet));border-radius:1px;transition:width .4s;}
.bar-txt{font-size:10px;color:var(--txt3);text-align:center;margin-top:1px;font-family:'Share Tech Mono',monospace;}

/* Status Badges */
.sbadge{
  display:inline-flex;align-items:center;gap:2px;
  padding:1px 6px;border-radius:2px;font-size:10px;font-weight:700;margin:2px 1px;
  font-family:'Rajdhani',sans-serif;letter-spacing:.5px;cursor:default;
}
.sb-bleed{background:rgba(200,40,40,.2);color:#ff7070;border:1px solid rgba(200,40,40,.4);}
.sb-poison{background:rgba(40,180,40,.15);color:#70d870;border:1px solid rgba(40,180,40,.35);}
.sb-shield{background:rgba(72,120,240,.2);color:#78a8ff;border:1px solid rgba(72,120,240,.4);}
.sb-weak{background:rgba(180,140,30,.2);color:#e8c048;border:1px solid rgba(180,140,30,.4);}
.sb-vulnerable{background:rgba(220,100,30,.2);color:#f08840;border:1px solid rgba(220,100,30,.4);}
.sb-rage{background:rgba(220,60,20,.2);color:#ff7040;border:1px solid rgba(220,60,20,.5);}
.sb-slow{background:rgba(80,80,180,.2);color:#9090d8;border:1px solid rgba(80,80,180,.4);}
.sb-stun{background:rgba(220,200,30,.2);color:#e8d840;border:1px solid rgba(220,200,30,.4);}
.sb-tempo{background:rgba(144,80,232,.2);color:#c080ff;border:1px solid rgba(144,80,232,.4);}
.sb-regen{background:rgba(40,200,80,.15);color:#50e880;border:1px solid rgba(40,200,80,.35);}

/* Tags */
.tag{display:inline-block;padding:1px 7px;border-radius:2px;font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin:1px;}
.t-Bleed{background:rgba(200,40,40,.15);color:#ff8080;border:1px solid rgba(200,40,40,.3);}
.t-Poison{background:rgba(40,180,40,.12);color:#70d870;border:1px solid rgba(40,180,40,.3);}
.t-Shield,.t-Bulwark{background:rgba(72,120,240,.15);color:#80a8ff;border:1px solid rgba(72,120,240,.3);}
.t-Crit{background:rgba(240,168,40,.15);color:var(--amber);border:1px solid rgba(240,168,40,.3);}
.t-Tempo{background:rgba(144,80,232,.15);color:#c080ff;border:1px solid rgba(144,80,232,.3);}
.t-Arcane{background:rgba(60,120,240,.15);color:#80b0ff;border:1px solid rgba(60,120,240,.3);}
.t-Thorns{background:rgba(160,160,40,.15);color:#d0d060;border:1px solid rgba(160,160,40,.3);}
.t-Execute{background:rgba(220,40,40,.15);color:#ff5050;border:1px solid rgba(220,40,40,.3);}
.t-Sustain{background:rgba(40,180,80,.12);color:#60e090;border:1px solid rgba(40,180,80,.3);}
.t-Axiom{background:rgba(200,60,255,.15);color:#e070ff;border:1px solid rgba(200,60,255,.4);}

/* Genetic trait badge */
.gtrait{
  display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:3px;
  font-size:10px;font-weight:700;margin:2px;
  background:linear-gradient(135deg,rgba(60,20,80,.5),rgba(80,30,120,.4));
  border:1px solid rgba(160,80,220,.5);color:#d090ff;cursor:default;
}

/* Boon Cards */
.boon-card{
  background:var(--bg2);border:1px solid var(--border2);border-radius:5px;padding:10px;
  cursor:pointer;transition:transform .15s,border-color .15s,box-shadow .15s;position:relative;
}
.boon-card:hover{transform:translateY(-3px);}
.rc-common{border-color:#3a3a5a;}
.rc-common:hover{border-color:#6060a0;box-shadow:0 4px 16px rgba(80,80,160,.25);}
.rc-uncommon{border-color:#2a5a2a;}
.rc-uncommon:hover{border-color:#50a050;box-shadow:0 4px 16px rgba(60,160,60,.25);}
.rc-rare{border-color:#2a2a7a;}
.rc-rare:hover{border-color:#4040d0;box-shadow:0 4px 20px rgba(60,80,200,.3);}
.rc-epic{border-color:#5a2a7a;}
.rc-epic:hover{border-color:#9050c0;box-shadow:0 4px 20px rgba(160,60,220,.35);}
.rc-legendary{border-color:#7a5a00;background:#13110a;}
.rc-legendary:hover{border-color:var(--gold);box-shadow:0 4px 24px rgba(212,160,23,.35);}
.rc-axiom{border-color:#7a20b0;background:#100a1a;box-shadow:0 0 12px rgba(144,40,200,.2);}
.rc-axiom:hover{border-color:#c040ff;box-shadow:0 4px 24px rgba(180,60,255,.4);}
.boon-rar{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:4px;}
.rar-common{color:var(--txt3);}
.rar-uncommon{color:#50b050;}
.rar-rare{color:#5060d8;}
.rar-epic{color:#a040c0;}
.rar-legendary{color:var(--gold);}
.rar-axiom{color:#d050ff;}
.boon-name{font-weight:700;font-size:13px;margin-bottom:3px;}
.boon-desc{font-size:11px;color:var(--txt2);line-height:1.45;}

/* Enemy Cards */
.enemy-card{
  background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:9px 11px;margin:5px 0;
  display:flex;align-items:flex-start;gap:10px;
}
.enemy-card.ec-elite{border-color:var(--amber2);background:#141008;}
.enemy-card.ec-root-touched {
  border-color: #4a1a6a;
  background: #0e0818;
  box-shadow: 0 0 8px rgba(100, 20, 140, 0.3);
}
.eicon{width:38px;height:38px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;}
.einfo{flex:1;min-width:0;}
.ename{font-weight:700;font-size:13px;}
.etrait{font-size:10.5px;color:var(--txt3);margin-top:2px;font-style:italic;}
.estats{font-size:10.5px;color:var(--txt3);margin-top:1px;font-family:'Share Tech Mono',monospace;}
.ehpbar{height:5px;background:var(--bg3);border-radius:2px;margin-top:5px;overflow:hidden;}
.ehpfill{height:100%;background:linear-gradient(90deg,var(--red2),var(--red));border-radius:2px;transition:width .25s;}

/* Wave trait cards */
.trait-card{
  background:var(--bg2);border:1px solid #1a2a3a;border-left:3px solid var(--cyan);
  border-radius:4px;padding:7px 10px;margin:4px 0;display:flex;gap:8px;
}
.ticon{font-size:18px;flex-shrink:0;line-height:1;}
.tname{font-weight:700;font-size:12px;color:var(--cyan);}
.tdesc{font-size:11px;color:var(--txt2);margin-top:1px;}

/* Shop */
.shop-btn{
  background:var(--bg2);border:1px solid var(--border2);border-radius:4px;padding:7px 8px;cursor:pointer;text-align:center;
  transition:all .12s;display:flex;flex-direction:column;gap:2px;
}
.shop-btn:hover:not(.sb-disabled){border-color:var(--amber);background:#1a1508;}
.sb-disabled{opacity:.4;cursor:not-allowed;}
.sb-name{font-weight:700;font-size:12px;}
.sb-cost{font-size:11px;color:var(--gold);font-family:'Share Tech Mono',monospace;}
.sb-desc{font-size:9.5px;color:var(--txt3);}

/* Buttons */
.btn{
  padding:7px 16px;border:none;border-radius:3px;cursor:pointer;
  font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:.5px;
  transition:all .12s;
}
.btn:hover{transform:translateY(-1px);}
.btn-primary{background:linear-gradient(135deg,var(--violet2),var(--violet));color:#fff;box-shadow:0 2px 12px rgba(144,80,232,.3);}
.btn-primary:hover{box-shadow:0 4px 20px rgba(144,80,232,.5);}
.btn-amber{background:linear-gradient(135deg,var(--amber2),var(--amber));color:#000;}
.btn-amber:hover{box-shadow:0 4px 16px rgba(240,168,40,.4);}
.btn-danger{background:linear-gradient(135deg,#6a1818,var(--red2));color:#fff;}
.btn-green{background:linear-gradient(135deg,#1a4a28,#2a7a40);color:#fff;}
.btn-gold{background:linear-gradient(135deg,#7a4a00,var(--gold));color:#000;}
.btn-gold:hover{box-shadow:0 4px 16px rgba(212,160,23,.4);}
.btn-salvage{background:linear-gradient(135deg,#0a3a30,#1a6050);color:var(--salvage);border:1px solid var(--salvage);}
.btn-sm{padding:4px 10px;font-size:11px;}
.btn-ghost{background:var(--bg2);border:1px solid var(--border2);color:var(--txt2);}

/* Log colors */
.lhit{color:var(--txt);}
.lcrit{color:var(--amber);font-weight:700;}
.lmiss{color:var(--txt3);font-style:italic;}
.ldeath{color:var(--red);font-weight:700;}
.lstatus{color:#a070d8;}
.lheal{color:var(--green);}
.lshield{color:#78a8ff;}
.laxiom{color:#e070ff;font-style:italic;}
.lwave{color:var(--cyan);font-weight:700;display:block;background:rgba(48,208,192,.05);padding:2px 4px;margin:3px 0;border-radius:2px;}

/* Diff pips */
.diff-pip{width:10px;height:10px;border-radius:1px;background:var(--bg3);border:1px solid var(--border2);}
.diff-pip.dp-on{background:var(--red);border-color:var(--red);box-shadow:0 0 4px rgba(224,64,64,.5);}

/* Inventory items */
.inv-item{width:26px;height:26px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:13px;cursor:default;border:1px solid;}
.ii-common{border-color:#3a3a5a;background:var(--bg2);}
.ii-uncommon{border-color:#2a5a2a;background:#091209;}
.ii-rare{border-color:#2a2a6a;background:#090920;}
.ii-epic{border-color:#5a2a7a;background:#12091a;}
.ii-legendary{border-color:var(--gold);background:#13110a;}
.ii-axiom{border-color:#9020c0;background:#0f0818;box-shadow:0 0 6px rgba(160,40,200,.3);}

/* Retire banner */
.retire-banner{background:linear-gradient(135deg,#0a0a18,#12081e);border:1px solid var(--gold);border-radius:6px;padding:14px;margin:10px 0;}
.retire-banner-title{font-family:'Orbitron',sans-serif;font-size:13px;color:var(--gold);font-weight:700;margin-bottom:4px;letter-spacing:1px;}

/* â”€â”€ LEGACY SCREEN â”€â”€ */
#legacy-screen{
  position:fixed;inset:0;background:var(--bg0);z-index:100;display:none;flex-direction:column;
  background-image:radial-gradient(ellipse at 30% 40%,rgba(212,160,23,.06) 0%,transparent 50%);
}
#legacy-header{
  background:var(--bg1);border-bottom:1px solid var(--border2);
  display:flex;align-items:center;gap:16px;padding:0 16px;height:48px;flex-shrink:0;position:relative;
}
#legacy-header::after{
  content:'';position:absolute;bottom:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,var(--gold) 50%,transparent);
}
.legacy-tabs{display:flex;gap:4px;}
.ltab{
  padding:6px 14px;border-radius:3px;cursor:pointer;font-weight:700;font-size:12px;letter-spacing:.5px;
  transition:all .15s;color:var(--txt3);border:1px solid transparent;
}
.ltab:hover{color:var(--txt2);background:var(--bg2);}
.ltab.active{color:var(--gold);border-color:rgba(212,160,23,.3);background:rgba(212,160,23,.08);}
#legacy-body{flex:1;overflow:hidden;display:flex;flex-direction:column;}
#legacy-content{flex:1;overflow-y:auto;padding:20px;-webkit-overflow-scrolling:touch;}

/* Hero cards in legacy */
.hero-card{
  background:var(--bg2);border:1px solid var(--border2);border-radius:6px;padding:12px;cursor:pointer;
  transition:all .15s;position:relative;
}
.hero-card:hover{border-color:var(--border3);transform:translateY(-2px);}
.hero-card.hc-dead{opacity:.6;border-color:rgba(200,40,40,.3);}
.hero-card.hc-parent-a{border-color:#4878f0;box-shadow:0 0 10px rgba(72,120,240,.25);}
.hero-card.hc-parent-b{border-color:var(--violet);box-shadow:0 0 10px rgba(144,80,232,.25);}
.hc-gen{font-size:9px;font-weight:700;letter-spacing:2px;color:var(--txt3);text-transform:uppercase;}
.hc-name{font-weight:700;font-size:14px;margin:3px 0;}
.hc-stats{font-size:10.5px;color:var(--txt3);font-family:'Share Tech Mono',monospace;}

/* EV bars */
.ev-bar{height:4px;background:var(--bg3);border-radius:2px;margin-top:2px;overflow:hidden;}
.ev-fill{height:100%;border-radius:2px;transition:width .4s;}

/* Family tree nodes */
.tree-node{
  background:var(--bg2);border:1px solid var(--border2);border-radius:5px;padding:8px 10px;
  position:absolute;cursor:pointer;transition:all .15s;min-width:100px;text-align:center;
}
.tree-node:hover{border-color:var(--border3);z-index:5;}
.tree-node.tn-retired{border-color:rgba(212,160,23,.4);}
.tree-node.tn-spent{border-color:rgba(120,120,160,.35);opacity:.85;}
.tree-node.tn-dead{border-color:rgba(200,40,40,.3);opacity:.7;}
.tree-node.tn-selected{border-color:var(--gold);box-shadow:0 0 12px rgba(212,160,23,.3);z-index:6;}

/* Breeding preview */
.child-preview{background:linear-gradient(135deg,#0a0820,#120a30);border:1px solid rgba(144,80,232,.4);border-radius:6px;padding:14px;}

/* Imprint card */
.imprint-card{background:var(--bg2);border:1px solid rgba(200,60,255,.3);border-radius:5px;padding:10px;cursor:pointer;transition:all .15s;margin:5px 0;}
.imprint-card:hover{border-color:rgba(200,60,255,.6);background:#120a1e;transform:translateY(-2px);}

/* Animations */
@keyframes pulse2{0%,100%{opacity:1}50%{opacity:.5}}
.pulse{animation:pulse2 1.2s infinite;}
@keyframes slideIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.slide-in{animation:slideIn .25s ease;}

/* Overlay */
#overlay{position:fixed;inset:0;background:rgba(4,4,10,.95);display:flex;align-items:center;justify-content:center;z-index:200;}
.ov-box{
  background:var(--bg1);border:1px solid var(--border2);border-radius:8px;padding:32px;max-width:480px;width:92%;text-align:center;
}
.ov-box::before{
  content:'';display:block;height:2px;
  background:linear-gradient(90deg,transparent,var(--violet),var(--amber),transparent);
  margin-bottom:24px;border-radius:1px;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RESPONSIVE LAYOUT + DRAWERS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#main{
  grid-template-columns: clamp(210px, 22vw, 280px) 1fr clamp(220px, 24vw, 320px);
}
.mobile-only{display:none;}
.hero-toggle{}
.diff-wrap{
  display:flex;align-items:center;gap:6px;
  padding:4px 8px;border:1px solid var(--border2);
  border-radius:3px;background:var(--bg2);
  color:var(--txt2);
}
.diff-wrap .diff-label{font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--txt3);font-weight:700;}
.diff-wrap input[type="range"]{width:120px;accent-color:var(--amber);}
.diff-wrap .diff-val{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--gold);min-width:48px;text-align:right;}

#drawer-backdrop{
  display:none;
  position:fixed;inset:0;
  background:rgba(0,0,0,.55);
  z-index:45;
}
@media (max-width: 980px){
  #main{grid-template-columns:1fr;}
  .mobile-only{display:inline-flex;}
  #hero-panel, #right-panel{
    position:fixed;
    top:calc(var(--header-h) + env(safe-area-inset-top));
    bottom:calc(var(--footer-h) + env(safe-area-inset-bottom));
    width:min(88vw, 360px);
    z-index:50;
    background:var(--bg1);
    overflow-y:auto;
    box-shadow:0 0 24px rgba(0,0,0,.55);
    transition:transform .18s ease;
    border-right:none;
  }
  #hero-panel{
    left:0;
    transform:translateX(-105%);
    border-right:1px solid var(--border2);
  }
  #right-panel{
    right:0;
    left:auto;
    transform:translateX(105%);
    border-left:1px solid var(--border2);
  }
  body.drawer-hero #hero-panel{transform:translateX(0);}
  body.drawer-right #right-panel{transform:translateX(0);}
  body.drawer-hero #drawer-backdrop,
  body.drawer-right #drawer-backdrop{display:block;}
  #center-panel{border-left:none;border-right:none;}
}
@media (max-width: 720px){
  #game{grid-template-rows:auto 1fr auto;}
  #header{
    flex-wrap:wrap;
    row-gap:6px;
    height:auto;
    padding:6px 10px;
    padding-top:calc(6px + env(safe-area-inset-top));
  }
  #footer{
    flex-wrap:wrap;
    row-gap:6px;
    height:auto;
    padding:6px 10px;
    padding-bottom:calc(6px + env(safe-area-inset-bottom));
  }
  #log-wrap{height:140px;}
  .btn{padding:7px 12px;}
  #legacy-content{padding:14px;}
}
@media (max-width: 600px){
  /* Phone portrait: show hero panel above center content */
  .hero-toggle{display:none !important;}
  #main{display:flex;flex-direction:column;}
  #hero-panel{
    position:relative !important;
    top:auto !important;bottom:auto !important;left:auto !important;right:auto !important;
    width:100% !important;
    transform:none !important;
    box-shadow:none !important;
    border-right:none !important;
    border-left:none !important;
    border-bottom:1px solid var(--border);
    max-height:34vh;
    overflow-y:auto;
  }
  /* Right panel stays a drawer (opened via ðŸ“š Build) */
  #right-panel{width:min(92vw, 380px);}
  #center-panel{border-left:none;border-right:none;}
  .diff-wrap input[type="range"]{width:90px;}
}
@media (max-width: 420px){
  #log-wrap{height:120px;}
  #combat-log{font-size:10px;}
}
@media (max-width: 980px){
  #legacy-header{
    flex-wrap:wrap;
    height:auto;
    padding:10px 12px;
    gap:10px;
  }
  .legacy-tabs{
    width:100%;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    padding:2px 0;
  }
  .legacy-tabs .ltab{
    flex:0 0 auto;
    white-space:nowrap;
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   COLLAPSIBLE COMBAT LOG
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#log-wrap.collapsed{height:34px;}
#log-wrap.collapsed #combat-log{display:none;}
#log-wrap.collapsed #log-head{border-bottom:none;}


/* â”€â”€ TACTICS (pre-wave prep; cost paid when you start the trial) â”€â”€ */
.tactic-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:8px;}
.tactic-card{background:var(--bg2);border:1px solid var(--border2);border-radius:6px;padding:10px;cursor:pointer;transition:transform .12s,border-color .12s,box-shadow .12s;position:relative;}
.tactic-card:hover{transform:translateY(-2px);border-color:var(--amber);box-shadow:0 6px 18px rgba(0,0,0,.25);}
.tactic-card.sel{border-color:rgba(212,160,23,.7);box-shadow:0 0 14px rgba(212,160,23,.22);}
.tactic-card.disabled{opacity:.45;cursor:not-allowed;transform:none;box-shadow:none;}
.tactic-top{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;}
.tactic-name{font-weight:700;font-size:12px;}
.tactic-cost{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--gold);white-space:nowrap;}
.tactic-desc{font-size:10.5px;color:var(--txt2);line-height:1.35;margin-top:4px;}
.tactic-note{font-size:10px;color:var(--txt3);margin-top:6px;}
.tactic-pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid rgba(240,168,40,.35);background:rgba(240,168,40,.08);font-size:10px;color:var(--amber);}


/* â”€â”€ V5: Breeding Actions + Bloodline Aspects â”€â”€ */
.breed-actions{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0 10px;}
.ba-btn{background:var(--bg2);border:1px solid var(--border2);color:var(--txt2);}
.ba-btn.active{border-color:rgba(212,160,23,.55);box-shadow:0 0 10px rgba(212,160,23,.18);color:var(--txt);}
.ba-btn.disabled{opacity:.45;cursor:not-allowed;}
.breed-subpanel{background:rgba(20,18,40,.65);border:1px solid var(--border2);border-radius:6px;padding:10px;margin-top:8px;}
.choice-pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid rgba(144,80,232,.35);background:rgba(144,80,232,.10);cursor:pointer;font-size:11px;color:var(--txt2);}
.choice-pill.active{border-color:rgba(212,160,23,.6);background:rgba(212,160,23,.10);color:var(--txt);}
.aspect-row{display:flex;align-items:center;gap:8px;margin:6px 0;}
.aspect-bar{flex:1;height:6px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;overflow:hidden;}
.aspect-fill{height:100%;}

</style>
</head>
<body>

<!-- â”€â”€â”€ RUN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="game">
  <div id="header">
    <span class="logo">áš  RUNESAGA</span>
    <div style="width:1px;height:20px;background:var(--border2)"></div>
    <span class="wave-num" id="hdr-wave">Trial 1/12</span>
    <span style="font-size:11px;color:var(--txt3)" id="hdr-lvl">Lv.1</span>
    <div id="hdr-root-depth" style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--txt3)"></div>
    <div style="display:flex;align-items:center;gap:3px;font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--gold)">á›‹<span id="hdr-gold">0</span></div>
    <div style="display:flex;align-items:center;gap:3px;font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--salvage)">áš±<span id="hdr-salvage">0</span></div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button class="btn btn-sm mobile-only hero-toggle" onclick="toggleDrawer('hero')">ðŸ§¬ Hero</button>
      <button class="btn btn-sm mobile-only" onclick="toggleDrawer('right')">ðŸ“š Build</button>

      <div class="diff-wrap" title="Difficulty multiplier (enemy stats)">
        <span class="diff-label">DIFF</span>
        <input id="diff-slider" type="range" min="0" max="2" step="0.1" value="1" oninput="onDifficultyInput(this.value)">
        <span class="diff-val" id="diff-val">x1.0</span>
      </div>

      <button class="btn btn-sm" id="btn-speed" onclick="cycleSpeed()">1Ã— Speed</button>
      <button class="btn btn-sm btn-gold" onclick="showLegacy()">á›Ÿ Hero Hall</button>
      <button class="btn btn-sm btn-danger" onclick="confirmReset()">Reset Lineage</button>
    </div>
  </div>
  <div id="main">
    <div class="panel" id="hero-panel"><div id="hero-content"></div></div>
    <div id="center-panel" class="panel" style="border-right:none">
      <div id="center-content" style="flex:1;overflow-y:auto"></div>
      <div id="log-wrap">
        <div id="log-head">
          <span style="font-size:10px;font-weight:700;letter-spacing:2px;color:var(--txt3)">COMBAT LOG</span>
          <div style="display:flex;gap:6px;align-items:center">
            <button class="btn btn-sm btn-ghost" id="btn-log-toggle" onclick="toggleCombatLog()">Collapse</button>
            <button class="btn btn-sm" style="background:var(--bg2);border:1px solid var(--border2);color:var(--txt3);font-size:10px;padding:2px 8px" onclick="clearLog()">Clear</button>
          </div>
        </div>
        <div id="combat-log"></div>
      </div>
    </div>
    <div class="panel" id="right-panel"><div id="right-content"></div></div>
  </div>
  <div id="footer">
    <div id="ftr-btns" style="display:flex;gap:8px;align-items:center"></div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn btn-sm btn-ghost mobile-only" onclick="toggleCombatLog()">ðŸ—’ Log</button>
    </div>
    <div id="ftr-info" style="margin-left:auto;font-size:11px;color:var(--txt3);font-family:'Share Tech Mono',monospace"></div>
  </div>
</div>

<!-- Drawer backdrop for mobile panels -->
<div id="drawer-backdrop" onclick="closeDrawers()" aria-hidden="true"></div>

<!-- â”€â”€â”€ LEGACY SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="legacy-screen">
  <div id="legacy-header">
    <span style="font-family:'Orbitron',sans-serif;font-size:14px;font-weight:900;color:var(--gold);letter-spacing:2px;text-shadow:0 0 12px rgba(212,160,23,.4)">á›Ÿ HERO HALL</span>
    <div style="width:1px;height:20px;background:var(--border2)"></div>
    <div class="legacy-tabs">
      <div class="ltab active" id="ltab-pool" onclick="setLegacyTab('pool')">Chosen of the Hall</div>
      <div class="ltab" id="ltab-breed" onclick="setLegacyTab('breed')">Breeding</div>
      <div class="ltab" id="ltab-fallen" onclick="setLegacyTab('fallen')">Fallen Saga</div>
      <div class="ltab" id="ltab-tree" onclick="setLegacyTab('tree')">Family Tree</div>
      <div class="ltab" id="ltab-upgrades" onclick="setLegacyTab('upgrades')">Runesmith</div>
      <div class="ltab" id="ltab-codex" onclick="setLegacyTab('codex')">ðŸ“– Codex</div>
    </div>
    <div style="margin-left:auto;display:flex;gap:14px;align-items:center;font-size:12px;font-family:'Share Tech Mono',monospace">
      <span style="color:var(--gold)">á›’ <span id="leg-essence">0</span> Allfather's Blessing</span>
      <span style="color:var(--salvage)">áš± <span id="leg-salvage">0</span> Rune-Shards</span>
      <span style="color:var(--gold)">ðŸ—¿ <span id="leg-relics">0</span> Relics</span>
      <button class="btn btn-sm btn-danger" onclick="hideLegacy()">âœ• Return to Saga</button>
    </div>
  </div>
  <div id="legacy-body">
    <div id="legacy-content"></div>
  </div>
</div>

<!-- â”€â”€â”€ OVERLAY (start screen / retire / imprint) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="overlay" style="display:none">
  <div class="ov-box" id="overlay-content"></div>
</div>

<script>
// â•â•â• SEEDED RNG â•â•â•
let _rng=1;
function seedRng(s){_rng=(typeof s==='string'?hashStr(s):(+s||Date.now()))>>>0||1;}
function hashStr(s){let h=2166136261;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619);}return h>>>0||1;}
function rng(){_rng^=_rng<<13;_rng^=_rng>>>17;_rng^=_rng<<5;return(_rng>>>0)/4294967296;}
function ri(mn,mx){return Math.floor(rng()*(mx-mn+1))+mn;}
function rpick(a){return a[Math.floor(rng()*a.length)];}
function rshuffle(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;}
function rwgt(items,wfn){const ws=items.map(wfn),t=ws.reduce((a,b)=>a+b,0);let r=rng()*t;for(let i=0;i<items.length;i++){r-=ws[i];if(r<=0)return items[i];}return items[items.length-1];}

const LEX={trial:'Trial',trials:'Trials',saga:'Saga',runeGift:'Rune-Gift',runeGifts:'Rune-Gifts',sagaMarks:'Saga-Marks',runeShards:'Rune-Shards',allfatherBlessing:"Allfather's Blessing",seekOmen:'Seek Another Omen',draftTitle:'Rune-Gift Draft',omens:'Omens',offerings:'Offerings'};
function trialStr(n){return `${LEX.trial} ${n}`;}
function trialsSurvivedStr(n,max){return `${LEX.trials} Survived`;}
function sagaSeedLabel(){return `${LEX.saga} Seed (optional)`;}

// â•â•â• EV SYSTEM â•â•â•
const EV_FACTORS={hp:.6,atk:.08,def:.05,spd:.2,crit:.0012,eva:.0008,acc:.001,ls:.0006};
const BASE_STATS={maxHP:100,atk:15,def:6,spd:45,critChance:.08,critDmg:1.75,evasion:.04,accuracy:.88,lifesteal:0};
const EV_KEYS=['hp','atk','def','spd','crit','eva','acc','ls'];
const EV_CAP_BASE=60;
function evCap(){return Math.min(100,EV_CAP_BASE+(META.upgrades.evCap||0)*10);}
function evDerived(evs){
  return{
    maxHP:BASE_STATS.maxHP+Math.floor((evs.hp||0)*EV_FACTORS.hp),
    atk:Math.round((BASE_STATS.atk+(evs.atk||0)*EV_FACTORS.atk)*10)/10,
    def:Math.round((BASE_STATS.def+(evs.def||0)*EV_FACTORS.def)*10)/10,
    spd:Math.round(BASE_STATS.spd+(evs.spd||0)*EV_FACTORS.spd),
    critChance:Math.min(.9,BASE_STATS.critChance+(evs.crit||0)*EV_FACTORS.crit),
    critDmg:BASE_STATS.critDmg,
    evasion:Math.min(.6,BASE_STATS.evasion+(evs.eva||0)*EV_FACTORS.eva),
    accuracy:Math.min(.99,BASE_STATS.accuracy+(evs.acc||0)*EV_FACTORS.acc),
    lifesteal:Math.min(.4,BASE_STATS.lifesteal+(evs.ls||0)*EV_FACTORS.ls),
  };
}
function emptyEVs(){return{hp:0,atk:0,def:0,spd:0,crit:0,eva:0,acc:0,ls:0};}

// â•â•â• GENETIC TRAITS â•â•â•
const GTRAITS={
  serrated:{name:'Serrated',icon:'ðŸ—¡',desc:'On hit: 22% chance to apply 1 Bleed (2s).',color:'#ff7070'},
  aegis:{name:'Skjald-Born',icon:'ðŸ›¡',desc:'Battle start: gain 8 Shield.',color:'#80a8ff'},
  skirmisher:{name:'Raider-Born',icon:'ðŸ’¨',desc:'+8 SPD when below 50% HP.',color:'#80d0ff'},
  venomkiss:{name:'Venomkiss',icon:'â˜ ',desc:'Poison ticks deal +1 extra damage.',color:'#70d870'},
  gambler:{name:'Fate-Bold',icon:'ðŸŽ²',desc:'+5% Crit Chance, âˆ’2 DEF.',color:'#e8c048'},
  spite:{name:'Spite',icon:'ðŸŒµ',desc:'Reflect 8% of damage taken as true dmg.',color:'#d0d060'},
  ironblood:{name:'Iron Blood',icon:'âš™',desc:'+5 DEF.',color:'#90a8c8'},
  swift_born:{name:'Swift Born',icon:'âš¡',desc:'+8 SPD.',color:'#c080ff'},
  lucky:{name:'Fortune-Touched',icon:'ðŸ€',desc:'+4% Crit Chance.',color:'#60e090'},
  resilient:{name:'Hardened',icon:'â¤',desc:'+25 Max HP.',color:'#80e080'},
  predatory:{name:'Wolf-Blood',icon:'ðŸ†',desc:'+3 ATK when below 50% HP.',color:'#f08040'},
  vampiric_b:{name:'Wound-Drinker Blood',icon:'ðŸ§›',desc:'+3% Lifesteal.',color:'#d070d8'},
  tenacious:{name:'Tenacious',icon:'ðŸ”°',desc:'Below 25% HP: take 40% less damage.',color:'#60b8ff'},
  executioner_b:{name:"Executor's Blood",icon:'ðŸ’€',desc:'+15% dmg to enemies below 30% HP.',color:'#ff5050'},
};
const GTRAIT_KEYS=Object.keys(GTRAITS);
const TRAIT_MAX_BASE=3;

// â•â•â• STATUS DEFS â•â•â•
const STATUS={
  bleed:{name:'Bleed',icon:'ðŸ©¸',cls:'sb-bleed',desc:'DoT: (3+stacks) dmg/sec'},
  poison:{name:'Poison',icon:'â˜ ',cls:'sb-poison',desc:'DoT: (2+stacks) dmg/sec'},
  shield:{name:'Shield',icon:'ðŸ›¡',cls:'sb-shield',desc:'Absorbs damage'},
  weak:{name:'Weak',icon:'ðŸ’”',cls:'sb-weak',desc:'-25% damage dealt'},
  vulnerable:{name:'Vuln',icon:'ðŸŽ¯',cls:'sb-vulnerable',desc:'+30% damage taken'},
  rage:{name:'Rage',icon:'ðŸ”¥',cls:'sb-rage',desc:'+4 ATK per stack'},
  slow:{name:'Slow',icon:'ðŸŒ',cls:'sb-slow',desc:'-30% Speed'},
  stun:{name:'Stun',icon:'ðŸ’«',cls:'sb-stun',desc:'Cannot act'},
  tempo:{name:'Tempo',icon:'âš¡',cls:'sb-tempo',desc:'+3 SPD per stack'},
  regen:{name:'Regen',icon:'ðŸ’š',cls:'sb-regen',desc:'Heals HP per sec'},
};

const REALM_TIERS=[];

// â•â•â• BOONS â•â•â•
const BOONS=[
  {id:'iron_skin',name:'Iron Skin',rarity:'common',tags:['Bulwark'],icon:'ðŸ›¡',desc:'+22 Defense.',effects:[{t:'stat',s:'def',v:22}]},
  {id:'battle_fury',name:'Battle Fury',rarity:'common',tags:['Crit'],icon:'âš”',desc:'+14 Attack.',effects:[{t:'stat',s:'atk',v:14}]},
  {id:'thick_blood',name:'Thick Blood',rarity:'common',tags:['Sustain'],icon:'â¤',desc:'+65 Max HP.',effects:[{t:'stat',s:'maxHP',v:65},{t:'stat',s:'hp',v:65}]},
  {id:'sharp_edge',name:'Keen Edge',rarity:'common',tags:['Crit'],icon:'ðŸ—¡',desc:'+9% Crit Chance.',effects:[{t:'stat',s:'critChance',v:.09}]},
  {id:'swift_strikes',name:'Stormblows',rarity:'common',tags:['Tempo'],icon:'ðŸ’¨',desc:'+18 Speed.',effects:[{t:'stat',s:'spd',v:18}]},
  {id:'blood_sense',name:'Blood Sense',rarity:'common',tags:['Bleed'],icon:'ðŸ©¸',desc:'Attacks apply 1 Bleed (3s).',effects:[{t:'onHit',ef:'status',st:'bleed',sk:1,dur:3}]},
  {id:'toxic_touch',name:'Eitr-Touch',rarity:'common',tags:['Poison'],icon:'â˜ ',desc:'Attacks apply 1 Poison (4s).',effects:[{t:'onHit',ef:'status',st:'poison',sk:1,dur:4}]},
  {id:'vampiric',name:"Draugr's Thirst",rarity:'common',tags:['Sustain'],icon:'ðŸ©¸',desc:'+8% Lifesteal.',effects:[{t:'stat',s:'lifesteal',v:.08}]},
  {id:'bulwark_start',name:'Bulwark',rarity:'common',tags:['Bulwark','Shield'],icon:'ðŸ”°',desc:'Start each battle with 35 Shield.',effects:[{t:'onBattleStart',ef:'shield',amt:35}]},
  {id:'dodge_step',name:'Skirmish-Step',rarity:'common',tags:['Tempo'],icon:'ðŸ’ƒ',desc:'+9% Evasion.',effects:[{t:'stat',s:'evasion',v:.09}]},
  {id:'steady_aim',name:"Ullr's Eye",rarity:'common',tags:['Crit'],icon:'ðŸŽ¯',desc:'+25% Crit Damage.',effects:[{t:'stat',s:'critDmg',v:.25}]},
  {id:'reinforced',name:'Reinforced',rarity:'common',tags:['Bulwark'],icon:'ðŸ°',desc:'+12 Defense, +20 Max HP.',effects:[{t:'stat',s:'def',v:12},{t:'stat',s:'maxHP',v:20},{t:'stat',s:'hp',v:20}]},
  {id:'honed_reflex',name:'Honed Reflex',rarity:'common',tags:['Tempo','Crit'],icon:'âš¡',desc:'+12 Speed, +5% Crit Chance.',effects:[{t:'stat',s:'spd',v:12},{t:'stat',s:'critChance',v:.05}]},

  {id:'hemorrhage',name:'Hemorrhage',rarity:'uncommon',tags:['Bleed'],icon:'ðŸ’¢',desc:'Bleed deals 70% more damage.',effects:[{t:'passive',k:'bleedMult',v:1.70}]},
  {id:'virulent',name:'Festering',rarity:'uncommon',tags:['Poison'],icon:'ðŸ§ª',desc:'Poison deals 70% more damage.',effects:[{t:'passive',k:'poisonMult',v:1.70}]},
  {id:'shield_bash',name:'Shield Bash',rarity:'uncommon',tags:['Bulwark','Thorns'],icon:'ðŸ’¥',desc:'When Shield breaks, deal 22 true dmg.',effects:[{t:'passive',k:'shieldBash',v:22}]},
  {id:'crit_surge',name:'Wound-Open',rarity:'uncommon',tags:['Crit'],icon:'âš¡',desc:'Crits apply Vulnerable (3s) to enemy.',effects:[{t:'onCrit',ef:'statusEnemy',st:'vulnerable',sk:1,dur:3}]},
  {id:'tempo_rise',name:'Battle-Rise',rarity:'uncommon',tags:['Tempo'],icon:'ðŸŒ€',desc:'Each kill grants +1 Tempo stack.',effects:[{t:'onKill',ef:'status',st:'tempo',sk:1,dur:9999}]},
  {id:'executioner',name:'Executioner',rarity:'uncommon',tags:['Execute'],icon:'ðŸ’€',desc:'+28% damage to enemies below 30% HP.',effects:[{t:'passive',k:'executioner',v:.28}]},
  {id:'thorns',name:'Thorns',rarity:'uncommon',tags:['Thorns'],icon:'ðŸŒµ',desc:'Reflect 22% of damage taken.',effects:[{t:'passive',k:'thorns',v:.22}]},
  {id:'battle_trance',name:'Battle Trance',rarity:'uncommon',tags:['Tempo'],icon:'ðŸ”',desc:'Every 5th attack deals +90% bonus dmg.',effects:[{t:'passive',k:'trance',v:5}]},
  {id:'twin_strike',name:'Twin Strike',rarity:'uncommon',tags:['Tempo','Crit'],icon:'âš”',desc:'22% chance to attack twice per swing.',effects:[{t:'passive',k:'twin',v:.22}]},
  {id:'bleed_weak',name:'Bleeding Edge',rarity:'uncommon',tags:['Bleed'],icon:'ðŸ—¡',desc:'Bleed also applies Weak to target.',effects:[{t:'passive',k:'bleedWeak',v:true}]},
  {id:'poison_slow',name:'Dulling Eitr',rarity:'uncommon',tags:['Poison'],icon:'ðŸŒ',desc:'Applying Poison also Slows the enemy.',effects:[{t:'passive',k:'poisonSlow',v:true}]},
  {id:'guard_mark',name:"Guardian's Mark",rarity:'uncommon',tags:['Bulwark','Sustain'],icon:'âœ¨',desc:'+45 Max HP, +10 Defense.',effects:[{t:'stat',s:'maxHP',v:45},{t:'stat',s:'hp',v:45},{t:'stat',s:'def',v:10}]},

  {id:'necrotic',name:'Necrotic Touch',rarity:'rare',tags:['Poison'],icon:'ðŸ§Ÿ',desc:'Each Poison stack reduces enemy DEF by 3.',effects:[{t:'passive',k:'necroticPoison',v:3}]},
  {id:'vanguard',name:'Vanguard',rarity:'rare',tags:['Bulwark','Shield'],icon:'ðŸ›¡',desc:'Taking damage grants 10 Shield.',effects:[{t:'onDmg',ef:'shield',amt:10}]},
  {id:'rampage',name:'Rampage',rarity:'rare',tags:['Execute','Tempo'],icon:'ðŸ˜¤',desc:'Each kill grants +7 ATK (this battle).',effects:[{t:'onKill',ef:'tempStat',s:'atk',v:7}]},
  {id:'soul_rend',name:'Spirit Rend',rarity:'rare',tags:['Arcane'],icon:'ðŸ‘»',desc:'22% of damage bypasses enemy Defense.',effects:[{t:'passive',k:'defpen',v:.22}]},
  {id:'overwhelming',name:'Crusher',rarity:'rare',tags:['Crit','Arcane'],icon:'ðŸ’ª',desc:'Crits ignore 55% of enemy Defense.',effects:[{t:'passive',k:'critDefpen',v:.55}]},
  {id:'predator',name:'Wolf-Hunger',rarity:'rare',tags:['Execute','Sustain'],icon:'ðŸ†',desc:'+22% ATK when below 50% HP.',effects:[{t:'passive',k:'predator',v:.22}]},
  {id:'crimson_tide',name:'Crimson Tide',rarity:'rare',tags:['Bleed'],icon:'ðŸŒŠ',desc:'Bleed also Slows the target.',effects:[{t:'passive',k:'bleedSlow',v:true}]},
  {id:'arcane_surge',name:'Galdr-Surge',rarity:'rare',tags:['Arcane'],icon:'ðŸ”®',desc:'Every 4th attack: +90% magic dmg (ignores DEF).',effects:[{t:'passive',k:'arcane',v:4}]},
  {id:'living_armor',name:'Root-Bound Plate',rarity:'rare',tags:['Sustain'],icon:'ðŸ’š',desc:'Regen 3% Max HP per second.',effects:[{t:'passive',k:'regen',v:.03}]},
  {id:'berserker',name:"Berserker's Heart",rarity:'rare',tags:['Execute','Tempo'],icon:'ðŸ’¢',desc:'Below 30% HP: +40% ATK, +20% SPD.',effects:[{t:'passive',k:'berserk',atk:.40,spd:.20,thr:.30}]},

  {id:'death_mark',name:'Death Mark',rarity:'epic',tags:['Execute','Bleed'],icon:'â˜ ',desc:'On kill, next attack deals +160% bonus dmg.',effects:[{t:'onKill',ef:'flag',f:'deathMark',v:1}]},
  {id:'plague_lord',name:'Eitr-Lord',rarity:'epic',tags:['Poison'],icon:'â˜£',desc:'Applying Poison spreads 1 stack to all enemies.',effects:[{t:'passive',k:'plagueLord',v:true}]},
  {id:'void_strike',name:'Ginnunga-Strike',rarity:'epic',tags:['Arcane'],icon:'ðŸŒ€',desc:'Every 8th attack deals 3Ã— damage (ignores DEF).',effects:[{t:'passive',k:'void',v:8}]},
  {id:'apex_predator',name:'Hunt-King',rarity:'epic',tags:['Execute'],icon:'ðŸ¦',desc:'Each kill grants permanent +6 ATK.',effects:[{t:'onKill',ef:'permStat',s:'atk',v:6}]},
  {id:'undying',name:'Undying',rarity:'epic',tags:['Sustain'],icon:'ðŸ”„',desc:'Once per battle, revive with 35% HP.',effects:[{t:'passive',k:'undying',v:true}]},

  {id:'chain_lightning',name:"Thor's Lash",rarity:'legendary',tags:['Arcane','Tempo'],icon:'âš¡',desc:'Crits splash 55% dmg to a random other enemy.',effects:[{t:'onCrit',ef:'splash',v:.55}]},
  {id:'eternal_hunger',name:'Eternal Hunger',rarity:'legendary',tags:['Sustain','Execute'],icon:'ðŸŒ‘',desc:'+30% Lifesteal. Overhealing becomes Shield.',effects:[{t:'stat',s:'lifesteal',v:.30},{t:'passive',k:'overhealShield',v:true}]},

  {id:'ax_opening',name:'RUNE: First Blood',rarity:'axiom',tags:['Axiom','Crit'],icon:'ðŸ’«',desc:'First hit each battle always crits.',effects:[{t:'passive',k:'axiomOpen',v:true}]},
  {id:'ax_aegis',name:'RUNE: Shield Law',rarity:'axiom',tags:['Axiom','Shield','Sustain'],icon:'ðŸ’Ž',desc:'Overhealing becomes Shield.',effects:[{t:'passive',k:'overhealShield',v:true}]},
  {id:'ax_crimson',name:'RUNE: Crimson Law',rarity:'axiom',tags:['Axiom','Bleed'],icon:'ðŸ©¸',desc:'Applying Bleed also applies Weak.',effects:[{t:'passive',k:'axiomCrimson',v:true}]},
  {id:'ax_ghost',name:'RUNE: Shade-Step',rarity:'axiom',tags:['Axiom','Tempo'],icon:'ðŸ‘»',desc:'When you dodge, gain +2 Tempo stacks.',effects:[{t:'onDodge',ef:'status',st:'tempo',sk:2,dur:9999}]},
  {id:'ax_echo',name:'RUNE: Echo Strike',rarity:'axiom',tags:['Axiom','Tempo'],icon:'ðŸ”',desc:'Every 3rd attack repeats at 50% power.',effects:[{t:'passive',k:'axiomEcho',v:3}]},
  {id:'ax_iron_law',name:'RUNE: Iron Law',rarity:'axiom',tags:['Axiom','Bulwark'],icon:'âš–',desc:'20% of your Defense adds to Attack.',effects:[{t:'passive',k:'axiomIronLaw',v:.20}]},
  {id:'ax_harvest',name:'RUNE: Death Harvest',rarity:'axiom',tags:['Axiom','Sustain'],icon:'âš—',desc:'Kills restore 20% Max HP.',effects:[{t:'onKill',ef:'healPct',v:.20}]},
  {id:'ax_wrath',name:'RUNE: Berserkr Law',rarity:'axiom',tags:['Axiom','Crit'],icon:'ðŸ”¥',desc:'Crits grant Rage stacks (+4 ATK each, max 15).',effects:[{t:'onCrit',ef:'status',st:'rage',sk:1,dur:9999,mx:15}]},
  {id:'ax_fortress',name:'RUNE: Stone Resolve',rarity:'axiom',tags:['Axiom','Bulwark','Shield'],icon:'ðŸ¯',desc:'Shield absorbs entire hits, not just damage.',effects:[{t:'passive',k:'axiomFortress',v:true}]},
  {id:'ax_kinetic',name:'RUNE: Storm-Edge',rarity:'axiom',tags:['Axiom','Crit','Tempo'],icon:'ðŸ’ ',desc:'Every 10 SPD = +2% Crit Chance.',effects:[{t:'passive',k:'axiomKinetic',v:true}]},
  {id:'ax_plague',name:'RUNE: Eitr Thread',rarity:'axiom',tags:['Axiom','Poison','Bleed'],icon:'ðŸ¦ ',desc:'Status effects last 60% longer.',effects:[{t:'passive',k:'axiomPlague',v:1.6}]},
  {id:'ax_mirror',name:'RUNE: Mirror Law',rarity:'axiom',tags:['Axiom','Thorns'],icon:'ðŸªž',desc:'30% of damage taken is reflected as true dmg.',effects:[{t:'passive',k:'axiomMirror',v:.30}]},

{id:'precision_optics', name:'Hawk-Sight',      rarity:'common',  tags:['Crit'],                icon:'ðŸ”­',desc:'+8% Accuracy.', effects:[{t:'stat',s:'accuracy',v:.08}]},
{id:'cleaving_arc',     name:'Cleaving Arc',          rarity:'uncommon',tags:['Execute','Tempo'],     icon:'ðŸª“',desc:'On hit: splash 35% damage to a random other enemy.', effects:[{t:'onHit',ef:'splash',v:.35}]},
{id:'frost_touch',      name:'Frost Touch',           rarity:'uncommon',tags:['Tempo'],              icon:'â„ï¸',desc:'On hit: apply Slow (2s).', effects:[{t:'onHit',ef:'statusEnemy',st:'slow',sk:1,dur:2}]},
{id:'sunder_blows',     name:'Sunder Blows',          rarity:'uncommon',tags:['Arcane'],             icon:'ðŸª¨',desc:'On hit: reduce enemy DEF by 2 (stacks, battle).', effects:[{t:'passive',k:'shred',v:2}]},
{id:'sniper_protocol',  name:"Huntsman's Mark",       rarity:'uncommon',tags:['Crit'],               icon:'ðŸŽ¯',desc:'Attacks target the lowest-HP enemy.', effects:[{t:'passive',k:'targetLowest',v:true}]},
{id:'ward_protocol',    name:'Runic Ward',         rarity:'rare',    tags:['Bulwark'],            icon:'ðŸ§¿',desc:'Once per battle, the first debuff applied to you is negated.', effects:[{t:'passive',k:'wardDebuff',v:true}]},
{id:'antitoxin_glands', name:'Hardened Blood',      rarity:'rare',    tags:['Sustain'],            icon:'ðŸ§¬',desc:'Take 40% less Bleed/Poison damage.', effects:[{t:'passive',k:'dotResist',v:.60}]},
{id:'stunning_crits',   name:'Reel-Blow',        rarity:'rare',    tags:['Crit'],               icon:'ðŸ’«',desc:'Crits have 18% chance to Stun (1s).', effects:[{t:'passive',k:'stunCrit',v:.18}]},
{id:'second_wind',      name:'Second Wind',           rarity:'rare',    tags:['Sustain'],            icon:'ðŸŒ¬ï¸',desc:'Once per battle, dropping below 30% HP heals 20% Max HP.', effects:[{t:'passive',k:'secondWind',v:.20}]},
];

const GEAR_TEMPLATES={
  weapon_iron_seax:{slot:'weapon',baseName:'Iron Seax',rarity:'common',loreNote:'A short blade, practical and honest.',affixes:[{stat:'atk',value:8,label:'+8 ATK'}]},
  weapon_ulfberht:{slot:'weapon',baseName:'Ulfberht Blade',rarity:'uncommon',loreNote:'Forged with runes in the steel.',affixes:[{stat:'atk',value:14,label:'+14 ATK'},{stat:'critChance',value:0.06,label:'+6% Crit'}]},
  weapon_gram_shard:{slot:'weapon',baseName:"Gram's Shard",rarity:'rare',loreNote:'A fragment of the sword that slew FÃ¡fnir.',affixes:[{stat:'atk',value:18,label:'+18 ATK'},{stat:'critChance',value:0.10,label:'+10% Crit'},{stat:'onCritBleedChance',value:0.20,label:'On Crit: 20% chance â€” Bleed (3s)'}]},
  weapon_dainsleif:{slot:'weapon',baseName:'DÃ¡insleif',rarity:'epic',loreNote:'"Drawn blade never sheathes unsated."',flavor:'It will not rest until it has fed.',affixes:[{stat:'atk',value:24,label:'+24 ATK'},{stat:'critChance',value:0.15,label:'+15% Crit'},{stat:'executionBonus',value:0.22,label:'+22% dmg below 30%'}]},
  weapon_tyrfing:{slot:'weapon',baseName:'Tyrfing',rarity:'legendary',loreNote:'"Cursed to cause three great evils."',flavor:'Power without mercy.',affixes:[{stat:'atk',value:30,label:'+30 ATK'},{stat:'critChance',value:0.18,label:'+18% Crit'},{stat:'permAtkOnKill',value:4,label:'Kills grant +4 permanent ATK'},{stat:'cursedDamageMult',value:0.08,label:'CURSED: +8% damage taken'}]},
  weapon_gungnir_echo:{slot:'weapon',baseName:"Gungnir's Echo",rarity:'axiom',loreNote:"The Allfather's spear never misses.",flavor:'True weapon. True path.',affixes:[{stat:'atk',value:20,label:'+20 ATK'},{stat:'defPen',value:0.40,label:'Ignore 40% DEF'},{stat:'accuracySet',value:0.99,label:'Accuracy set to 99%'}]},
  armor_hide_wrap:{slot:'armor',baseName:'Hide Wrap',rarity:'common',loreNote:'Rough but better than nothing.',affixes:[{stat:'def',value:6,label:'+6 DEF'}]},
  armor_chain_rings:{slot:'armor',baseName:'Chainmail Rings',rarity:'uncommon',loreNote:'Dvergar-forged links.',affixes:[{stat:'def',value:12,label:'+12 DEF'},{stat:'maxHP',value:20,label:'+20 Max HP'}]},
  armor_rune_plate:{slot:'armor',baseName:'Rune-Plate',rarity:'rare',loreNote:'Protection-runes burned into the steel.',affixes:[{stat:'def',value:18,label:'+18 DEF'},{stat:'maxHP',value:35,label:'+35 Max HP'},{stat:'shieldOnBattleStart',value:15,label:'Battle start: +15 Shield'}]},
  armor_ulfr_hide:{slot:'armor',baseName:'Ulfr Hide',rarity:'epic',loreNote:'Skinned from a Jotunheim cave-wolf.',affixes:[{stat:'def',value:22,label:'+22 DEF'},{stat:'maxHP',value:50,label:'+50 Max HP'},{stat:'dotResist',value:0.30,label:'Take 30% less Bleed/Poison'}]},
  talisman_runestone:{slot:'talisman',baseName:'Carved Runestone',rarity:'common',loreNote:'A ward carved in haste.',affixes:[{stat:'evasion',value:0.04,label:'+4% Evasion'}]},
  talisman_valknut:{slot:'talisman',baseName:'Valknut Amulet',rarity:'uncommon',loreNote:"Three interlocked triangles. Odin's mark.",affixes:[{stat:'critDmg',value:0.25,label:'+25% Crit Damage'},{stat:'evasion',value:0.04,label:'+4% Evasion'}]},
  talisman_yggdrasil_leaf:{slot:'talisman',baseName:'Yggdrasil Leaf',rarity:'rare',loreNote:'Fallen from a branch that no longer exists.',affixes:[{stat:'lifesteal',value:0.06,label:'+6% Lifesteal'},{stat:'regenPct',value:0.02,label:'Regen 2% HP/sec'}]},
  talisman_norns_thread:{slot:'talisman',baseName:"Norn's Thread",rarity:'epic',loreNote:'Spun from the fate of a hero who almost survived.',affixes:[{stat:'critChance',value:0.10,label:'+10% Crit Chance'},{stat:'lifesteal',value:0.08,label:'+8% Lifesteal'},{stat:'evasion',value:0.05,label:'+5% Evasion'}]},
};

function generateGearItem(templateId,template,wave){
  return {id:templateId+'_'+ri(10000,99999),templateId,name:template.baseName,slot:template.slot,rarity:template.rarity,flavor:template.flavor||null,loreNote:template.loreNote||null,affixes:template.affixes.map(a=>({...a})),notches:0,sundered:false,sagaHistory:[],forgedBy:null,forgedByName:null,passiveBonus:null};
}
function getGearEffectiveAffixes(gear){
  if(!gear)return[];
  const mult=gear.sundered?0.70:1.0;
  return gear.affixes.map(affix=>({...affix,effectiveValue:typeof affix.value==='number'?affix.value*mult:affix.value,label:gear.sundered?`${affix.label} âš SUNDERED`:affix.label}));
}

function gearMaxHPAffixValue(item){
  if(!item)return 0;
  return getGearEffectiveAffixes(item).reduce((sum,affix)=>{
    if(affix.stat==='maxHP'&&typeof affix.effectiveValue==='number')return sum+affix.effectiveValue;
    return sum;
  },0);
}
function applyGearMaxHPDelta(hero,oldItem,newItem){
  if(!hero)return;
  const oldMaxHP=gearMaxHPAffixValue(oldItem);
  const newMaxHP=gearMaxHPAffixValue(newItem);
  const delta=Math.floor(newMaxHP-oldMaxHP);
  if(delta===0)return;
  hero.maxHP=Math.max(10,hero.maxHP+delta);
  if(delta>0)hero.hp=Math.min(hero.maxHP,hero.hp+delta);
  else hero.hp=Math.min(hero.hp,hero.maxHP);
}
function applyAllGearMaxHP(hero){
  if(!hero||!hero.gear)return;
  const total=Object.values(hero.gear).reduce((sum,item)=>sum+gearMaxHPAffixValue(item),0);
  if(total<=0)return;
  hero.maxHP=Math.max(10,hero.maxHP+Math.floor(total));
  hero.hp=Math.min(hero.maxHP,hero.hp+Math.floor(total));
}
function gearCost(item){
  const base={common:8,uncommon:14,rare:22,epic:35,legendary:55,axiom:80};
  return (base[item.rarity]||15)+Math.floor((item.notches||0)*-1.5);
}
function rarityColor(rarity){
  const map={common:'#6060a0',uncommon:'#50a050',rare:'#6060d8',epic:'#a040c0',legendary:'var(--gold)',axiom:'#d050ff'};
  return map[rarity]||'#888';
}
function rarityBorderColor(rarity){
  const map={common:'#3a3a5a',uncommon:'#2a5a2a',rare:'#2a2a7a',epic:'#5a2a7a',legendary:'#7a5a00',axiom:'#7a20b0'};
  return map[rarity]||'var(--border2)';
}
function genForgeStallItem(wave){
  const rw={common:40,uncommon:25,rare:15,epic:8,legendary:3,axiom:1};
  const boost=Math.min(wave,10);
  rw.common=Math.max(10,rw.common-boost*2);
  rw.rare+=boost;
  rw.epic+=Math.floor(boost/2);
  const templates=Object.entries(GEAR_TEMPLATES);
  const picked=rwgt(templates,([id,t])=>rw[t.rarity]||1);
  if(!picked)return null;
  return generateGearItem(picked[0],picked[1],wave);
}
function hasSunderedGear(){
  if(!G||!G.hero||!G.hero.gear)return false;
  return Object.values(G.hero.gear).some(item=>item&&item.sundered);
}

const NOTCH_HISTORY_TEMPLATES=[
  wave=>`Bloodied at Trial ${wave}`,
  wave=>`Scarred in the ${wave<=3?'Midgard':wave<=6?'Helheim':wave<=9?'Jotunheim':'Muspelheim'} crossing`,
  wave=>`Worn thin at Trial ${wave}`,
  wave=>`Notched by the battle at Trial ${wave}`,
];
function tryAddNotch(gear,wave){
  if(!gear||gear.sundered)return;
  if(rng()>0.15)return;
  gear.notches=Math.min(5,(gear.notches||0)+1);
  if(gear.sagaHistory&&gear.sagaHistory.length<3)gear.sagaHistory.push(rpick(NOTCH_HISTORY_TEMPLATES)(wave));
  if(gear.notches>=5&&!gear.sundered){
    gear.sundered=true;
    addLog(`âš  ${gear.name} is Sundered. Visit the Forge Stall to recondition it.`,'lstatus');
  }
}
function addNotchesToHeroGear(wave){
  if(!G||!G.hero||!G.hero.gear)return;
  Object.values(G.hero.gear).forEach(item=>{if(item)tryAddNotch(item,wave);});
}
function reconditionGear(slot){
  if(!G||!G.hero||!G.hero.gear)return;
  const item=G.hero.gear[slot];
  if(!item||!item.sundered)return;
  const cost=10+((META.upgrades&&META.upgrades.evCap)||0);
  if(META.salvage<cost){addLog(`áš± ${cost} Rune-Shards required to recondition ${item.name}.`,'lstatus');return;}
  META.salvage-=cost;
  item.notches=0; item.sundered=false;
  if(rng()<0.20+((META.upgrades&&META.upgrades.evCap)||0)*0.05){
    const numericalAffixes=item.affixes.filter(a=>typeof a.value==='number'&&a.value>0);
    if(numericalAffixes.length){
      const target=rpick(numericalAffixes);
      const improvement=Math.max(1,Math.floor(target.value*0.15));
      const oldMaxHP=gearMaxHPAffixValue(item);
      target.value+=improvement;
      target.label+=` (+${improvement} reconditioned)`;
      const newMaxHP=gearMaxHPAffixValue(item);
      if(newMaxHP!==oldMaxHP){const before={...item,affixes:item.affixes.map(a=>({...a}))};before.affixes=before.affixes.map(a=>a.stat==='maxHP'&&typeof a.value==='number'?{...a,value:a.value-improvement}:a);applyGearMaxHPDelta(G.hero,before,item);}
      addLog(`âš’ ${item.name} reconditioned! One affix improved.`,'laxiom');
    }else addLog(`âš’ ${item.name} reconditioned.`,'lstatus');
  }else addLog(`âš’ ${item.name} reconditioned.`,'lstatus');
  item.sagaHistory=item.sagaHistory||[];
  item.sagaHistory.push(`Reforged at Trial ${G.wave}`);
  if(item.sagaHistory.length>3)item.sagaHistory.shift();
  saveMeta(); updateMetaHeader(); renderAll();
}
function buyGear(){
  const item=G.forgeStallItem;
  if(!item)return;
  const cost=gearCost(item);
  if(G.gold<cost)return;
  G.gold-=cost;
  const oldGear=G.hero.gear[item.slot];
  G.hero.gear[item.slot]=item;
  applyGearMaxHPDelta(G.hero,oldGear,item);
  G.forgeStallItem=null;
  addLog(`âš’ Equipped: ${item.name}`,'lheal');
  renderAll();
}
const MYTH_LINES = {
  crit_first: [
    'The Norns smiled.',
    'Fate leaned in.',
    'The thread tightens.',
  ],
  crit_third: [
    'The thread sharpens.',
    'The saga quickens.',
    'Something ancient stirs.',
  ],
  crit_fifth: [
    'Fate moves through you now.',
    'The Norns weave faster.',
    'Earned. Utterly earned.',
  ],

  nearDeath: [
    'Even the dying wolf bites.',
    'The thread frays â€” but holds.',
    'Not yet. The saga is unfinished.',
    'This is what the blood was shaped for.',
  ],
  nearDeathKill: [
    'The saga grows heavier.',
    'Death passed over. Not forgotten.',
    'The root remembers this.',
  ],

  kill_first: [
    'The saga grows.',
  ],
  kill_multi: [
    'The Allfather watches.',
    'Another thread cut.',
  ],
  rootDrinks: [
    'The root drinks.',
    'What falls, feeds.',
  ],

  levelUp: [
    'Your saga is etched.',
    'The blood strengthens.',
    'The weave holds another layer.',
  ],

  waveStart: {
    1:  'The first trial begins. Write something worth remembering.',
    2:  'The second trial. The root stirs.',
    3:  'Three trials. The Norns have noted you.',
    4:  'The dead remember everything here.',
    5:  'Halfway. The tree grows heavier above.',
    6:  'The sixth trial. The strongest of the dead.',
    7:  'Jotunheim sends its own. Brace.',
    8:  'Eight trials survived. The root shifts.',
    9:  'Three trials remain. The tree can feel you.',
    10: 'The strong ones no longer wait.',
    11: 'One thread from the end.',
    12: 'The final trial. What you were shaped for.',
  },

  waveEnd: {
    1:  'The first deed is written.',
    4:  'The dead fell again. As they should.',
    6:  'The sixth trial survives the saga. The tree breathes.',
    12: 'All twelve trials. The thread held.',
  },

  axiomPicked: [
    'The Allfather watches.',
    'A Rune Law learned. The tree remembers.',
    'This is why the trial exists.',
  ],

  shieldBroke: [
    'The ward falls. Hold the line.',
    'Exposed. Adapt.',
  ],
};

const NarrationEngine = {
  cooldowns: {},
  waveCount: 0,
  WAVE_QUOTA: 5,
  COOLDOWN_TICKS: {
    crit: 80,
    nearDeath: 99999,
    kill: 50,
    levelUp: 99999,
    generic: 40,
  },
  critCount: 0,
  killCount: 0,
  _narratedNearDeath: false,

  reset() {
    this.cooldowns = {};
    this.waveCount = 0;
    this.critCount = 0;
    this.killCount = 0;
    this._narratedNearDeath = false;
    if(G)G._narratedNearDeath=false;
  },

  canFire(category) {
    if (category === 'waveStart' || category === 'waveEnd') return true;
    if (this.waveCount >= this.WAVE_QUOTA) return false;
    const cooldown = this.COOLDOWN_TICKS[category] || 40;
    const lastFired = this.cooldowns[category];
    if (typeof lastFired !== 'number') return true;
    return G ? (G.tick - lastFired) >= cooldown : true;
  },

  fire(category, linesOrLine, logClass) {
    if (!this.canFire(category)) return;
    const line = Array.isArray(linesOrLine) ? rpick(linesOrLine) : linesOrLine;
    if (!line) return;
    this.cooldowns[category] = G ? G.tick : 0;
    if (category !== 'waveStart' && category !== 'waveEnd') this.waveCount++;
    addLog(`  ${line}`, logClass || 'lstatus');
  },

  onCrit() {
    this.critCount++;
    if (this.critCount >= 5) this.fire('crit', MYTH_LINES.crit_fifth, 'lstatus');
    else if (this.critCount >= 3) this.fire('crit', MYTH_LINES.crit_third, 'lstatus');
    else this.fire('crit', MYTH_LINES.crit_first, 'lstatus');
  },

  onKill() {
    this.killCount++;
    if (G && G.tierFlags && G.tierFlags.killDropsMark && this.killCount >= 3) {
      this.fire('kill', MYTH_LINES.rootDrinks, 'lstatus');
    } else if (this.killCount === 1) {
      this.fire('kill', MYTH_LINES.kill_first, 'lstatus');
    } else if (this.killCount >= 4) {
      this.fire('kill', MYTH_LINES.kill_multi, 'lstatus');
    }
  },

  onNearDeath() {
    if (this._narratedNearDeath) return;
    this._narratedNearDeath = true;
    if(G)G._narratedNearDeath=true;
    this.fire('nearDeath', MYTH_LINES.nearDeath, 'lstatus');
  },

  onNearDeathKill() {
    this.fire('generic', MYTH_LINES.nearDeathKill, 'lstatus');
  },
};

// â•â•â• ENEMY ARCHETYPES â•â•â•
const ARCHETYPES = [
  // â”€â”€ MIDGARD TIER (Trials 1â€“3) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'bruiser',
    displayName: 'Wolf-Warrior',
    norseName: 'ÃšlfheÃ°inn',
    realmTier: 'midgard',
    icon: 'ðŸº', col: '#a03020',
    base: { hp:80, atk:14, def:8, spd:40, cc:.05, cd:1.5 },
    scl:  { hp:28, atk:5,  def:3, spd:2  },
    trait: 'Wolf-Rage',
    td: 'Immune to Slow. Enrages below 35% HP (+5 ATK).',
    beh: 'steady',
    tier2Behavior: 'enrageOnLowHP', tier2Threshold: 0.35, tier2BonusAtk: 5,
  },
  {
    id: 'striker',
    displayName: 'Keen Scout',
    norseName: 'Stormfarer',
    realmTier: 'midgard',
    icon: 'âš¡', col: '#806010',
    base: { hp:48, atk:16, def:4, spd:70, cc:.22, cd:2.0 },
    scl:  { hp:12, atk:6,  def:1, spd:5  },
    trait: 'Keen Edge',
    td: '+25% Crit Chance.',
    beh: 'fast',
    tier2Behavior: 'dodgeAfterCrit', tier2DodgeChance: 0.10,
  },
  {
    id: 'tank',
    displayName: 'Veteran Shield',
    norseName: 'Einherjar',
    realmTier: 'midgard',
    icon: 'ðŸ›¡', col: '#305080',
    base: { hp:120, atk:10, def:22, spd:25, cc:.03, cd:1.5 },
    scl:  { hp:38,  atk:3,  def:5,  spd:1  },
    trait: 'Iron Will',
    td: 'First hit negated. Regains 2% HP on first attack (Tier 2+).',
    beh: 'steady',
    tier2Behavior: 'regenOnFirstAttack', tier2RegenPct: 0.02,
  },
  {
    id: 'archer',
    displayName: 'Runic Archer',
    norseName: "Ullr's Chosen",
    realmTier: 'midgard',
    icon: 'ðŸ¹', col: '#305a6a',
    base: { hp:44, atk:15, def:3, spd:62, cc:.16, cd:1.8 },
    scl:  { hp:14, atk:5,  def:1, spd:3  },
    trait: 'Piercing Shot',
    td: 'Every 4th attack ignores most Defense. Crits may expose Vulnerable.',
    beh: 'fast',
    tier2Behavior: 'exposeCritVuln', tier2ExposeChance: 0.35,
  },
  // â”€â”€ NIFLHEIM / HELHEIM TIER (Trials 4â€“6) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'swarm',
    displayName: 'Risen Dead',
    norseName: 'Draugr Pack',
    realmTier: 'niflheim',
    icon: 'ðŸ’€', col: '#406020',
    base: { hp:20, atk:8, def:2, spd:62, cc:.05, cd:1.5 },
    scl:  { hp:6,  atk:3, def:1, spd:3  },
    trait: 'Swarming Dead',
    td: 'Spawns in groups of 3. At RagnarÃ¶k Tier 4+, slain members may rise once.',
    beh: 'fast',
    tier2Behavior: null,
  },
  {
    id: 'shaman',
    displayName: 'Curse-Weaver',
    norseName: 'VÃ¶lva',
    realmTier: 'niflheim',
    icon: 'ðŸ”®', col: '#702080',
    base: { hp:58, atk:12, def:6, spd:45, cc:.08, cd:1.5 },
    scl:  { hp:15, atk:4,  def:2, spd:2  },
    trait: 'Curse-Weaving',
    td: 'Every 3rd attack applies Weak. First attack also applies Weak (Tier 2+).',
    beh: 'caster',
    tier2Behavior: 'weakOnFirstAttack',
  },
  {
    id: 'leech',
    displayName: 'Blood-Mage',
    norseName: 'GaldramaÃ°r',
    realmTier: 'helheim',
    icon: 'ðŸ©¸', col: '#402040',
    base: { hp:64, atk:13, def:5, spd:42, cc:.08, cd:1.5 },
    scl:  { hp:18, atk:4,  def:2, spd:2  },
    trait: 'Life-Drain',
    td: 'Heals 30% of damage dealt.',
    beh: 'sustain', ls: .30,
    tier2Behavior: null,
  },
  {
    id: 'warden',
    displayName: 'Barrow-Lord',
    norseName: 'Hersir',
    realmTier: 'helheim',
    icon: 'ðŸ§¿', col: '#5a4a10',
    base: { hp:76, atk:11, def:12, spd:34, cc:.05, cd:1.6 },
    scl:  { hp:22, atk:3,  def:3,  spd:1  },
    trait: 'Death-Banner',
    td: 'Battle start: grants Shield to allies. Every 4th attack applies Weak.',
    beh: 'steady',
    tier2Behavior: null,
  },
  // â”€â”€ JOTUNHEIM TIER (Trials 7â€“9) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'assassin',
    displayName: 'Shadow-Stalker',
    norseName: 'NÃ­Ã°ing',
    realmTier: 'jotunheim',
    icon: 'ðŸ—¡', col: '#301840',
    base: { hp:38, atk:22, def:3, spd:58, cc:.28, cd:2.2 },
    scl:  { hp:10, atk:8,  def:1, spd:4  },
    trait: 'Dishonored Strike',
    td: 'First attack deals 2Ã— damage.',
    beh: 'burst',
    tier2Behavior: 'dodgeAfterCrit', tier2DodgeChance: 0.15,
  },
  {
    id: 'frost',
    displayName: 'Ice-Binder',
    norseName: 'Ãsalfr',
    realmTier: 'jotunheim',
    icon: 'â„ï¸', col: '#204070',
    base: { hp:58, atk:12, def:6, spd:44, cc:.08, cd:1.6 },
    scl:  { hp:16, atk:4,  def:2, spd:2  },
    trait: 'Frostbite',
    td: 'Every 3rd attack applies Slow. Crits may Stun.',
    beh: 'caster',
    tier2Behavior: null,
  },
  // â”€â”€ MUSPELHEIM TIER (Trials 10â€“11) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'bombardier',
    displayName: 'Rune-Smith',
    norseName: 'Dvergar Forge-Master',
    realmTier: 'muspelheim',
    icon: 'ðŸ’£', col: '#6a4000',
    base: { hp:68, atk:30, def:10, spd:20, cc:.10, cd:2.0 },
    scl:  { hp:20, atk:10, def:3,  spd:1  },
    trait: 'Runic Overcharge',
    td: 'Every 3rd attack deals 2Ã— damage.',
    beh: 'slow',
    tier2Behavior: null,
  },
];

// â•â•â• WAVE TRAITS â•â•â•
const WAVE_TRAITS=[
  {id:'armored',name:'Armored',icon:'ðŸ°',desc:'Enemies gain +25% Defense.',apply(es){es.forEach(e=>e.def=Math.floor(e.def*1.25));}},
  {id:'frenzied',name:'Frenzied',icon:'ðŸ˜¤',desc:'Enemies gain +20% Speed.',apply(es){es.forEach(e=>e.spd=Math.floor(e.spd*1.20));}},
  {id:'toxic_air',name:'Toxic Air',icon:'â˜£',desc:'All units take 1 dmg/sec.',apply(es,h,Gx){Gx.waveFlags.toxicAir=true;}},
  {id:'glass',name:'Reckless Rage',icon:'ðŸ”ª',desc:'Enemies: -25% HP, +30% ATK.',apply(es){es.forEach(e=>{e.hp=e.maxHP=Math.floor(e.hp*.75);e.atk=Math.floor(e.atk*1.30);});}},
  {id:'blessed',name:'Runed',icon:'âœ¨',desc:'Enemies start with 20% HP as Shield.',apply(es){es.forEach(e=>addShieldToUnit(e,Math.floor(e.hp*.20)));}},
  {id:'enraged',name:'Enraged',icon:'ðŸ˜¡',desc:'Enemies gain +15 ATK when ally dies.',apply(es,h,Gx){Gx.waveFlags.enraged=true;}},
  {id:'regenerating',name:'Wound-Knit',icon:'ðŸ’š',desc:'Enemies regen 2% HP/sec.',apply(es,h,Gx){Gx.waveFlags.eRegen=.02;}},
  {id:'elite_wave',name:'Elite',icon:'â­',desc:'One enemy becomes Elite (+65% stats).',apply(es){if(es.length){const e=es[0];e.elite=true;e.hp=e.maxHP=Math.floor(e.hp*1.65);e.atk=Math.floor(e.atk*1.65);e.def=Math.floor(e.def*1.5);e.name='Elite '+e.name;}}},
  {id:'quickened',name:'Quickened',icon:'ðŸ’¨',desc:'Enemies +15% SPD, +10% Crit Chance.',apply(es){es.forEach(e=>{e.spd=Math.floor(e.spd*1.15);e.cc=Math.min(.8,(e.cc||.05)+.10);});}},
  {id:'echo_atk',name:'Echo Barrage',icon:'ðŸ”Š',desc:'Enemies 25% chance to attack twice.',apply(es,h,Gx){Gx.waveFlags.eEcho=true;}},
  {id:'reinforcements',name:'Horde-Call',icon:'ðŸš¨',desc:'+1 additional enemy joins the wave.',apply(es,h,Gx){if(es.length<8){const arch=rpick(ARCHETYPES);es.push(mkEnemy(arch,Gx.wave,false));}}},
  {id:'marked_prey',name:'Marked Prey',icon:'ðŸŽ¯',desc:'Battle start: hero becomes Vulnerable (3s). Enemies gain +10% Crit Chance.',apply(es,h,Gx){es.forEach(e=>{e.cc=Math.min(.8,(e.cc||.05)+.10);});Gx.waveFlags.heroStartVuln=3;}},
];


const RAGNARÃ–K_TIERS = [
  {
    tier: 1, name: 'First Root Darkens',
    omen: 'The cold comes earlier than it should.',
    revealStage: 'none',
    apply(G) { /* enemyHPMult handled in mkEnemy */ }
  },
  {
    tier: 2, name: 'The Wolves Stir',
    omen: 'They move in patterns now, not just hunger.',
    revealStage: 'none',
    apply(G) { G.tierFlags.archetypeBehaviors = true; }
  },
  {
    tier: 3, name: 'Mist Thickens',
    omen: 'The boundary between realms grows soft.',
    revealStage: 'none',
    apply(G) { G.tierFlags.minWaveTraits = 1; }
  },
  {
    tier: 4, name: 'The Dead Remember',
    omen: 'Some do not stay fallen.',
    revealStage: 'none',
    apply(G) { G.tierFlags.draugrEchoChance = 0.15; }
  },
  {
    tier: 5, name: 'JÃ¶rmungandr Stirs',
    omen: 'The ocean trembles. Something beneath has shifted weight.',
    revealStage: 'indirect',
    apply(G) { G.tierFlags.bossExtraEnemy = true; G.tierFlags.bossSignatureAbility = true; }
  },
  {
    tier: 6, name: 'The Norns Bargain',
    omen: 'Fate has a price. The question is whether you recognize it.',
    revealStage: 'none',
    apply(G) { G.tierFlags.cursedBargainInShop = true; }
  },
  {
    tier: 7, name: 'Surtr Sends Scouts',
    omen: 'Ash on the wind. The fire-realm reaches.',
    revealStage: 'surtr',
    apply(G) { G.tierFlags.muspelheimTagFromWave = 7; G.tierFlags.emberSparkChance = 0.20; }
  },
  {
    tier: 8, name: 'BifrÃ¶st Cracks',
    omen: 'The bridge between worlds fractures. Passage grows costly.',
    revealStage: 'none',
    apply(G) {
      G.tierFlags.startingGoldReduction = 8;
      G.tierFlags.rerollCostIncreaseOverride = 4;
    }
  },
  {
    tier: 9, name: 'Root Harvest',
    omen: 'What falls feeds what grows beneath.',
    revealStage: 'root',
    apply(G) { G.tierFlags.killDropsMark = 1; }
  },
  {
    tier: 10, name: 'Elites Without Season',
    omen: 'The strong ones no longer wait for invitation.',
    revealStage: 'indirect',
    apply(G) {
      G.tierFlags.elitesOnAnyWave    = true;
      G.tierFlags.namedElitesActive  = true;
      G.tierFlags.eliteSecondPhase   = true;
    }
  },
  {
    tier: 11, name: 'Fimbulwinter Arrives',
    omen: 'Three winters without summer. The realms remember what cold means.',
    revealStage: 'fimbulwinter',
    apply(G) {
      G.tierFlags.allWavesNiflheimTag   = true;
      G.tierFlags.heroPermanentSPDPenalty = 5;
      G.tierFlags.regenBoonBonus         = 0.40;
    }
  },
  {
    tier: 12, name: "The Gnawer's Influence Spreads",
    omen: 'Root-corruption reaches the middle trials.',
    revealStage: 'gnawer_indirect',
    apply(G) { G.tierFlags.rootTouchedEnemyChance = 0.30; }
  },
  {
    tier: 13, name: 'Eitr in the Air',
    omen: 'The world-venom rises. Everything breathes it.',
    revealStage: 'eitr',
    apply(G) { G.tierFlags.toxicAirFromWave = 5; G.tierFlags.dotDamageBonus = 0.20; }
  },
  {
    tier: 14, name: 'Twilight Accelerates',
    omen: 'The end, when it comes, will come fast.',
    revealStage: 'none',
    apply(G) { G.tierFlags.enemySPDMult = 1.20; G.tierFlags.heroSPDBonus = 10; }
  },
  {
    tier: 15, name: 'True RagnarÃ¶k',
    omen: 'NÃ­Ã°hÃ¶ggr no longer gnaws. It tears.',
    revealStage: 'nidhoggr',
    apply(G) {
      G.tierFlags.enemyWaveScaleBonus = 2;
      G.tierFlags.allFatherLastGift   = true;
    }
  },
];


// â•â•â• META PERSISTENT STATE â•â•â•
const META_KEY='axiom_meta_v3';
let META={
  legacyEssence:0,
  salvage:0,
  retiredPool:[],
  fallenLedger:[],
  family:{},
  upgrades:{evCap:0,imprintChance:0,poolSize:0,mutationRate:0,nursery:0},
  unlockedTraits:new Set(['serrated','aegis','skirmisher','venomkiss','gambler','spite','ironblood','swift_born','lucky','resilient']),
  nextHeroId:1,
  ragnarÃ¶kTier:0,
  ragnarÃ¶kActive:0,
  eliteRoster:{},
  relics:0,
  hasSeenOpening:false,
  houseName:null,
  codexUnlocked:['yggdrasil','allfather','valhalla','saga','rune','norns'],
};

function saveMeta(){
  const m={...META,unlockedTraits:[...META.unlockedTraits]};
  try{localStorage.setItem(META_KEY,JSON.stringify(m));}catch(e){}
}
function loadMeta(){
  try{
    const raw=localStorage.getItem(META_KEY);
    if(!raw)return;
    const m=JSON.parse(raw);
    META={...META,...m};
    META.unlockedTraits=new Set(m.unlockedTraits||[]);
    if(typeof META.ragnarÃ¶kTier!=='number')META.ragnarÃ¶kTier=0;
    if(typeof META.ragnarÃ¶kActive!=='number')META.ragnarÃ¶kActive=0;
    if(!META.eliteRoster||typeof META.eliteRoster!=='object')META.eliteRoster={};
    if(typeof META.relics!=='number')META.relics=0;
    if(typeof META.hasSeenOpening!=='boolean')META.hasSeenOpening=false;
    if(!META.codexUnlocked||!Array.isArray(META.codexUnlocked))META.codexUnlocked=['yggdrasil','allfather','valhalla','saga','rune','norns'];
  }catch(e){}
}
function exportSave(){
  const m={...META,unlockedTraits:[...META.unlockedTraits]};
  return btoa(JSON.stringify(m));
}
function importSave(str){
  try{const m=JSON.parse(atob(str));META={...META,...m};META.unlockedTraits=new Set(m.unlockedTraits||[]);saveMeta();return true;}
  catch(e){return false;}
}
function poolMax(){return 6+(META.upgrades.poolSize||0)*2;}

// â”€â”€â”€ BREED USES (fertility) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getBreedUses(rec){
  if(!rec) return {left:0,max:0};
  const isRet = META && Array.isArray(META.retiredPool) ? META.retiredPool.includes(rec.id) : false;
  const retiredLike = !!(rec.runResult && (rec.runResult.outcome==='retired' || rec.runResult.outcome==='victory'));
  const fallbackMax = (isRet || retiredLike) ? 1 : 0;
  const mx = (typeof rec.breedUsesMax==='number' && rec.breedUsesMax>0) ? rec.breedUsesMax : fallbackMax;
  const lf = (typeof rec.breedUsesLeft==='number') ? rec.breedUsesLeft : mx;
  return {left:Math.max(0,lf), max:Math.max(0,mx)};
}
function assignBreedUses(rec,max){
  if(!rec) return;
  const m = Math.max(0,Math.min(2,Math.floor(max)));
  rec.breedUsesMax = m;
  rec.breedUsesLeft = m;
}
function calcBreedUsesForRetire(){
  // 1 or 2 uses; later waves slightly increase chance of 2
  const w = (G && typeof G.wave==='number') ? G.wave : 1;
  if(G && G.phase==='VICTORY') return 2;
  let p2 = 0.25 + Math.min(0.25, Math.max(0, (w-4))*0.04); // 25% â†’ up to 50%
  p2 += (META.upgrades.nursery||0)*0.15;
  p2 = Math.min(0.85, Math.max(0.05, p2));
  return (rng() < p2) ? 2 : 1;
}
function removeFromRetiredPoolById(id){
  META.retiredPool = META.retiredPool.filter(x=>x!==id);
  const i = BREED_SELECTED.indexOf(id);
  if(i>=0) BREED_SELECTED.splice(i,1);
}
function removeFromRetiredPool(evt,id){
  if(evt){evt.stopPropagation();evt.preventDefault();}
  removeFromRetiredPoolById(id);
  saveMeta();
  if(typeof setLegacyTab==='function') setLegacyTab('pool');
}
function consumeBreedUse(id){
  const rec = META.family[id];
  if(!rec) return;
  const u = getBreedUses(rec);
  rec.breedUsesMax = u.max;
  rec.breedUsesLeft = Math.max(0, u.left-1);
  if(rec.breedUsesLeft<=0){
    removeFromRetiredPoolById(id);
  }
}

function isFallenHero(id){
  return !!(META && Array.isArray(META.fallenLedger) && META.fallenLedger.includes(id));
}
function canHeroBreed(id){
  const rec = META && META.family ? META.family[id] : null;
  return !!(rec && !isFallenHero(id) && getBreedUses(rec).left>0);
}

// â•â•â• HERO RECORD â•â•â•
function mkHeroId(){return 'H'+(META.nextHeroId++);}
function mkHeroRecord(name,gen,parentIds,evs,traits){
  return {id:mkHeroId(),name,gen,parentIds:parentIds||[],evs:{...evs},traits:[...traits],runResult:null,breedUsesMax:0,breedUsesLeft:0};
}

// â•â•â• NAME GENERATION â•â•â•
const NAME_PREFIXES=['Hrafn', 'Skjold', 'Eirik', 'Sigr', 'Bjorn', 'Ulf', 'Astrid', 'Freya', 'Thora', 'Odin', 'Vidar', 'Helga', 'Runa', 'Frost', 'Skadi', 'Leif', 'Dag', 'Inga', 'Yng', 'Kari', 'Tor', 'Gunn', 'Rolf', 'Hild', 'Aske'];
const NAME_SUFFIXES=['son', 'dottir', 'skald', 'bjorn', 'ulf', 'hild', 'gard', 'heim', 'rune', 'brand', 'vald', 'grim', 'bane', 'born', 'mark', 'ward', 'frost', 'storm', 'spear', 'shield'];
const EPITHETS={Bleed:'the Bloodmarked',Poison:'the Serpent-Touched',Crit:'the Keen-Eyed',Tempo:'the Stormswift',Bulwark:'the Shieldbound',Arcane:'the Seer',Thorns:'the Thorned',Execute:'the Wolf-Sworn',Sustain:'the Iron-Hearted',Axiom:'the Runebound'};
function genName(gen,topTag,parentNames){
  if(gen===0)return rpick(NAME_PREFIXES)+''+rpick(NAME_SUFFIXES);
  const ep=EPITHETS[topTag]||'the Ascendant';
  const base=parentNames&&parentNames[0]?parentNames[0].split(' ')[0]:rpick(NAME_PREFIXES);
  return `${base} ${ep}`;
}

// Imprint chance
function imprintChance(){return Math.min(.75,.15+(META.upgrades.imprintChance||0)*.15);}
// Mutation chance
function mutationRate(){return Math.min(.20,.04+(META.upgrades.mutationRate||0)*.03);}

// â•â•â• GAME STATE â•â•â•
let G=null;

// UI state
const UI_KEY='axiom_ui_v1';
let UI={logCollapsed:false,difficulty:1};
function loadUI(){try{const r=localStorage.getItem(UI_KEY);if(r)UI={...UI,...JSON.parse(r)};}catch(e){}}
function saveUI(){try{localStorage.setItem(UI_KEY,JSON.stringify(UI));}catch(e){}}

function clampNum(v,min,max){
  const n=Number(v);
  if(Number.isNaN(n))return min;
  return Math.max(min,Math.min(max,n));
}
function currentDifficulty(){
  if(G && typeof G.difficulty==='number')return G.difficulty;
  return (typeof UI.difficulty==='number')?UI.difficulty:1;
}
function setDifficulty(v){
  UI.difficulty=clampNum(v,0,2);
  saveUI();
  updateDifficultyUI();
}
function onDifficultyInput(v,src){
  // src is optional ('start' when called from start overlay)
  setDifficulty(v);
  const sv=document.getElementById('start-diff-val');
  if(sv)sv.textContent='x'+Number(UI.difficulty??1).toFixed(1);
}
function updateDifficultyUI(){
  const d=currentDifficulty();
  const s=document.getElementById('diff-slider');
  const v=document.getElementById('diff-val');
  if(v)v.textContent='x'+Number(d).toFixed(1);
  if(s){
    s.value=Number(d);
    // lock during an active run (keeps difficulty consistent)
    s.disabled=!!G;
    s.style.opacity=s.disabled?0.7:1;
  }
  const sd=document.getElementById('start-diff');
  if(sd){
    sd.value=Number(UI.difficulty??1);
    const sv=document.getElementById('start-diff-val');
    if(sv)sv.textContent='x'+Number(UI.difficulty??1).toFixed(1);
  }
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TACTICS (pre-wave prep; cost paid when you start the trial)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TACTICS=[
  {id:'t_focus_threat',  name:'Mark: Strongest',   icon:'ðŸŽ¯', cost:12, kind:'target', mode:'threat', desc:'Hero targets the highest ATK enemy first.'},
  {id:'t_focus_wounded', name:'Mark: Broken',  icon:'ðŸ©¸', cost:10, kind:'target', mode:'wounded', desc:'Hero targets the lowest HP% enemy first.'},
  {id:'t_fortify',       name:'Fortify',         icon:'ðŸ›¡', cost:11, kind:'start',  desc:'+30 Shield and Regen for 8s at battle start.'},
  {id:'t_ambush',        name:'Ambush',          icon:'ðŸ—¡', cost:14, kind:'start',  desc:'Your first attack deals double damage.'},
  {id:'t_sabotage',      name:'Weaken',        icon:'ðŸ§¨', cost:12, kind:'start',  desc:'Enemies start with -15% Defense.'},
  {id:'t_flare',         name:'Expose',           icon:'ðŸ”¥', cost:12, kind:'start',  desc:'Enemies start Vulnerable for 3s.'},
  {id:'t_greed',         name:'Greed',           icon:'ðŸª™', cost:8,  kind:'econ',   desc:'+30% Saga-Marks for this trial.'},
];
const TACTIC_BY_ID=Object.fromEntries(TACTICS.map(t=>[t.id,t]));

const BOSS_SIGNATURES={
  bruiser:{
    name:'Serpent Surge',
    desc:'Every 4th attack deals true damage equal to 15% of hero max HP.',
    apply(enemy,h){
      enemy._sigCtr=(enemy._sigCtr||0)+1;
      if(enemy._sigCtr%4===0){
        const trueDmg=Math.floor(h.maxHP*0.15);
        heroDmg(trueDmg,enemy,'true');
        addLog(`  â­ ${enemy.displayName||enemy.name} â€” Serpent Surge! ${trueDmg} true damage!`,'lcrit');
      }
    }
  },
  tank:{
    name:'Unyielding Skjald',
    desc:'Below 50% HP, gains 15 Shield per attack received.',
    apply(enemy){
      if(enemy.hp<enemy.maxHP*0.5){
        addShieldToUnit(enemy,15);
      }
    }
  },
  bombardier:{
    name:'Rune Surge',
    desc:'Every 3rd attack also applies Vulnerable to the hero (3s).',
    apply(enemy,h){
      enemy._sigCtr=(enemy._sigCtr||0)+1;
      if(enemy._sigCtr%3===0){
        applyStatus(h,'vulnerable',1,3);
        addLog(`  â­ ${enemy.displayName||enemy.name} â€” Rune Surge! Vulnerable.`,'lstatus');
      }
    }
  },
  _default:{
    name:'Root-Power',
    desc:'Gains +3 ATK per enemy slain this trial.',
    apply(){/* handled via wave flags */}
  },
};

const CURSED_BARGAINS=[
  {
    id:'cb_blood_price',name:'Blood Price',icon:'ðŸ©¸',
    desc:'+30 ATK for this saga. Hero takes +8% damage permanently.',
    cost:25,
    apply(G){
      G.hero.atk+=30;
      G.hero.cursedMult=(G.hero.cursedMult||1.0)*1.08;
      addLog('âš  Blood Price accepted. Power costs something.','laxiom');
    }
  },
  {
    id:'cb_glass_soul',name:'Glass Heart',icon:'ðŸ’Ž',
    desc:'+25% Crit Chance. Evasion set to 0 permanently.',
    cost:30,
    apply(G){
      G.hero.critChance=Math.min(0.9,G.hero.critChance+0.25);
      G.hero.evasion=0;
      addLog('âš  Glass Heart accepted. Fortune without flinching.','laxiom');
    }
  },
  {
    id:'cb_norn_debt',name:"Norn's Debt",icon:'ðŸŒ€',
    desc:'Gain 50 Saga-Marks now. End-of-trial Saga-Marks reduced by 20%.',
    cost:0,isFree:true,
    apply(G){
      G.gold+=50;
      G.waveGoldMult=(G.waveGoldMult||1.0)*0.80;
      G.hero._nornDebt=true;
      addLog("âš  Norn's Debt accepted. The weavers remember.",'laxiom');
    }
  },
  {
    id:'cb_iron_hunger',name:'Iron Hunger',icon:'âš™',
    desc:'+20 DEF. Lifesteal reduced to 0.',
    cost:20,
    apply(G){
      G.hero.def+=20;
      G.hero.lifesteal=0;
      addLog('âš  Iron Hunger accepted. Defense before all else.','laxiom');
    }
  },
];

function takeCursedBargain(id){
  const bargain=CURSED_BARGAINS.find(b=>b.id===id);
  if(!bargain)return;
  if(!bargain.isFree&&G.gold<bargain.cost)return;
  if(!bargain.isFree)G.gold-=bargain.cost;
  bargain.apply(G);
  G.cursedBargainUsedThisWave=true;
  G._waveBargainOffer=null;
  renderAll();
}

function genTacticOffers(){
  // 3 random options each wave (keeps the loop fresh without hiding the core shop)
  const pool=[...TACTICS];
  G.tacticOffers=rshuffle(pool).slice(0,3);
}
function selectPendingTactic(id){
  const t=TACTIC_BY_ID[id];
  if(!t) return;
  G.pendingTactic=id;
  G.pendingTacticPaid=false;
  addLog(`ðŸ§  Planned tactic: ${t.icon} ${t.name} (cost á›‹${t.cost} on start)`,'lstatus');
  renderAll();
}
function clearPendingTactic(){
  G.pendingTactic=null;G.pendingTacticPaid=false;
  renderAll();
}
function commitPendingTactic(){
  // called when starting a wave (charges gold once)
  G.activeTactic=null;
  G.waveGoldMult=1;
  if(!G.pendingTactic) return true;
  const t=TACTIC_BY_ID[G.pendingTactic];
  if(!t){G.pendingTactic=null;G.pendingTacticPaid=false;return true;}
  if(!G.pendingTacticPaid){
    if(G.gold < t.cost){
      addLog(`á›‹${t.cost} required to use tactic: ${t.icon} ${t.name}`,'lstatus');
      return false;
    }
    G.gold -= t.cost;
    G.pendingTacticPaid=true;
    addLog(`ðŸ§  Tactic engaged: ${t.icon} ${t.name} (á›‹${t.cost})`,'laxiom');
  }
  G.activeTactic=G.pendingTactic;
  G.pendingTactic=null;
  G.pendingTacticPaid=false;
  return true;
}
function applyBattleStartTactics(){
  const t=TACTIC_BY_ID[G.activeTactic];
  if(!t) return;
  const h=G.hero;
  if(t.id==='t_fortify'){
    addShieldToUnit(h,30);
    h.statuses.regen={stacks:1,value:6,dur:8};
    addLog(`  ðŸ›¡ Fortify: +30 Shield, Regen (8s)`,'lstatus');
  } else if(t.id==='t_ambush'){
    h.flags.tacticAmbush=true;
    addLog(`  ðŸ—¡ Ambush: first strike empowered`,'lstatus');
  } else if(t.id==='t_sabotage'){
    G.enemies.filter(e=>!e.dead).forEach(e=>{e.def=Math.max(0,Math.floor(e.def*0.85));});
    addLog(`  ðŸ§¨ Weaken: enemies DEF reduced`,'lstatus');
  } else if(t.id==='t_flare'){
    G.enemies.filter(e=>!e.dead).forEach(e=>applyStatus(e,'vulnerable',1,3));
    addLog(`  ðŸ”¥ Expose: enemies Vulnerable (3s)`,'lstatus');
  } else if(t.id==='t_greed'){
    G.waveGoldMult=1.30;
    addLog(`  ðŸª™ Greed: +30% Saga-Marks this trial`,'lstatus');
  }
}
function tacticTargetMode(){
  const t=TACTIC_BY_ID[G.activeTactic];
  return (t && t.kind==='target') ? t.mode : null;
}


function newHero(evs,traits,record){
  const derived=evDerived(evs);
  const h={
    ...derived,
    hp:derived.maxHP,
    statuses:{},actionMeter:0,atkCount:0,
    tempStats:{},permStats:{},flags:{},
    usedUndying:false,
    evs:{...evs},
    traits:[...traits],
    record:record||null,
    gear:{weapon:null,armor:null,talisman:null},
  };
  if(record&&record.inheritedGear)Object.assign(h.gear,record.inheritedGear);
  applyGeneticTraitStats(h);
  applyAllGearMaxHP(h);
  return h;
}
function applyGeneticTraitStats(h){
  for(const tk of (h.traits||[])){
    if(tk==='ironblood')h.def+=5;
    if(tk==='swift_born')h.spd+=8;
    if(tk==='lucky')h.critChance=Math.min(.9,h.critChance+.04);
    if(tk==='resilient'){h.maxHP+=25;h.hp=h.maxHP;}
    if(tk==='gambler'){h.critChance=Math.min(.9,h.critChance+.05);h.def=Math.max(0,h.def-2);}
    if(tk==='vampiric_b')h.lifesteal=Math.min(.4,h.lifesteal+.03);
  }
}

function initGame(seedVal,evs,traits,parentRecord){
  seedRng(seedVal||Date.now());
  const rec=parentRecord||mkHeroRecord(genName(0,null,null),0,[],evs||emptyEVs(),traits||[]);
  G={
    phase:'WAVE_PREVIEW',
    difficulty:(typeof UI.difficulty==='number'?UI.difficulty:1),
    hero:newHero(evs||emptyEVs(),traits||[],rec),
    wave:1,maxWaves:12,
    gold:30,xp:0,xpNeeded:80,level:1,
    boons:[],draft:[],rerollCost:10,
    enemies:[],waveTraits:[],waveFlags:{},waveGold:0,
    bossWaves:[6,12],
    speed:1,tick:0,interval:null,statusTick:0,
    seed:seedVal,
    retireAvailable:false,
    retireWaves:[3,5,8,10,12],
    runBoons:[],
    pendingTactic:null,pendingTacticPaid:false,activeTactic:null,tacticOffers:[],waveGoldMult:1,
    ragnarÃ¶kActive:META.ragnarÃ¶kActive||0,
    tierFlags:{},
    forgeStallItem:null,
  };
  updateMetaHeader();
  genWave();
  applyRagnarÃ¶kTiers(G);
  renderAll();
  updateDifficultyUI();
}

// Stub â€” fully implemented in Prompt 6
function applyRagnarÃ¶kTiers(G) {
  G.tierFlags = {};
  const activeTier = G.ragnarÃ¶kActive || 0;
  for (let i = 0; i < activeTier && i < RAGNARÃ–K_TIERS.length; i++) {
    const tierDef = RAGNARÃ–K_TIERS[i];
    if (tierDef && typeof tierDef.apply === 'function') {
      tierDef.apply(G);
    }
  }

  if (G.tierFlags.startingGoldReduction) {
    G.gold = Math.max(0, G.gold - G.tierFlags.startingGoldReduction);
  }

  if (G.tierFlags.heroPermanentSPDPenalty && G.hero) {
    G.hero.spd = Math.max(5, G.hero.spd - G.tierFlags.heroPermanentSPDPenalty);
  }

  if (G.tierFlags.heroSPDBonus && G.hero) {
    G.hero.spd += G.tierFlags.heroSPDBonus;
  }
}

function checkRagnarÃ¶kUnlock() {
  if (!G) return;
  const currentActive = G.ragnarÃ¶kActive || 0;
  const currentUnlocked = META.ragnarÃ¶kTier || 0;
  if (currentActive < currentUnlocked) return;

  const completedWave = G.wave;
  const isVictory = G.phase === 'VICTORY';
  const isRetireDeep = (completedWave >= 8);

  if (!isVictory && !isRetireDeep) return;

  const newTier = Math.min(15, currentUnlocked + 1);
  if (newTier <= currentUnlocked) return;

  META.ragnarÃ¶kTier = newTier;
  if (G.hero && G.hero.record) {
    G.hero.record.ragnarÃ¶kStamp = newTier;
  }
  saveMeta();
  addLog(`áš¢ The root darkens further. RagnarÃ¶k Tier ${newTier} â€” ${rootDepthLabel(newTier)} â€” unlocked.`, 'laxiom');
}


function startFirstHero(seedVal){
  const rec=mkHeroRecord(genName(0,null,null),0,[],emptyEVs(),[]);
  META.family[rec.id]=rec;
  saveMeta();
  initGame(seedVal||null,emptyEVs(),[],rec);
}

// â•â•â• WAVE GENERATION â•â•â•
function genWave(){
  G.enemies=buildEnemies(G.wave);
  G.waveTraits=pickWaveTraits(G.wave);
  G.waveFlags={};G.waveGold=0;
  G.waveGoldMult=1;
  G.activeTactic=null;
  G.cursedBargainUsedThisWave=false;
  G._waveBargainOffer=null;
  G.pendingTactic=null;
  G.pendingTacticPaid=false;
  genTacticOffers();
  G.retireAvailable=G.retireWaves.includes(G.wave);
  G.phase='WAVE_PREVIEW';
}
function buildEnemies(wave){
  const isBoss=G.bossWaves.includes(wave);
  const forceEliteAnyWave=G.tierFlags&&G.tierFlags.elitesOnAnyWave&&!isBoss&&rng()<0.25;
  let count=Math.min(1+Math.floor(wave/3),isBoss?5:4);
  if(isBoss&&G.tierFlags&&G.tierFlags.bossExtraEnemy)count=Math.min(count+1,6);
  const out=[];
  if(isBoss){
    const bossArch=rpick(ARCHETYPES.filter(a=>['bruiser','tank','bombardier'].includes(a.id)));
    const boss=mkEnemy(bossArch,wave,true);
    if(G.tierFlags&&G.tierFlags.bossSignatureAbility){
      boss.signature=BOSS_SIGNATURES[bossArch.id]||BOSS_SIGNATURES._default;
    }
    out.push(boss);
  }
  while(out.length<count)out.push(mkEnemy(rpick(ARCHETYPES),wave,forceEliteAnyWave&&out.length===0));
  const exp=[];
  for(const e of out){
    exp.push(e);
    if(e.archId==='swarm'){
      for(let i=1;i<3;i++){
        const c={...JSON.parse(JSON.stringify(e)),id:e.id+'_'+i,actionMeter:rng()*.5,_isEcho:false};
        exp.push(c);
      }
    }
  }
  exp.forEach(e=>{
    if(e.elite&&!e.namedElite){
      const namedEntry=checkForNamedEliteReturn(e.archId);
      if(namedEntry){
        e.namedElite=true;
        e.displayName=namedEntry.name;
        e.name=namedEntry.name;
      }
    }
  });
  return exp.slice(0,8);
}
function mkEnemy(arch,wave,boss){
  const waveScaleBonus = (G && G.tierFlags && G.tierFlags.enemyWaveScaleBonus) || 0;
  const effectiveWave = Math.min(wave + waveScaleBonus, 20);
  const w = effectiveWave - 1;
  const b = arch.base, s = arch.scl;

  const mult = (G && typeof G.difficulty === 'number') ? G.difficulty : 1;

  const activeTier = (G && G.ragnarÃ¶kActive) || 0;
  const ragnarÃ¶kHPMult = activeTier >= 1 ? 1.10 : 1.0;

  const spdMult = (G && G.tierFlags && G.tierFlags.enemySPDMult) || 1.0;

  const baseHP = b.hp + s.hp * w;
  const hp = Math.max(1, Math.floor(baseHP * mult * ragnarÃ¶kHPMult));
  const atk = Math.max(1, Math.floor((b.atk + s.atk * w) * mult));
  const def = Math.max(0, Math.floor((b.def + s.def * w) * mult));
  const baseSpdMult = 0.6 + 0.4 * mult;
  const spd = Math.max(5, Math.floor((b.spd + s.spd * w) * baseSpdMult * spdMult));

  const rootTouchedChance=(G&&G.tierFlags&&G.tierFlags.rootTouchedEnemyChance)||0;
  const isRootTouchedWave=wave>=4&&wave<=8;
  const rootTouched=!!(isRootTouchedWave&&!boss&&rng()<rootTouchedChance);

  const enemy={id:arch.id+'_'+ri(1000,9999),archId:arch.id,
    // Layer 1: plain English name used in all combat references
    displayName:arch.displayName||arch.name||arch.id,
    // Layer 2: Norse name shown in trait line only
    norseName:arch.norseName||null,
    // Keep name for backward-compat with log references
    name:arch.displayName||arch.name||arch.id,
    realmTier:arch.realmTier||'midgard',
    icon:arch.icon,col:arch.col,
    hp,maxHP:hp,atk,def,spd,
    cc:arch.id==='striker'?Math.min(.7,b.cc+.25+.003*w):b.cc,cd:b.cd,
    lifesteal:arch.ls||0,trait:arch.trait,td:arch.td,beh:arch.beh,
    statuses:{},actionMeter:rng()*.5,
    _firstAtkDone:false,_hexCtr:0,_chargeCtr:0,_tankGuard:true,
    _tier2Done:false,
    elite:boss||false,dead:false,
    rootTouched,
    namedElite:false,
    signature:null};

  if(rootTouched){
    enemy.displayName='Root-Touched '+(arch.displayName||arch.name||arch.id);
    enemy.name=enemy.displayName;
    enemy.col='#2a1a3a';
    enemy.hp=enemy.maxHP=Math.floor(enemy.hp*1.10);
    enemy.atk=Math.floor(enemy.atk*1.10);
  }

  return enemy;
}

function addShieldToUnit(unit,amt){
  if(!unit.statuses.shield)unit.statuses.shield={stacks:1,value:0,dur:9999};
  unit.statuses.shield.value+=amt;
}
function pickWaveTraits(wave) {
  const minTraits = (G && G.tierFlags && G.tierFlags.minWaveTraits) || 0;
  if (wave <= 2 && minTraits === 0) return [];
  const n = (wave <= 4) ? Math.max(minTraits, 1) : (rng() < .45 ? 2 : 1);
  return rshuffle([...WAVE_TRAITS]).slice(0, n);
}

function applyWaveTraitsToEnemies(){
  G.waveFlags={};
  G.waveTraits.forEach(t=>t.apply(G.enemies,G.hero,G));

  if(G.tierFlags&&G.tierFlags.allWavesNiflheimTag){
    if(!G.waveFlags._fimbulwinterApplied){
      G.waveFlags._fimbulwinterApplied=true;
      applyStatus(G.hero,'slow',1,3);
      addLog('  â„ï¸ Fimbulwinter: a biting cold slows you.','lstatus');
    }
  }
}

// â•â•â• PASSIVE HELPERS â•â•â•
function passive(k){for(const b of G.boons)for(const e of b.effects)if(e.t==='passive'&&e.k===k)return e.v??true;return null;}
function hasP(k){return passive(k)!==null;}
function hasTrait(tk){return G.hero.traits&&G.hero.traits.includes(tk);}

function effectiveStats(){
  const h=G.hero;
  const s={atk:h.atk+(h.permStats.atk||0),def:h.def,spd:h.spd,critChance:h.critChance,critDmg:h.critDmg,lifesteal:h.lifesteal,evasion:h.evasion,accuracy:h.accuracy};
  const il=passive('axiomIronLaw');if(il)s.atk+=Math.floor(s.def*il);
  if(hasP('axiomKinetic'))s.critChance+=h.spd*.002;

  h.cursedMult=1;
  if(h.gear){
    Object.values(h.gear).forEach(item=>{
      if(!item)return;
      const affixes=getGearEffectiveAffixes(item);
      affixes.forEach(affix=>{
        const v=affix.effectiveValue;
        if(typeof v!=='number')return;
        if(affix.stat==='atk')s.atk+=v;
        if(affix.stat==='def')s.def+=v;
        if(affix.stat==='spd')s.spd+=v;
        if(affix.stat==='critChance')s.critChance=Math.min(0.9,s.critChance+v);
        if(affix.stat==='critDmg')s.critDmg+=v;
        if(affix.stat==='evasion')s.evasion=Math.min(0.6,s.evasion+v);
        if(affix.stat==='lifesteal')s.lifesteal=Math.min(0.4,s.lifesteal+v);
        if(affix.stat==='accuracySet')s.accuracy=v;
        if(affix.stat==='defPen')s._gearDefPen=(s._gearDefPen||0)+v;
        if(affix.stat==='maxHP')s._gearMaxHP=(s._gearMaxHP||0)+v;
        if(affix.stat==='executionBonus')s._gearExecutionBonus=(s._gearExecutionBonus||0)+v;
        if(affix.stat==='regenPct')s._gearRegenPct=(s._gearRegenPct||0)+v;
        if(affix.stat==='dotResist')s._gearDotResist=(s._gearDotResist||0)+v;
        if(affix.stat==='cursedDamageMult')h.cursedMult=Math.max(h.cursedMult||1,1+v);
      });
      if(item.passiveBonus){
        const pb=item.passiveBonus;
        if(pb.stat==='atk'&&typeof pb.value==='number')s.atk+=pb.value;
        if(pb.stat==='def'&&typeof pb.value==='number')s.def+=pb.value;
      }
    });
    s.critChance=Math.min(0.9,Math.max(0,s.critChance));
    s.evasion=Math.min(0.6,Math.max(0,s.evasion));
    s.lifesteal=Math.min(0.4,Math.max(0,s.lifesteal));
  }
  return s;
}

function heroAtk(){
  const h=G.hero,es=effectiveStats();
  let a=es.atk+(h.tempStats.atk||0);
  const rage=h.statuses.rage;if(rage)a+=rage.stacks*4;
  if(h.statuses.weak)a=Math.floor(a*.75);
  const pred=passive('predator');if(pred&&h.hp<h.maxHP*.50)a=Math.floor(a*(1+pred));
  if(hasTrait('predatory')&&h.hp<h.maxHP*.50)a+=3;
  const bers=passive('berserk');if(bers&&h.hp<h.maxHP*bers.thr)a=Math.floor(a*(1+bers.atk));
  return Math.max(1,Math.floor(a));
}
function heroSpd(){
  const h=G.hero;
  let s=h.spd+(h.tempStats.spd||0);
  const tempo=h.statuses.tempo;if(tempo)s+=tempo.stacks*3;
  const bers=passive('berserk');if(bers&&h.hp<h.maxHP*bers.thr)s=Math.floor(s*(1+bers.spd));
  if(hasTrait('skirmisher')&&h.hp<h.maxHP*.50)s+=8;
  if(h.statuses.slow)s=Math.floor(s*.70);
  return Math.max(5,s);
}
function eSpd(e){
  let s=e.spd;
  if(e.archId==='bruiser')return Math.max(5,s);
  if(e.statuses.slow)s=Math.floor(s*.70);
  return Math.max(5,s);
}

// â•â•â• STATUS APPLICATION â•â•â•
function applyStatus(unit,key,stacks,dur,maxStacks){
  if(key==='slow'&&unit.archId==='bruiser')return;
  // Ward Protocol (first debuff each battle is negated)
  if(unit===G.hero && unit.flags && unit.flags.debuffWard){
    const neg = (key==='bleed'||key==='poison'||key==='weak'||key==='vulnerable'||key==='slow'||key==='stun');
    if(neg){
      unit.flags.debuffWard=false;
      addLog(`  ðŸ§¿ Ward negates ${STATUS[key]?.name||key}!`,'laxiom');
      return;
    }
  }
  const plagMult=passive('axiomPlague')||1.0;
  if(dur!==9999)dur=Math.floor(dur*plagMult);
  if(!unit.statuses[key])unit.statuses[key]={stacks:0,value:0,dur:0};
  const mx=maxStacks||99;
  unit.statuses[key].stacks=Math.min(mx,unit.statuses[key].stacks+stacks);
  unit.statuses[key].dur=Math.max(unit.statuses[key].dur,dur);

  if(key==='bleed'){
    if(hasP('bleedWeak')||hasP('axiomCrimson'))applyStatus(unit,'weak',1,dur);
    if(hasP('bleedSlow'))applyStatus(unit,'slow',1,dur);
  }
  if(key==='poison'&&unit!==G.hero){
    if(hasP('poisonSlow'))applyStatus(unit,'slow',1,dur);
    if(hasP('plagueLord')){
      G.enemies.filter(e=>!e.dead&&e!==unit).forEach(e=>{
        if(!e.statuses.poison)e.statuses.poison={stacks:0,value:0,dur:0};
        e.statuses.poison.stacks=Math.min(10,e.statuses.poison.stacks+1);
        e.statuses.poison.dur=Math.max(e.statuses.poison.dur,3);
      });
    }
  }
}

// â•â•â• DAMAGE / HEAL â•â•â•
function dealToEnemy(enemy,dmg){
  if(enemy.dead||dmg<=0)return 0;
  if(enemy.archId==='tank'&&enemy._tankGuard){enemy._tankGuard=false;addLog(`  ðŸ›¡ ${enemy.displayName||enemy.name} Iron Will negates!`,'lstatus');return 0;}

  const sh=enemy.statuses.shield;
  if(sh&&sh.value>0){
    const abs=Math.min(sh.value,dmg);sh.value-=abs;dmg-=abs;
    if(sh.value<=0)delete enemy.statuses.shield;
    if(dmg<=0)return abs;
  }

  const prev=enemy.hp;
  enemy.hp=Math.max(0,enemy.hp-dmg);
  if(enemy.hp<=0&&!enemy.dead){enemy.dead=true;onKill(enemy);}
  return Math.min(dmg,prev);
}

function heroDmg(rawDmg,attacker,src){
  const hero=G.hero;
  if(rawDmg<=0)return 0;

  if(hero.cursedMult&&hero.cursedMult>1.0){
    rawDmg=Math.floor(rawDmg*hero.cursedMult);
  }

  if(hasTrait('tenacious')&&hero.hp<hero.maxHP*.25)rawDmg=Math.floor(rawDmg*.60);

  if(src!=='mirror'&&src!=='thorns'&&src!=='dot'&&attacker&&attacker!==hero){
    const m=passive('axiomMirror');if(m){const md=Math.floor(rawDmg*m);dealToEnemy(attacker,md);addLog(`  ðŸªž Mirror: ${md} reflected!`,'laxiom');}
    const th=passive('thorns');if(th){const td=Math.floor(rawDmg*th);dealToEnemy(attacker,td);}
    if(hasTrait('spite')&&rawDmg>0){const sp=Math.floor(rawDmg*.08);if(sp>0)dealToEnemy(attacker,sp);}
  }

  const sh=hero.statuses.shield;
  if(sh&&sh.value>0){
    if(hasP('axiomFortress')){
      addLog(`  ðŸ¯ Stone Resolve: hit negated!`,'laxiom');
      sh.value-=1;
      if(sh.value<=0){delete hero.statuses.shield;shieldBreak(attacker);}
      return 0;
    }else{
      const abs=Math.min(sh.value,rawDmg);sh.value-=abs;rawDmg-=abs;
      if(sh.value<=0){delete hero.statuses.shield;shieldBreak(attacker);}
      if(rawDmg<=0)return abs;
    }
  }

  const prev=hero.hp;
  hero.hp=Math.max(0,hero.hp-rawDmg);

  // Near-death narration (must check AFTER hp update, BEFORE undying)
  if(hero.hp>0&&hero.hp<hero.maxHP*0.25){
    NarrationEngine.onNearDeath();
  }
  if(hero.hp<=0&&!hero.usedUndying&&hasP('undying')){
    hero.usedUndying=true;hero.hp=Math.floor(hero.maxHP*.35);
    addLog(`  ðŸ”„ UNDYING! Hero rises with ${hero.hp} HP!`,'laxiom');
  }
  const sw=passive('secondWind');
  if(sw && !hero.flags.secondWindUsed && hero.hp>0 && hero.hp<hero.maxHP*0.30){
    hero.flags.secondWindUsed=true;
    const heal=Math.floor(hero.maxHP*sw);
    addLog(`  ðŸŒ¬ï¸ Second Wind! +${heal}`,'laxiom');
    healHero(heal,'sw');
  }
  trigBoon('onDmg',hero,attacker);
  return Math.min(rawDmg,prev);
}

function shieldBreak(attacker){
  addLog(`  ðŸ’” Shield broken!`,'lshield');
  const bash=passive('shieldBash');
  if(bash&&attacker&&!attacker.dead){dealToEnemy(attacker,bash);addLog(`  ðŸ’¥ Shield Bash! ${attacker.displayName||attacker.name} takes ${bash}!`,'lhit');}
}

function healHero(amt,src){
  const h=G.hero;
  const over=Math.max(0,(h.hp+amt)-h.maxHP);
  h.hp=Math.min(h.maxHP,h.hp+amt);
  if(over>0&&hasP('overhealShield')){addShieldToUnit(h,over);addLog(`  ðŸ’Ž Overheal â†’ ${over} Shield!`,'laxiom');}
  if(amt>0&&src!=='ls'&&src!=='regen')addLog(`  ðŸ’š Healed ${amt} HP`,'lheal');
}

// â•â•â• BOON EVENT SYSTEM â•â•â•
function trigBoon(evType,hero,target){
  for(const b of G.boons)for(const ef of b.effects){
    if(ef.t!==evType)continue;
    if(ef.ef==='status')applyStatus(hero,ef.st,ef.sk,ef.dur,ef.mx);
    else if(ef.ef==='statusEnemy'){if(target&&target!==hero&&!target.dead)applyStatus(target,ef.st,ef.sk,ef.dur);}
    else if(ef.ef==='shield')addShieldToUnit(hero,ef.amt);
    else if(ef.ef==='tempStat')hero.tempStats[ef.s]=(hero.tempStats[ef.s]||0)+ef.v;
    else if(ef.ef==='permStat'){hero.permStats[ef.s]=(hero.permStats[ef.s]||0)+ef.v;addLog(`  â­ ${b.name}: perm +${ef.v} ATK!`,'laxiom');}
    else if(ef.ef==='healPct')healHero(Math.floor(hero.maxHP*ef.v),'kill');
    else if(ef.ef==='flag')hero.flags[ef.f]=(hero.flags[ef.f]||0)+ef.v;
    else if(ef.ef==='splash'){
      const others=G.enemies.filter(e=>!e.dead&&e!==target);
      if(others.length){
        const t2=rpick(others);
        const sd=Math.floor(heroAtk()*ef.v);
        dealToEnemy(t2,sd);
        addLog(`  âš¡ Chain Lightning â†’ ${t2.name} for ${sd}!`,'laxiom');
      }
    }
  }
}

function applyBoonEffectsOnPick(boon){
  for(const ef of boon.effects){
    if(ef.t==='stat'){
      if(ef.s==='hp')G.hero.hp=Math.min(G.hero.maxHP+ef.v,G.hero.hp+ef.v);
      G.hero[ef.s]=(G.hero[ef.s]||0)+ef.v;
    }
  }
}
function applyBattleStartBoons(){
  for(const b of G.boons)for(const ef of b.effects){
    if(ef.t==='onBattleStart'&&ef.ef==='shield')addShieldToUnit(G.hero,ef.amt);
  }
  if(hasTrait('aegis'))addShieldToUnit(G.hero,8);
  if(G.hero.gear){
    Object.values(G.hero.gear).forEach(item=>{
      if(!item)return;
      getGearEffectiveAffixes(item).forEach(affix=>{
        if(affix.stat==='shieldOnBattleStart'&&typeof affix.effectiveValue==='number')addShieldToUnit(G.hero,Math.floor(affix.effectiveValue));
      });
    });
  }
}


function pickHeroTarget(alive){
  if(!alive || !alive.length) return null;
  const tmode=tacticTargetMode();
  if(tmode==='threat'){
    // Highest ATK first (ties: lower HP)
    return alive.reduce((m,e)=> (e.atk>m.atk || (e.atk===m.atk && e.hp<m.hp)) ? e : m, alive[0]);
  }
  if(tmode==='wounded' || hasP('targetLowest')){
    return alive.reduce((m,e)=>((e.hp/e.maxHP) < (m.hp/m.maxHP))?e:m, alive[0]);
  }
  return alive[0];
}
function applyEnemyStartTraits(){
  // Warden banner: grant allies Shield at battle start (scales lightly with wave)
  const wardens = G.enemies.filter(e=>!e.dead && e.archId==='warden');
  if(wardens.length){
    const amt = 10 + Math.floor((G.wave-1)*1.2);
    G.enemies.filter(e=>!e.dead).forEach(e=>addShieldToUnit(e, amt));
    addLog(`  ðŸ§¿ Banner: enemies gain ${amt} Shield!`,'lstatus');
  }
}

// â•â•â• COMBAT LOOP â•â•â•
function startBattle(){
  const h=G.hero;
  if(!commitPendingTactic()){renderAll();return;}
  h.statuses={};h.actionMeter=0;h.atkCount=0;h.tempStats={};h.flags={};h.usedUndying=false;
  if(hasP('axiomOpen'))h.flags.openStrike=true;
  if(hasP('wardDebuff'))h.flags.debuffWard=true;
  h.flags.secondWindUsed=false;
  applyWaveTraitsToEnemies();
  applyBattleStartBoons();

  if(G.tierFlags&&G.tierFlags.allFatherLastGift&&G.wave===1&&!G._allFatherGiftOffered){
    G._allFatherGiftOffered=true;
    if(G.interval)clearInterval(G.interval);
    G.phase='ALLFATHER_GIFT';
    renderAll();
    showAllFatherGift();
    return;
  }

  applyEnemyStartTraits();
  applyBattleStartTactics();
  if(G.waveFlags.heroStartVuln){applyStatus(G.hero,'vulnerable',1,G.waveFlags.heroStartVuln);addLog(`  ðŸŽ¯ Marked Prey: Vulnerable (${G.waveFlags.heroStartVuln}s)`,'lstatus');}
  G.phase='BATTLE';G.tick=0;G.statusTick=0;G._critLandedThisWave=false;G._narratedNearDeath=false;
  addLog(`âš” Trial ${G.wave} â€” ${G.enemies.length} enemies!`,'lwave');

  // Narration: wave start line
  NarrationEngine.reset();
  const waveStartLine=MYTH_LINES.waveStart[G.wave];
  if(waveStartLine) NarrationEngine.fire('waveStart',waveStartLine,'lstatus');

  G.enemies.forEach(e=>addLog(`  ${e.icon} ${e.displayName||e.name} HP:${e.hp} ATK:${e.atk} DEF:${e.def}`,'lstatus'));
  renderAll();
  if(G.interval)clearInterval(G.interval);
  G.interval=setInterval(combatTick,100/G.speed);
}

function combatTick(){
  if(G.phase!=='BATTLE'){clearInterval(G.interval);return;}
  G.tick++;G.statusTick++;
  if(G.statusTick>=10){
    G.statusTick=0;
    tickStatuses(G.hero,true);
    G.enemies.filter(e=>!e.dead).forEach(e=>tickStatuses(e,false));
    const toxicAirActive=G.waveFlags.toxicAir||(G.tierFlags&&G.tierFlags.toxicAirFromWave&&G.wave>=G.tierFlags.toxicAirFromWave);
    if(toxicAirActive){
      G.enemies.filter(e=>!e.dead).forEach(e=>{e.hp=Math.max(0,e.hp-1);if(e.hp<=0&&!e.dead){e.dead=true;onKill(e);}});
      heroDmg(1,null,'dot');
    }
    if(G.waveFlags.eRegen){
      G.enemies.filter(e=>!e.dead).forEach(e=>{e.hp=Math.min(e.maxHP,e.hp+Math.floor(e.maxHP*G.waveFlags.eRegen));});
    }
    const ren=passive('regen');
    if(ren){
      const regenBonus=(G.tierFlags&&G.tierFlags.regenBoonBonus)||0;
      healHero(Math.floor(G.hero.maxHP*ren*(1+regenBonus)),'regen');
    }
    if(G.hero.gear){
      Object.values(G.hero.gear).forEach(item=>{
        if(!item)return;
        getGearEffectiveAffixes(item).forEach(affix=>{
          if(affix.stat==='regenPct'&&typeof affix.value==='number'){
            const regenBonus=(G.tierFlags&&G.tierFlags.regenBoonBonus)||0;
            const healAmt=Math.floor(G.hero.maxHP*affix.effectiveValue*(1+regenBonus));
            if(healAmt>0)healHero(healAmt,'gear-regen');
          }
        });
      });
    }
  }
  if(checkEnd())return;

  if(!G.hero.statuses.stun){
    G.hero.actionMeter+=heroSpd()/500;
    if(G.hero.actionMeter>=1){G.hero.actionMeter=0;doHeroAtk();}
  }
  G.enemies.filter(e=>!e.dead).forEach(e=>{
    if(e.statuses.stun)return;
    e.actionMeter+=eSpd(e)/500;
    if(e.actionMeter>=1){e.actionMeter=0;doEnemyAtk(e);}
  });

  if(checkEnd())return;
  if(G.tick%2===0)renderBattleUI();
}

function doHeroAtk(){
  const h=G.hero,alive=G.enemies.filter(e=>!e.dead);
  if(!alive.length)return;
  h.atkCount++;
  const target=pickHeroTarget(alive);
  const es=effectiveStats();

  if(rng()>es.accuracy-(target.evasion||0)){addLog(`  â†© Miss!`,'lmiss');return;}

  let crit=h.flags.openStrike?(h.flags.openStrike=false,true):(rng()<es.critChance);
  let dmg=heroAtk();
  if(h.flags.tacticAmbush){dmg=Math.floor(dmg*2);h.flags.tacticAmbush=false;addLog(`  ðŸ—¡ Ambush!`,'laxiom');}

  if(h.flags.deathMark){dmg=Math.floor(dmg*2.6);h.flags.deathMark=0;addLog(`  â˜  Death Mark!`,'laxiom');}
  const tr=passive('trance');if(tr&&h.atkCount%tr===0){dmg=Math.floor(dmg*1.9);addLog(`  ðŸ” Battle Trance!`,'laxiom');}
  const arc=passive('arcane');if(arc&&h.atkCount%arc===0){const md=Math.floor(dmg*.9);addLog(`  ðŸ”® Arcane Surge! +${md}`,'laxiom');dealToEnemy(target,md);}
  const vs=passive('void');if(vs&&h.atkCount%vs===0){const vd=Math.floor(dmg*3);addLog(`  ðŸŒ€ VOID STRIKE! ${vd}!`,'laxiom');dealToEnemy(target,vd);if(target.dead)return;}

  const doEcho=hasP('axiomEcho')&&(h.atkCount%passive('axiomEcho')===0);
  if(crit)dmg=Math.floor(dmg*es.critDmg);

  let effDef=target.def;
  if(hasP('necroticPoison')&&target.statuses.poison)effDef=Math.max(0,effDef-target.statuses.poison.stacks*passive('necroticPoison'));
  const dp=passive('defpen');if(dp)effDef=Math.floor(effDef*(1-dp));
  const gearDp=es._gearDefPen||0;if(gearDp>0)effDef=Math.floor(effDef*(1-gearDp));
  if(crit){const cdp=passive('critDefpen');if(cdp)effDef=Math.floor(effDef*(1-cdp));}

  const exec=passive('executioner');if(exec&&target.hp<target.maxHP*.30)dmg=Math.floor(dmg*(1+exec));
  const gearExec=es._gearExecutionBonus||0;if(gearExec&&target.hp<target.maxHP*.30)dmg=Math.floor(dmg*(1+gearExec));
  if(hasTrait('executioner_b')&&target.hp<target.maxHP*.30)dmg=Math.floor(dmg*1.15);
  if(target.statuses.vulnerable)dmg=Math.floor(dmg*1.30);

  dmg=Math.max(1,dmg-effDef);
  const actual=dealToEnemy(target,dmg);

  if(G.hero.gear){
    Object.values(G.hero.gear).forEach(item=>{
      if(!item)return;
      getGearEffectiveAffixes(item).forEach(affix=>{
        if(affix.stat==='onCritBleedChance'&&crit&&!target.dead){if(rng()<affix.effectiveValue)applyStatus(target,'bleed',1,3);}
        if(affix.stat==='permAtkOnKill'&&target.dead){
          G.hero.permStats.atk=(G.hero.permStats.atk||0)+Math.floor(affix.effectiveValue);
          addLog(`  âš” Tyrfing feeds. +${Math.floor(affix.effectiveValue)} permanent ATK.`,'laxiom');
        }
      });
    });
  }

  if(crit){
    G._critLandedThisWave=true;
    addLog(`  âš” CRIT! ${target.displayName||target.name} â† ${actual}`,'lcrit');
    NarrationEngine.onCrit();
  } else addLog(`  âš” ${target.displayName||target.name} â† ${actual}`,'lhit');

  const ls=Math.floor(actual*(es.lifesteal||0));if(ls>0)healHero(ls,'ls');
  if(hasTrait('serrated')&&rng()<.22&&!target.dead)applyStatus(target,'bleed',1,2);

  trigBoon('onHit',h,target);
  const sh=passive('shred');if(sh && !target.dead){const before=target.def;target.def=Math.max(0,target.def-sh);if(target.def!==before)addLog(`  ðŸª¨ Sunder! ${target.displayName||target.name} DEF -${before-target.def}`,'lstatus');}

  if(crit)trigBoon('onCrit',h,target);
  const sc=passive('stunCrit');if(crit&&sc&&rng()<sc&&!target.dead){applyStatus(target,'stun',1,1);addLog(`  ðŸ’« Stun!`,'lstatus');}


  const tw=passive('twin');
  if(tw&&rng()<tw){
    const t2=G.enemies.find(e=>!e.dead);
    if(t2){
      const td2=Math.max(1,Math.floor(heroAtk())-t2.def);
      dealToEnemy(t2,td2);
      addLog(`  âš”âš” Twin! ${t2.displayName||t2.name} â† ${td2}`,'lhit');
    }
  }
  if(doEcho&&!target.dead){
    const ed=Math.max(1,Math.floor(heroAtk()*.5)-effDef);
    dealToEnemy(target,ed);
    addLog(`  ðŸ” Echo! ${target.displayName||target.name} â† ${ed}`,'laxiom');
  }
}

function doEnemyAtk(enemy){
  const h=G.hero,ev=effectiveStats().evasion;
  const pendingDodge=enemy._tier2DodgePending||0;
  enemy._tier2DodgePending=0; // consume immediately
  if(rng()<ev+pendingDodge){
    addLog(`  ðŸ’ƒ Dodged ${enemy.displayName||enemy.name}!`,'lmiss');
    trigBoon('onDodge',h,enemy);
    return;
  }

  // â”€â”€ TIER 2 BEHAVIORS (active when G.tierFlags.archetypeBehaviors is true) â”€â”€
  const tier2Active=!!(G.tierFlags&&G.tierFlags.archetypeBehaviors);
  const arch=ARCHETYPES.find(a=>a.id===enemy.archId);
  if(tier2Active&&arch&&arch.tier2Behavior){
    if(arch.tier2Behavior==='regenOnFirstAttack'&&!enemy._tier2Done){
      enemy._tier2Done=true;
      const heal=Math.floor(enemy.maxHP*(arch.tier2RegenPct||0));
      enemy.hp=Math.min(enemy.maxHP,enemy.hp+heal);
      addLog(`  âš™ ${enemy.displayName||enemy.name} Iron Regen: +${heal} HP`,'lstatus');
    }
    if(arch.tier2Behavior==='weakOnFirstAttack'&&!enemy._tier2Done){
      enemy._tier2Done=true;
      applyStatus(h,'weak',1,3);
      addLog(`  ðŸ”® ${enemy.displayName||enemy.name} Hex â€” first strike! Weak applied.`,'lstatus');
    }
  }

  let dmg=enemy.atk;
  let crit=rng()<(enemy.cc||.05);

  // New archetype abilities
  if(enemy.archId==='archer'){
    enemy._pierceCtr=(enemy._pierceCtr||0)+1;
    enemy._pierce=(enemy._pierceCtr%4===0);
    if(enemy._pierce) addLog(`  ðŸ¹ Piercing Shot!`,'lstatus');
  }
  if(enemy.archId==='frost'){
    enemy._frostCtr=(enemy._frostCtr||0)+1;
    if(enemy._frostCtr%3===0){applyStatus(h,'slow',1,3);addLog(`  â„ï¸ Frostbite! Slow`,'lstatus');}
    if(crit&&rng()<0.15){applyStatus(h,'stun',1,1);addLog(`  ðŸ’« Frozen! Stun`,'lstatus');}
  }
  if(enemy.archId==='warden'){
    enemy._bannerCtr=(enemy._bannerCtr||0)+1;
    if(enemy._bannerCtr%4===0){applyStatus(h,'weak',1,3);addLog(`  ðŸ§¿ Suppressed! Weak`,'lstatus');}
  }

  if(enemy.beh==='burst'&&!enemy._firstAtkDone){enemy._firstAtkDone=true;dmg*=2;addLog(`  ðŸ—¡ AMBUSH! ${enemy.displayName||enemy.name}!`,'lcrit');}
  if(enemy.archId==='bombardier'){enemy._chargeCtr++;if(enemy._chargeCtr%3===0){dmg*=2;addLog(`  ðŸ’£ OVERCHARGE! ${enemy.displayName||enemy.name}!`,'lcrit');}}
  if(enemy.archId==='shaman'){enemy._hexCtr++;if(enemy._hexCtr%3===0){applyStatus(h,'weak',1,4);addLog(`  ðŸ”® Hex! Weak on hero`,'lstatus');}}

  if(tier2Active&&arch&&arch.tier2Behavior==='enrageOnLowHP'){
    if(enemy.hp<enemy.maxHP*(arch.tier2Threshold||0.35)&&!enemy._tier2Enraged){
      enemy._tier2Enraged=true;
      enemy.atk+=arch.tier2BonusAtk||5;
      addLog(`  ðŸº ${enemy.displayName||enemy.name} Wolf-Rage! +${arch.tier2BonusAtk||5} ATK`,'lcrit');
    }
  }

  if(crit)dmg=Math.floor(dmg*(enemy.cd||1.5));

  const heroDef=(enemy.archId==='archer'&&enemy._pierce)?Math.floor(h.def*0.2):h.def;
  const reduced=Math.max(1,Math.floor(dmg)-heroDef);
  const actual=heroDmg(reduced,enemy,'attack');

  if(crit)addLog(`  ðŸ’¥ ${enemy.displayName||enemy.name} CRITS! ${actual}`,'lcrit');
  else addLog(`  ðŸ‘Š ${enemy.displayName||enemy.name} hits ${actual}`,'lhit');

  if(enemy.lifesteal>0)enemy.hp=Math.min(enemy.maxHP,enemy.hp+Math.floor(actual*enemy.lifesteal));

  if(enemy.rootTouched&&!enemy.dead){
    if(enemy.archId==='bruiser'&&rng()<0.40){
      applyStatus(G.hero,'vulnerable',1,2);
      addLog(`  ðŸŒ‘ Root-Touched corruption: Vulnerable (2s)`,'lstatus');
    }else if(enemy.archId==='striker'&&rng()<0.30){
      applyStatus(G.hero,'poison',1,3);
      addLog(`  ðŸŒ‘ Root-Touched eitr: Poison (3s)`,'lstatus');
    }
  }

  if(crit&&tier2Active&&arch&&arch.tier2Behavior==='dodgeAfterCrit'&&arch.tier2DodgeChance){
    enemy._tier2DodgePending=arch.tier2DodgeChance;
  }
  if(crit&&tier2Active&&arch&&arch.tier2Behavior==='exposeCritVuln'&&arch.tier2ExposeChance&&rng()<arch.tier2ExposeChance){
    applyStatus(h,'vulnerable',1,3);
    addLog(`  ðŸŽ¯ ${enemy.displayName||enemy.name} exposes weakness! Vulnerable`,'lstatus');
  }

  if(G.waveFlags.eEcho&&rng()<.25){
    const e2=Math.max(1,Math.floor(enemy.atk*.55)-h.def);
    heroDmg(e2,enemy,'echo');
    addLog(`  ðŸ”Š Echo! ${e2}`,'lhit');
  }

  if(G.tierFlags&&G.tierFlags.emberSparkChance&&G.wave>=(G.tierFlags.muspelheimTagFromWave||7)){
    if(rng()<G.tierFlags.emberSparkChance){
      const sparkDmg=Math.max(1,Math.floor(enemy.atk*0.15)-G.hero.def);
      heroDmg(sparkDmg,enemy,'ember');
      addLog(`  ðŸ”¥ Ember spark! ${sparkDmg} fire damage.`,'lstatus');
      applyStatus(G.hero,'bleed',1,2);
    }
  }

  if(enemy.signature&&typeof enemy.signature.apply==='function'){
    enemy.signature.apply(enemy,G.hero);
  }
  if(G.tierFlags&&G.tierFlags.eliteSecondPhase&&enemy.elite&&!enemy._secondPhaseActivated){
    if(enemy.hp<enemy.maxHP*0.40){
      enemy._secondPhaseActivated=true;
      enemy.atk=Math.floor(enemy.atk*1.20);
      enemy.spd=Math.floor(enemy.spd*1.15);
      addLog(`  â­ ${enemy.displayName||enemy.name} â€” SECOND WIND! +20% ATK, +15% SPD!`,'lcrit');
    }
  }
}

function onKill(enemy){
  addLog(`  ðŸ’€ ${enemy.displayName||enemy.name} slain!`,'ldeath');
  // Near-death kill narration
  if(G.hero.hp<G.hero.maxHP*0.25){
    NarrationEngine.onNearDeathKill();
  }
  NarrationEngine.onKill();
  if(G.waveFlags.enraged){
    G.enemies.filter(e=>!e.dead).forEach(e=>e.atk+=15);
    addLog(`  ðŸ˜¡ Enraged! +15 ATK!`,'lstatus');
  }
  G.waveGold+=ri(3,7);

  if(G.tierFlags&&G.tierFlags.killDropsMark){
    G.gold+=G.tierFlags.killDropsMark;
  }

  if(G.tierFlags&&G.tierFlags.draugrEchoChance&&!enemy._isEcho){
    if(rng()<G.tierFlags.draugrEchoChance){
      setTimeout(()=>draugrEchoRevive(enemy),0);
    }
  }

  trigBoon('onKill',G.hero,enemy);
}

function draugrEchoRevive(originalEnemy){
  if(!G||G.phase!=='BATTLE')return;
  const echoHP=Math.floor(originalEnemy.maxHP*0.25);
  const echo={
    ...JSON.parse(JSON.stringify(originalEnemy)),
    id:originalEnemy.id+'_echo',
    hp:echoHP,maxHP:echoHP,
    displayName:'Echo: '+(originalEnemy.displayName||originalEnemy.name),
    name:'Echo: '+(originalEnemy.displayName||originalEnemy.name),
    dead:false,
    _isEcho:true,
    actionMeter:0.3,
    statuses:{},
    elite:false,
  };
  if(originalEnemy.archId==='frost'||originalEnemy.realmTier==='niflheim'){
    echo.statuses.slow={stacks:1,value:0,dur:4};
  }
  G.enemies.push(echo);
  addLog(`  ðŸ’€ The dead remember â€” ${originalEnemy.displayName||originalEnemy.name} rises!`,'lstatus');
}

function tickStatuses(unit,isHero){
  const bm=isHero?1.0:Math.max(1,passive('bleedMult')||1);
  const pm=isHero?1.0:Math.max(1,passive('poisonMult')||1);
  const vk=isHero?0:(hasTrait('venomkiss')?1:0);

  for(const [k,s] of Object.entries(unit.statuses)){
    if(!s)continue;
    if(k==='shield')continue;
    if(s.dur!==9999){
      s.dur--;
      if(s.dur<=0){delete unit.statuses[k];continue;}
    }
    if(k==='bleed'){
      let d=Math.floor((3+s.stacks)*bm);
      if(!isHero&&G.tierFlags&&G.tierFlags.dotDamageBonus){
        d=Math.floor(d*(1+G.tierFlags.dotDamageBonus));
      }
      if(isHero){const dr=passive('dotResist');if(dr)d=Math.floor(d*dr);const gdr=(effectiveStats()._gearDotResist||0);if(gdr)d=Math.floor(d*(1-gdr));}
      if(isHero)heroDmg(d,null,'dot');
      else{unit.hp=Math.max(0,unit.hp-d);if(unit.hp<=0&&!unit.dead){unit.dead=true;onKill(unit);}}
    }
    if(k==='poison'){
      let d=Math.floor((2+s.stacks+vk)*pm);
      if(!isHero&&G.tierFlags&&G.tierFlags.dotDamageBonus){
        d=Math.floor(d*(1+G.tierFlags.dotDamageBonus));
      }
      if(isHero){const dr=passive('dotResist');if(dr)d=Math.floor(d*dr);const gdr=(effectiveStats()._gearDotResist||0);if(gdr)d=Math.floor(d*(1-gdr));}
      if(isHero)heroDmg(d,null,'dot');
      else{unit.hp=Math.max(0,unit.hp-d);if(unit.hp<=0&&!unit.dead){unit.dead=true;onKill(unit);}}
    }
    if(k==='regen'&&isHero){
      const baseHeal=s.value||3;
      const regenBonus=(G.tierFlags&&G.tierFlags.regenBoonBonus)||0;
      const totalHeal=Math.floor(baseHeal*(1+regenBonus));
      healHero(totalHeal,'regen');
    }
  }
}

// â•â•â• END CONDITIONS â•â•â•
function checkEnd(){
  if(G.hero.hp<=0){
    clearInterval(G.interval);
    addLog('  ðŸ’€ Hero has fallen.','ldeath');
    heroFell();
    G.phase='GAME_OVER';
    renderAll();
    return true;
  }
  if(G.enemies.every(e=>e.dead)){
    clearInterval(G.interval);
    const baseGoldRaw=15+G.wave*3+(G.waveGold||0);
    const baseGold=Math.floor(baseGoldRaw*(G.waveGoldMult||1));
    G.gold+=baseGold;
    const xpEarned=20+G.wave*9;G.xp+=xpEarned;
    addLog(`ðŸ† Trial ${G.wave} complete! +${baseGold}á›‹ +${xpEarned}XP`,'lwave');
    G.activeTactic=null;G.waveGoldMult=1;
    checkLevelUp();
    G.rerollCost=10;
    G.enemies.filter(e=>e.elite).forEach(e=>{
      const heroSurvived=G.hero.hp>0;
      recordEliteEncounter(e.archId,heroSurvived,G._narratedNearDeath||false,G._critLandedThisWave||false);
    });
    G._critLandedThisWave=false;
    genDraft();
    const waveEndLine=MYTH_LINES.waveEnd[G.wave];
    if(waveEndLine) NarrationEngine.fire('waveEnd',waveEndLine,'lstatus');
    addNotchesToHeroGear(G.wave);
    G.forgeStallItem=genForgeStallItem(G.wave);
    G.phase='REWARDS';
    renderAll();
    return true;
  }
  return false;
}

function checkLevelUp(){
  while(G.xp>=G.xpNeeded){
    G.xp-=G.xpNeeded;G.level++;G.xpNeeded=Math.floor(G.xpNeeded*1.35);
    G.hero.maxHP+=18;G.hero.hp=Math.min(G.hero.maxHP,G.hero.hp+18);G.hero.atk+=3;G.hero.def+=1;
    addLog(`ðŸŒŸ Level Up â†’ Lv.${G.level}! (+18 HP +3 ATK +1 DEF)`,'laxiom');
    NarrationEngine.fire('levelUp',MYTH_LINES.levelUp,'lstatus');
  }
}

// â”€â”€â”€ RETIRE FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function computeEarnedEVs(){
  return{
    hp:Math.min(8,Math.max(0,Math.floor((G.wave-1)*0.8))),
    atk:Math.min(8,Math.max(0,Math.floor((G.wave-1)*0.7))),
    def:Math.min(6,Math.max(0,Math.floor((G.wave-1)*0.5))),
    spd:Math.min(6,Math.max(0,Math.floor((G.wave-1)*0.4))),
    crit:Math.min(5,Math.max(0,Math.floor(G.level*0.6))),
    eva:Math.min(4,Math.max(0,Math.floor(G.level*0.3))),
    acc:Math.min(4,Math.max(0,Math.floor(G.level*0.3))),
    ls:Math.min(3,Math.max(0,Math.floor(G.level*0.2))),
  };
}

function retireHero(){
  const rec=G.hero.record;
  const earnedEVs=computeEarnedEVs();
  rec.runResult={
    outcome:'retired',wave:G.wave,
    boons:G.boons.map(b=>b.id),
    axioms:G.boons.filter(b=>b.rarity==='axiom').map(b=>b.id),
    level:G.level,earnedEVs,ts:Date.now()
  };
  assignBreedUses(rec, calcBreedUsesForRetire());
  const cap=evCap();
  EV_KEYS.forEach(k=>rec.evs[k]=Math.min(cap,(rec.evs[k]||0)+(earnedEVs[k]||0)));
  META.family[rec.id]=rec;
  if(META.retiredPool.length>=poolMax())META.retiredPool.shift();
  META.retiredPool.push(rec.id);
  const essence=Math.floor(G.gold*.35)+G.wave*4;
  META.legacyEssence+=essence;
  if(G.interval)clearInterval(G.interval);
  addLog(`ðŸ› ${rec.name} sealed their saga at Trial ${G.wave}! +${essence} Allfather's Blessing.`,'laxiom');
  checkRagnarÃ¶kUnlock();
  saveMeta();
  showRetireRelicChoice(rec, essence);
}

function showImprintOffer(rec,axiomBoons,essence){
  const candidates=axiomBoons.slice(0,3);
  const chance=imprintChance();
  let html=`
    <div style="font-family:'Orbitron',sans-serif;font-size:18px;font-weight:900;color:var(--gold);margin-bottom:8px">áš±áš¢áš¾ RUNE OATH</div>
    <p style="color:var(--txt2);font-size:12px;margin-bottom:16px">${rec.name} carried Axiom knowledge. You may attempt to imprint one as a heritable genetic trait.<br>
    <span style="color:var(--amber)">Imprint Chance: ${Math.round(chance*100)}%</span></p>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
    ${candidates.map(b=>{
      const traitMapping={'ax_crimson':'serrated','ax_ghost':'skirmisher','ax_harvest':'resilient','ax_wrath':'gambler','ax_iron_law':'ironblood','ax_echo':'swift_born','ax_aegis':'aegis','ax_opening':'lucky','ax_kinetic':'lucky','ax_fortress':'tenacious','ax_plague':'venomkiss','ax_mirror':'spite'};
      const tk=traitMapping[b.id]||rpick(GTRAIT_KEYS);
      const gt=GTRAITS[tk];
      return `<div class="imprint-card" onclick="tryImprint('${rec.id}','${tk}',${chance},'${b.id}')">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><span style="font-size:14px">${b.icon}</span> <strong style="font-size:12px">${b.name}</strong></div>
          <div style="font-size:10px;color:var(--amber)">${Math.round(chance*100)}% chance</div>
        </div>
        <div style="font-size:10px;color:var(--txt3);margin-top:3px">â†’ Genetic: <span style="color:#d090ff">${gt?gt.icon+' '+gt.name:'Unknown'}</span>: ${gt?gt.desc:''}</div>
      </div>`;
    }).join('')}
    </div>
    <button class="btn btn-sm btn-ghost" style="width:100%" onclick="showRetireSummary(META.family['${rec.id}'],${essence},null)">Skip Imprint</button>`;
  showOverlayContent(html);
}

function tryImprint(heroId,traitKey,chance,boonId){
  const rec=META.family[heroId];if(!rec)return;
  const success=Math.random()<chance;
  if(success&&rec.traits.length<TRAIT_MAX_BASE){
    if(!rec.traits.includes(traitKey))rec.traits.push(traitKey);
    saveMeta();
    addLog(`ðŸ§¬ OATH SEALED! ${GTRAITS[traitKey]?.name||traitKey} is now hereditary!`,'laxiom');
  }else{
    addLog(`ðŸ§¬ The oath slips away. The knowledge fades...`,'lstatus');
  }
  showRetireSummary(rec,META.legacyEssence,null);
}

function showRetireSummary(rec,essence,earnedEVs){
  const ev=rec.evs;
  let html=`
    <div style="font-family:'Orbitron',sans-serif;font-size:18px;font-weight:900;
              color:var(--gold);margin-bottom:8px">ðŸ› SAGA SEALED</div>
    <div style="color:var(--txt2);font-size:13px;margin-bottom:6px">
      ${rec.name} has been added to the Chosen of the Hall.
    </div>
    <div style="font-size:11px;color:var(--txt3);font-style:italic;margin-bottom:14px">
      "Let the blood carry the rest."
    </div>
    <div style="background:var(--bg2);border:1px solid var(--border2);border-radius:5px;padding:12px;margin-bottom:14px;text-align:left">
      <div style="font-size:10px;color:var(--txt3);letter-spacing:2px;margin-bottom:8px">GENETIC PROFILE</div>
      ${EV_KEYS.map(k=>`<div class="srow"><span class="sl">${k.toUpperCase()}_EV</span><span class="sv">${ev[k]||0} / ${evCap()}</span></div>`).join('')}
      ${rec.traits.length?`<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:3px">${rec.traits.map(tk=>{const gt=GTRAITS[tk];return gt?`<span class="gtrait">${gt.icon} ${gt.name}</span>`:''}).join('')}</div>`:''}
    </div>
    <div style="color:var(--green);font-size:13px;margin-bottom:16px">+${essence} Allfather's Blessing added to lineage coffers.</div>
    <div style="margin:0 0 14px">
      <label style="font-size:11px;color:var(--txt3);display:block;margin-bottom:6px;letter-spacing:1px;text-transform:uppercase">Difficulty (enemy stats)</label>
      <div style="display:flex;align-items:center;gap:10px">
        <input id="start-diff" type="range" min="0" max="2" step="0.1"
          value="${Number(UI.difficulty??1)}"
          oninput="onDifficultyInput(this.value,'start')"
          style="flex:1;accent-color:var(--amber)">
        <span id="start-diff-val" style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--gold)">x${Number(UI.difficulty??1).toFixed(1)}</span>
      </div>
      <div style="font-size:10px;color:var(--txt3);margin-top:4px">0 = trivial Â· 1 = default Â· 2 = brutal</div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-primary" style="flex:1" onclick="hideOverlay();showLegacy()">ðŸ› View Legacy</button>
      <button class="btn btn-green" style="flex:1" onclick="hideOverlay();showStartScreen()">â–¶ Begin New Saga</button>
    </div>`;
  showOverlayContent(html);
}

// â”€â”€â”€ DEATH FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function heroFell(){
  const rec=G.hero.record;
  const salvageEarned=G.wave*2+G.boons.filter(b=>b.rarity==='axiom').length*5+Math.floor(G.boons.length/2);
  rec.runResult={outcome:'fallen',wave:G.wave,boons:G.boons.map(b=>b.id),axioms:G.boons.filter(b=>b.rarity==='axiom').map(b=>b.id),level:G.level,salvageEarned,ts:Date.now()};
  META.family[rec.id]=rec;
  META.fallenLedger.push(rec.id);
  META.salvage+=salvageEarned;
  saveMeta();
  addLog(`  The saga closed. áš±${salvageEarned} Rune-Shards recovered from ${rec.name}'s last stand.`,'ldeath');
  updateMetaHeader();
}

// â”€â”€â”€ BREEDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let BREED_SELECTED=[];
function breedHeroes(idA,idB){
  const recA=META.family[idA],recB=META.family[idB];
  if(!recA||!recB)return null;
  const cap=evCap();
  const VAR=5;
  const childEVs={};
  EV_KEYS.forEach(k=>{
    let val=Math.round(((recA.evs[k]||0)+(recB.evs[k]||0))/2+ri(-VAR,VAR));
    if(Math.random()<.08)val+=ri(5,12);
    childEVs[k]=Math.min(cap,Math.max(0,val));
  });
  const allParentTraits=[...new Set([...recA.traits,...recB.traits])];
  const sharedTraits=recA.traits.filter(t=>recB.traits.includes(t));
  const childTraits=[];
  for(const t of allParentTraits){
    const baseChance=sharedTraits.includes(t)?.75:.45;
    if(Math.random()<baseChance)childTraits.push(t);
  }
  if(Math.random()<mutationRate()){
    const unlocked=[...META.unlockedTraits];
    const available=unlocked.filter(t=>!childTraits.includes(t));
    if(available.length){
      const mut=rpick(available);
      childTraits.push(mut);
      addLog(`ðŸ§¬ MUTATION! New trait emerged: ${GTRAITS[mut]?.name||mut}!`,'laxiom');
    }
  }
  const finalTraits=childTraits.slice(0,TRAIT_MAX_BASE);
  const genNum=Math.max(recA.gen,recB.gen)+1;
  const topEvK=EV_KEYS.reduce((a,b)=>childEVs[a]>childEVs[b]?a:b);
  const evTagMap={hp:'Sustain',atk:'Execute',def:'Bulwark',spd:'Tempo',crit:'Crit',eva:'Tempo',acc:'Crit',ls:'Sustain'};
  const topTag=evTagMap[topEvK]||'Arcane';
  const childName=genName(genNum,topTag,[recA.name,recB.name]);
  const childRec=mkHeroRecord(childName,genNum,[recA.id,recB.id],childEVs,finalTraits);
  META.family[childRec.id]=childRec;
  saveMeta();
  return childRec;
}

// â”€â”€â”€ DRAFT SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function genDraft(){
  const owned=new Set(G.boons.map(b=>b.id));
  const curTags=new Set(G.boons.flatMap(b=>b.tags));
  const rw={common:40,uncommon:26,rare:16,epic:9,legendary:4,axiom:3};
  const boost=Math.min(G.wave,10);
  rw.common=Math.max(8,rw.common-boost*2);rw.rare+=boost;rw.epic+=Math.floor(boost/2);rw.axiom+=Math.floor(boost/3);

  const pool=BOONS.filter(b=>!owned.has(b.id));
  if(pool.length<1){G.draft=[];return;}

  const wfn=b=>{
    let w=rw[b.rarity]||5;
    const synCount=b.tags.filter(t=>curTags.has(t)).length;
    const syn=Math.min(2,synCount);
    w+=syn*6;
    if(synCount===0 && G.wave<=3 && (b.rarity==='common'||b.rarity==='uncommon')) w+=3;
    if(G.wave<=2&&b.rarity==='common')w+=20;
    return Math.max(1,w);
  };

  const picked=[],used=new Set();
  let att=0;
  while(picked.length<4&&att<300){
    att++;
    const b=rwgt(pool.filter(x=>!used.has(x.id)),wfn);
    if(b&&!used.has(b.id)){picked.push(b);used.add(b.id);}
  }
  G.draft=picked;
}

function pickBoon(id){
  const boon=BOONS.find(b=>b.id===id);if(!boon)return;
  G.boons.push(boon);
  applyBoonEffectsOnPick(boon);
  addLog(`ðŸ“œ Rune-Gift chosen: ${boon.name} [${boon.rarity}]`,'laxiom');
  if(boon.rarity==='axiom'){
    NarrationEngine.fire('generic',MYTH_LINES.axiomPicked,'laxiom');
  }
  G.draft=[];

  if(G.wave>=G.maxWaves){
    const rec=G.hero.record;
    rec.runResult={outcome:'victory',wave:G.wave,boons:G.boons.map(b=>b.id),axioms:G.boons.filter(b=>b.rarity==='axiom').map(b=>b.id),level:G.level,ts:Date.now()};
    assignBreedUses(rec, 2);
    const earnedEVs=computeEarnedEVs();
    EV_KEYS.forEach(k=>rec.evs[k]=Math.min(evCap(),(rec.evs[k]||0)+(earnedEVs[k]||0)));
    META.family[rec.id]=rec;
    if(META.retiredPool.length>=poolMax())META.retiredPool.shift();
    META.retiredPool.push(rec.id);
    META.legacyEssence+=80;
    saveMeta();
    G.phase='VICTORY';
    checkRagnarÃ¶kUnlock();
    renderAll();
    return;
  }

  G.wave++;
  genWave();
  renderAll();
}

function doReroll(){
  if(G.gold<G.rerollCost)return;
  G.gold-=G.rerollCost;
  const increase=(G.tierFlags&&G.tierFlags.rerollCostIncreaseOverride)||6;
  G.rerollCost+=increase;
  genDraft();
  renderAll();
}

function shopBuy(item){
  const shop={
    heal:{cost:20,fn(){const h=Math.floor(G.hero.maxHP*.36);healHero(h,'shop');}},
    atk:{cost:14,fn(){G.hero.atk+=7;addLog(`â¬† +7 ATK`,'lheal');}},
    def:{cost:12,fn(){G.hero.def+=5;addLog(`â¬† +5 DEF`,'lheal');}},
    hp:{cost:10,fn(){G.hero.maxHP+=28;G.hero.hp=Math.min(G.hero.maxHP,G.hero.hp+28);addLog(`â¬† +28 MaxHP`,'lheal');}},
    spd:{cost:15,fn(){G.hero.spd+=10;addLog(`â¬† +10 SPD`,'lheal');}},
    crit:{cost:20,fn(){G.hero.critChance=Math.min(.9,G.hero.critChance+.06);addLog(`â¬† +6% Crit`,'lheal');}},
  };
  const s=shop[item];if(!s||G.gold<s.cost)return;
  G.gold-=s.cost;s.fn();renderAll();
}

// â•â•â• RUN RENDERING â•â•â•
function renderAll(){renderHero();renderRight();renderCenter();renderFooter();updateHeader();updateMetaHeader();}
function renderBattleUI(){renderHero();renderCenter();updateHeader();}

function updateHeader(){
  if(!G)return;
  document.getElementById('hdr-wave').textContent=`Trial ${G.wave}/${G.maxWaves}`;
  document.getElementById('hdr-lvl').textContent=`Lv.${G.level}Â·${G.xp}/${G.xpNeeded}XP`;
  document.getElementById('hdr-gold').textContent=G.gold;
  document.getElementById('hdr-salvage').textContent=META.salvage;
}

function updateMetaHeader(){
  const el1=document.getElementById('leg-essence');if(el1)el1.textContent=META.legacyEssence;
  const el2=document.getElementById('leg-salvage');if(el2)el2.textContent=META.salvage;
  const el3=document.getElementById('leg-relics');if(el3)el3.textContent=META.relics||0;
  const hs=document.getElementById('hdr-salvage');if(hs)hs.textContent=META.salvage;
  checkCodexUnlocks();
  updateRootDepthHeader();
}

function renderHero(){
  if(!G)return;
  const h=G.hero,es=effectiveStats();
  const hpPct=Math.max(0,h.hp/h.maxHP*100);
  const sh=h.statuses.shield;
  const shPct=sh?Math.min(100-hpPct,sh.value/h.maxHP*100):0;
  const pm=(h.permStats.atk||0),tmp=(h.tempStats.atk||0);
  let atkStr=`${Math.round(h.atk+pm)}`;if(tmp>0)atkStr+=` <span class="sdp">+${tmp}</span>`;
  const rec=h.record;

  let html='';
  if(rec){
    html+=`<div style="background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:5px 8px;margin-bottom:6px">
      <div style="font-size:11px;color:var(--txt3)">Gen ${rec.gen} Â· ${rec.name}</div>
      ${rec.traits.length?`<div style="display:flex;flex-wrap:wrap;gap:2px;margin-top:3px">${rec.traits.map(tk=>{const gt=GTRAITS[tk];return gt?`<span class="gtrait" title="${gt.desc}">${gt.icon} ${gt.name}</span>`:''}).join('')}</div>`:''}
    </div>`;
  }


  const tact=(G.activeTactic && TACTIC_BY_ID[G.activeTactic]) || (G.pendingTactic && TACTIC_BY_ID[G.pendingTactic]);
  if(tact){
    const state=G.activeTactic?'Active':'Planned';
    const extra=G.activeTactic?'':` Â· á›‹${tact.cost} on start`;
    html+=`<div style="margin:6px 0 2px"><span class="tactic-pill">ðŸ§  ${state}: ${tact.icon} ${tact.name}${extra}</span></div>`;
  }

  html+=`<div class="sec-title">Hero Stats</div>
  <div class="bar-wrap">
    <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--txt3);margin-bottom:3px">
      <span>HP</span><span style="font-family:'Share Tech Mono',monospace">${h.hp}/${h.maxHP}${sh?' ðŸ›¡'+sh.value:''}</span>
    </div>
    <div class="bar bar-hp"><div class="bar-fill" style="width:${hpPct}%"></div>${sh?`<div class="bar-shield-ovl" style="left:${hpPct}%;width:${shPct}%"></div>`:''}</div>
    <div class="bar bar-xp" style="margin-top:3px"><div class="bar-xp-fill" style="width:${(G.xp/G.xpNeeded*100)}%"></div></div>
    <div class="bar-txt">${h.hp}/${h.maxHP} HP Â· Lv.${G.level}</div>
  </div>
  <div style="margin-top:6px">
    <div class="srow"><span class="sl">âš” ATK</span><span class="sv">${atkStr}</span></div>
    <div class="srow"><span class="sl">ðŸ›¡ DEF</span><span class="sv">${Math.round(h.def)}</span></div>
    <div class="srow"><span class="sl">âš¡ SPD</span><span class="sv">${Math.round(h.spd)}</span></div>
    <div class="srow"><span class="sl">ðŸŽ¯ Crit</span><span class="sv">${Math.round(es.critChance*100)}% / ${Math.round(es.critDmg*100)}%</span></div>
    <div class="srow"><span class="sl">ðŸ’ƒ Eva</span><span class="sv">${Math.round(h.evasion*100)}%</span></div>
    <div class="srow"><span class="sl">ðŸ§› LS</span><span class="sv">${Math.round(h.lifesteal*100)}%</span></div>
  </div>`;

  const sbadges=Object.entries(h.statuses).filter(([k,s])=>s&&(s.stacks>0||s.value>0));
  if(sbadges.length){
    html+=`<div class="sec-title" style="margin-top:7px">Statuses</div><div style="display:flex;flex-wrap:wrap;gap:2px">`;
    sbadges.forEach(([k,s])=>{
      const sd=STATUS[k];if(!sd)return;
      const lbl=k==='shield'?`${sd.name}:${s.value}`:`${sd.name}${s.stacks>1?' Ã—'+s.stacks:''}${s.dur!==9999?' ('+s.dur+'s)':''}`;
      html+=`<span class="sbadge ${sd.cls}" title="${sd.desc}">${sd.icon} ${lbl}</span>`;
    });
    html+=`</div>`;
  }

  if(G.boons.length){
    html+=`<div class="sec-title" style="margin-top:7px">Rune-Gifts (${G.boons.length})</div><div style="display:flex;flex-wrap:wrap;gap:3px">`;
    G.boons.forEach(b=>html+=`<div class="inv-item ii-${b.rarity}" title="${b.name}: ${b.desc}">${b.icon}</div>`);
    html+=`</div>`;
  }
  const gearSlots=G.hero.gear?Object.entries(G.hero.gear).filter(([slot,item])=>item):[];
  if(gearSlots.length){
    html+=`<div class="sec-title" style="margin-top:7px">Gear</div><div style="display:flex;flex-direction:column;gap:3px">`;
    gearSlots.forEach(([slot,item])=>{
      const sunTag=item.sundered?' <span style="color:var(--amber);font-size:9px">âš SUNDERED</span>':'';
      const notchPips=item.notches>0?('<span style="font-size:9px;color:var(--txt3)"> '+'â—†'.repeat(item.notches)+'</span>'):'';
      const tt=`${item.affixes.map(a=>a.label).join(', ')}${item.loreNote?'\n'+item.loreNote:''}`;
      html+=`<div title="${tt}" style="font-size:10px;color:${rarityColor(item.rarity)}">${slot.toUpperCase()}: ${item.name}${sunTag}${notchPips}</div>`;
    });
    html+=`</div>`;
  }
  document.getElementById('hero-content').innerHTML=html;
}

function renderRight(){
  if(!G){document.getElementById('right-content').innerHTML='';return;}
  const tagCounts={};G.boons.forEach(b=>b.tags.forEach(t=>{tagCounts[t]=(tagCounts[t]||0)+1;}));
  const topTags=Object.entries(tagCounts).sort((a,b)=>b[1]-a[1]).slice(0,8);
  let html='';
  if(topTags.length){
    html+=`<div class="sec-title">Build Tags</div><div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:5px">`;
    topTags.forEach(([t,c])=>html+=`<span class="tag t-${t}">${t} Ã—${c}</span>`);
    html+=`</div>`;
  }
  const axioms=G.boons.filter(b=>b.rarity==='axiom');
  if(axioms.length){
    html+=`<div class="sec-title">Active Runes</div>`;
    axioms.forEach(b=>{
      html+=`<div style="background:#120a1e;border:1px solid #7a20b0;border-radius:4px;padding:5px 8px;margin:2px 0">
        <div style="font-size:11px;font-weight:700;color:#d050ff">${b.icon} ${b.name.replace('RUNE: ','')}</div>
        <div style="font-size:10px;color:#9060c0;margin-top:2px">${b.desc}</div>
      </div>`;
    });
  }
  if(G.boons.length){
    const rc={common:'#6060a0',uncommon:'#50a050',rare:'#6060d8',epic:'#a040c0',legendary:'#d4a017',axiom:'#d050ff'};
    html+=`<div class="sec-title">Rune-Gifts</div>`;
    G.boons.forEach(b=>html+=`<div style="margin:2px 0;font-size:11px" title="${b.desc}"><span style="color:${rc[b.rarity]||'#888'}">${b.icon}</span> ${b.name}</div>`);
  }
  document.getElementById('right-content').innerHTML=html||`<div style="color:var(--txt3);font-size:11px;margin-top:8px">No Rune-Gifts yet.</div>`;
}

function renderCenter(){
  if(!G)return;
  const el=document.getElementById('center-content');
  if(G.phase==='WAVE_PREVIEW')el.innerHTML=renderWavePreview();
  else if(G.phase==='BATTLE')el.innerHTML=renderBattle();
  else if(G.phase==='REWARDS')el.innerHTML=renderRewards();
  else if(G.phase==='GAME_OVER'||G.phase==='VICTORY')el.innerHTML=renderEndScreen();
}

function renderWavePreview(){
  const isBoss=G.bossWaves.includes(G.wave);
  const ep=G.enemies.reduce((s,e)=>s+e.hp/8+e.atk*1.8+e.def*.8,0);
  const hp=G.hero.maxHP/8+G.hero.atk*1.8+G.hero.def*.8+G.boons.length*15;
  const diff=Math.min(5,Math.max(1,Math.ceil(ep/Math.max(1,hp)*2)));
  const diffColors=['#50a050','#80a030','#a08030','#a04020','#c01010'];
  const diffLabels=['Trivial','Easy','Moderate','Hard','Brutal'];

  let h=`<div class="slide-in" style="padding:16px">`;
  if(G.retireAvailable){
    h+=`<div class="retire-banner">
      <div class="retire-banner-title">ðŸ› RETIREMENT OPPORTUNITY</div>
      <div style="font-size:11px;color:var(--txt2);margin-bottom:8px">End your saga now and send ${G.hero.record?.name||'your hero'} to the Chosen of the Hall. Convert saga progress into genetic strength for future generations.</div>
      <button class="btn btn-gold btn-sm" onclick="showRetireConfirm()">ðŸ› Retire Hero</button>
    </div>`;
  }
  h+=`<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
    <div style="font-family:'Orbitron',sans-serif;font-size:18px;font-weight:900;color:${isBoss?'var(--amber)':'var(--cyan)'}">${isBoss?'â­ BOSS â€” ':''}Trial ${G.wave}</div>
    <div style="display:flex;gap:3px;align-items:center">
      ${Array(5).fill(0).map((_,i)=>`<div class="diff-pip${i<diff?' dp-on':''}" ${i<diff?`style="background:${diffColors[diff-1]};border-color:${diffColors[diff-1]}"`:''}></div>`).join('')}
      <span style="font-size:11px;color:${diffColors[diff-1]};margin-left:5px;font-weight:700">${diffLabels[diff-1]}</span>
    </div>
  </div>`;

  if(G.waveTraits.length){
    h+=`<div class="sec-title">Omens</div>`;
    G.waveTraits.forEach(t=>{
      h+=`<div class="trait-card"><div class="ticon">${t.icon}</div><div><div class="tname">${t.name}</div><div class="tdesc">${t.desc}</div></div></div>`;
    });
    h+=`<div style="height:8px"></div>`;
  }

  const activeTier=G.ragnarÃ¶kActive||0;
  if(activeTier>0){
    const activeTiers=RAGNARÃ–K_TIERS.slice(0,activeTier);
    h+=`
      <div class="sec-title" style="margin-top:10px">
        ${rootDepthIcon(activeTier)} Root Depth ${activeTier} â€” Active Omens
        <button onclick="
          var tl=document.getElementById('tier-list-wave');
          tl.style.display=(tl.style.display==='none'?'block':'none');
        " style="float:right;background:none;border:none;color:var(--txt3);cursor:pointer;font-size:10px;margin-top:2px">
          Show/Hide
        </button>
      </div>
      <div id="tier-list-wave" style="display:none;margin-bottom:8px">
        ${activeTiers.map(t=>`
          <div style="font-size:10px;color:var(--txt3);margin:2px 0;padding:3px 6px;
                      background:var(--bg2);border-radius:3px;border-left:2px solid var(--border2)">
            <span style="color:var(--amber);font-weight:700">${t.tier}.</span>
            ${t.name} â€” <em>${t.omen}</em>
          </div>
        `).join('')}
      </div>
    `;
  }


  // Tactics (cost paid when you start the trial)
  if(G.tacticOffers && G.tacticOffers.length){
    h+=`<div class="sec-title">Tactics</div>`;
    h+=`<div class="tactic-grid">`+G.tacticOffers.map(t=>{
      const affordable = (G.gold>=t.cost);
      const sel = (G.pendingTactic===t.id);
      const cls = `tactic-card${sel?' sel':''}${!affordable?' disabled':''}`;
      const on = affordable ? `selectPendingTactic('${t.id}')` : '';
      return `<div class="${cls}" ${on?`onclick="${on}"`:''} title="${t.desc}">
        <div class="tactic-top">
          <div class="tactic-name">${t.icon} ${t.name}</div>
          <div class="tactic-cost">á›‹${t.cost}</div>
        </div>
        <div class="tactic-desc">${t.desc}</div>
      </div>`;
    }).join('')+`</div>`;
    if(G.pendingTactic){
      const t=TACTIC_BY_ID[G.pendingTactic];
      if(t){
        h+=`<div class="tactic-note"><span class="tactic-pill">Selected: ${t.icon} ${t.name} Â· costs á›‹${t.cost} on start</span>
          <button class="btn btn-sm" style="margin-left:8px;background:var(--bg2);border:1px solid var(--border2);color:var(--txt2)" onclick="clearPendingTactic()">Clear</button>
        </div>`;
      }
    } else {
      h+=`<div class="tactic-note">Pick one tactic (you pay when you start the trial).</div>`;
    }
    h+=`<div style="height:10px"></div>`;
  }

  h+=`<div class="sec-title">Enemy Lineup (${G.enemies.length} units)</div>`;
  G.enemies.forEach(e=>{
    const rootBorder=e.rootTouched?'border-color:#4a1a6a;background:#0e0818;box-shadow:0 0 8px rgba(100,20,140,.3)':'';
    h+=`<div class="enemy-card${e.elite?' ec-elite':''}" style="${rootBorder}">
      <div class="eicon" style="background:${e.col}22;border:1px solid ${e.col}55">${e.icon}</div>
      <div class="einfo">
        <div class="ename" style="color:${e.elite?'var(--amber)':'var(--txt)'}">
          ${e.displayName||e.name}
          ${e.namedElite?'<span style="font-size:9px;color:var(--amber);margin-left:6px;font-style:italic">â€” A familiar name returns.</span>':''}
        </div>
        <div class="etrait">â—ˆ ${e.norseName?`<em style="color:var(--txt3)">${e.norseName}</em> â€” `:''}${e.trait}: ${e.td}</div>
        <div class="estats">HP:${e.hp} ATK:${e.atk} DEF:${e.def} SPD:${e.spd}</div>
        ${e.signature?`<div style="font-size:10px;color:var(--amber);margin-top:3px;border-top:1px solid rgba(240,168,40,.2);padding-top:3px">â­ ${e.signature.name}: ${e.signature.desc}</div>`:''}
      </div>
    </div>`;
  });
  h+=`</div>`;
  return h;
}

function renderBattle(){
  const alive=G.enemies.filter(e=>!e.dead),dead=G.enemies.filter(e=>e.dead);
  let h=`<div style="padding:12px">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
      <span style="font-weight:800;font-size:14px;color:var(--red)" class="pulse">âš” BATTLE â€” TRIAL ${G.wave}</span>
    </div>`;

  alive.forEach(e=>{
    const hp=Math.max(0,e.hp/e.maxHP*100),shv=e.statuses.shield,shpct=shv?Math.min(100-hp,shv.value/e.maxHP*100):0;
    const sbs=Object.entries(e.statuses).filter(([k])=>e.statuses[k]&&k!=='shield'&&e.statuses[k].stacks>0);
    h+=`<div class="enemy-card${e.elite?' ec-elite':''}${e.rootTouched?' ec-root-touched':''}">
      <div class="eicon" style="background:${e.col}22;border:1px solid ${e.col}55">${e.icon}</div>
      <div class="einfo">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="ename" style="color:${e.elite?'var(--amber)':'var(--txt)'}">${e.displayName||e.name}</div>
          <div style="font-size:10px;color:var(--txt3);font-family:'Share Tech Mono',monospace">${e.hp}/${e.maxHP}${shv?' ðŸ›¡'+shv.value:''}</div>
        </div>
        <div class="ehpbar" style="position:relative">
          <div class="ehpfill" style="width:${hp}%"></div>
          ${shv?`<div style="position:absolute;top:0;left:${hp}%;width:${shpct}%;height:100%;background:rgba(72,120,240,.5)"></div>`:''}
        </div>
        ${sbs.length?`<div style="margin-top:3px">${sbs.map(([k,s])=>{const sd=STATUS[k];return sd?`<span class="sbadge ${sd.cls}" style="font-size:9px;padding:1px 4px">${sd.icon}${s.stacks>1?' Ã—'+s.stacks:''}</span>`:''}).join('')}</div>`:''}
      </div>
    </div>`;
  });

  if(dead.length){
    h+=`<div style="margin-top:4px;opacity:.3">${dead.map(e=>`<div style="font-size:11px;color:var(--txt3);padding:1px">â˜  ${e.name}</div>`).join('')}</div>`;
  }

  h+=`</div>`;
  return h;
}

function renderRewards(){
  const shop=[
    {id:'heal',icon:'ðŸ’š',name:'Heal',cost:20,desc:'Restore 36% HP'},
    {id:'atk',icon:'âš”',name:'+ATK',cost:14,desc:'+7 Attack'},
    {id:'def',icon:'ðŸ›¡',name:'+DEF',cost:12,desc:'+5 Defense'},
    {id:'hp',icon:'â¤',name:'+HP',cost:10,desc:'+28 MaxHP'},
    {id:'spd',icon:'ðŸ’¨',name:'+SPD',cost:15,desc:'+10 Speed'},
    {id:'crit',icon:'ðŸŽ¯',name:'+CRIT',cost:20,desc:'+6% Crit'},
  ];
  const hpPct=Math.max(0,G.hero.hp/G.hero.maxHP*100);
  const showForge=!!(G.forgeStallItem||hasSunderedGear());
  let h=`<div class="slide-in" style="padding:16px">
    <div style="font-size:16px;font-weight:800;color:var(--green);margin-bottom:12px">ðŸ† Trial ${G.wave} Complete!</div>
    <div style="display:grid;grid-template-columns:1fr 1fr${showForge?' 1fr':''};gap:14px">`;

  h+=`<div>
    <div class="sec-title">á›‹ Offerings (á›‹${G.gold} Saga-Marks)</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px">
      ${shop.map(s=>`<div class="shop-btn${G.gold<s.cost?' sb-disabled':''}" onclick="shopBuy('${s.id}')" title="${s.desc}">
        <div class="sb-name">${s.icon} ${s.name}</div><div class="sb-cost">á›‹${s.cost}</div><div class="sb-desc">${s.desc}</div>
      </div>`).join('')}
    </div>
    ${(()=>{
      if(!(G.tierFlags&&G.tierFlags.cursedBargainInShop&&!G.cursedBargainUsedThisWave))return '';
      const bargain=G._waveBargainOffer||(G._waveBargainOffer=rpick(CURSED_BARGAINS));
      return `
        <div style="margin-top:10px;border-top:1px solid rgba(220,60,20,.3);padding-top:10px">
          <div class="sec-title" style="color:var(--amber)">âš  The Norns Offer a Bargain</div>
          <div style="background:#120a06;border:1px solid rgba(220,60,20,.4);border-radius:5px;padding:10px;margin:4px 0">
            <div style="font-weight:700;color:var(--amber);margin-bottom:3px">${bargain.icon} ${bargain.name}</div>
            <div style="font-size:11px;color:var(--txt2);margin-bottom:8px">${bargain.desc}</div>
            <button class="btn btn-sm btn-danger${(!bargain.isFree&&G.gold<bargain.cost)?' sb-disabled':''}" onclick="takeCursedBargain('${bargain.id}')">Accept${bargain.isFree?'':` (á›‹${bargain.cost})`}</button>
          </div>
        </div>
      `;
    })()}
    <div style="margin-top:8px;font-size:10px;color:var(--txt3)">HP: <span style="color:${hpPct>60?'var(--green)':hpPct>30?'var(--amber)':'var(--red)'}">${G.hero.hp}/${G.hero.maxHP} (${Math.round(hpPct)}%)</span></div>
  </div>`;

  h+=`<div>
    <div class="sec-title">ðŸ“œ Rune-Gift Draft â€” Choose one omen.</div>
    ${G.draft.length?G.draft.map(b=>`
      <div class="boon-card rc-${b.rarity}" onclick="pickBoon('${b.id}')" style="margin-bottom:6px">
        <div class="boon-rar rar-${b.rarity}">${b.rarity.toUpperCase()}</div>
        <div><span style="font-size:14px">${b.icon}</span> <span class="boon-name">${b.name}</span></div>
        <div class="boon-desc" style="margin-top:3px">${b.desc}</div>
        <div style="display:flex;flex-wrap:wrap;gap:2px;margin-top:4px">${b.tags.map(t=>`<span class="tag t-${t}">${t}</span>`).join('')}</div>
      </div>`).join(''):`<div style="color:var(--txt3);font-size:12px">No more Rune-Gifts!</div>`}
    ${G.draft.length?`<button class="btn btn-sm btn-ghost" style="width:100%;margin-top:4px" onclick="doReroll()">ðŸ”® Seek Another Omen (á›‹${G.rerollCost})${G.gold<G.rerollCost?' â€” need Saga-Marks':''}</button>`:''}
  </div>`;

  if(showForge){
    h+=`<div>
      <div class="sec-title">âš’ Forge Stall</div>
      ${G.forgeStallItem?`
        <div style="background:var(--bg2);border:1px solid ${rarityBorderColor(G.forgeStallItem.rarity)};border-radius:5px;padding:10px;margin-bottom:8px">
          <div style="font-size:9px;font-weight:700;color:${rarityColor(G.forgeStallItem.rarity)};margin-bottom:3px">${G.forgeStallItem.rarity.toUpperCase()}</div>
          <div style="font-weight:700;font-size:12px">${G.forgeStallItem.name}</div>
          ${G.forgeStallItem.loreNote?`<div style="font-size:9px;color:var(--txt3);font-style:italic;margin-top:2px">${G.forgeStallItem.loreNote}</div>`:''}
          <div style="font-size:10px;color:var(--txt2);margin-top:4px">${G.forgeStallItem.affixes.map(a=>a.label).join(' Â· ')}</div>
          <div style="font-size:9px;color:var(--txt3);margin-top:3px">Slot: ${G.forgeStallItem.slot.toUpperCase()}${G.hero.gear&&G.hero.gear[G.forgeStallItem.slot]?` Â· Replaces: ${G.hero.gear[G.forgeStallItem.slot].name}`:' Â· Slot empty'}</div>
          <button class="btn btn-sm btn-amber${G.gold<gearCost(G.forgeStallItem)?' sb-disabled':''}" style="margin-top:8px;width:100%" onclick="buyGear()">Equip (á›‹${gearCost(G.forgeStallItem)})</button>
        </div>
      `:'<div style="font-size:11px;color:var(--txt3)">Nothing forged this trial.</div>'}
      ${hasSunderedGear()?`
        <div style="margin-top:8px;border-top:1px solid var(--border);padding-top:8px">
          <div style="font-size:10px;color:var(--amber);font-weight:700;margin-bottom:4px">âš’ Recondition</div>
          ${Object.entries(G.hero.gear||{}).filter(([s,item])=>item?.sundered).map(([slot,item])=>`
            <div style="margin:4px 0;font-size:11px;display:flex;justify-content:space-between;align-items:center">
              <span style="color:var(--amber)">${item.name}</span>
              <button class="btn btn-sm btn-salvage${META.salvage<10?' sb-disabled':''}" onclick="reconditionGear('${slot}')">áš±10</button>
            </div>
          `).join('')}
        </div>
      `:''}
    </div>`;
  }

  h+=`</div></div>`;
  return h;
}

function renderEndScreen(){
  const won=G.phase==='VICTORY';
  const rec=G.hero.record;
  const tagCounts={};G.boons.forEach(b=>b.tags.forEach(t=>{tagCounts[t]=(tagCounts[t]||0)+1;}));
  const topTags=Object.entries(tagCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const score=G.level*50+G.boons.length*30+(won?300:0)+G.wave*20;

  const heroName=rec?.name||'the Champion';
  const outcomeHeader=won?'â­ SAGA COMPLETE':'â˜  SAGA CLOSED';
  const outcomeColor=won?'var(--gold)':'var(--red)';
  const outcomeShadow=won?'rgba(212,160,23,.6)':'rgba(224,64,64,.5)';
  const outcomeSubtext=won
    ? `All twelve trials survived. The Allfather's wager holds. ${heroName} may now rest.`
    : `Trial ${G.wave} â€” ${heroName}'s saga ends here. The thread passes to the next.`;

  return `<div class="slide-in" style="padding:24px;text-align:center">
    <div style="font-family:'Orbitron',sans-serif;font-size:22px;font-weight:900;
                color:${outcomeColor};text-shadow:0 0 20px ${outcomeShadow};margin-bottom:8px">
      ${outcomeHeader}
    </div>
    <div style="color:var(--txt2);margin-bottom:16px;font-size:12px;font-style:italic">
      ${outcomeSubtext}
    </div>
    <div style="display:inline-block;background:var(--bg2);border:1px solid var(--border2);border-radius:6px;padding:14px 20px;margin-bottom:16px;text-align:left;min-width:260px">
      <div style="font-size:10px;color:var(--txt3);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px">Saga Summary</div>
      <div style="display:flex;justify-content:space-between;margin:3px 0;font-size:12px"><span style="color:var(--txt3)">Trials Survived</span><span style="font-weight:700">${G.wave}/${G.maxWaves}</span></div>
      <div style="display:flex;justify-content:space-between;margin:3px 0;font-size:12px"><span style="color:var(--txt3)">Hero Level</span><span style="font-weight:700">${G.level}</span></div>
      <div style="display:flex;justify-content:space-between;margin:3px 0;font-size:12px"><span style="color:var(--txt3)">Rune-Gifts</span><span style="font-weight:700">${G.boons.length}</span></div>
      <div style="display:flex;justify-content:space-between;margin:3px 0;font-size:12px"><span style="color:var(--txt3)">Score</span><span style="font-weight:700;color:var(--gold)">${score}</span></div>
      ${rec?.traits?.length?`<div style="margin-top:8px;border-top:1px solid var(--border);padding-top:6px;display:flex;flex-wrap:wrap;gap:2px">${rec.traits.map(tk=>{const gt=GTRAITS[tk];return gt?`<span class="gtrait">${gt.icon} ${gt.name}</span>`:''}).join('')}</div>`:''}
      ${topTags.length?`<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:2px">${topTags.map(([t,c])=>`<span class="tag t-${t}">${t} Ã—${c}</span>`).join('')}</div>`:''}
    </div>
    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
      <button class="btn btn-gold" onclick="showLegacy()">ðŸ› View Legacy</button>
      <button class="btn btn-primary" onclick="showStartScreen()">â–¶ Begin New Saga</button>
    </div>
  </div>`;
}

function renderFooter(){
  if(!G)return;
  const ftr=document.getElementById('ftr-btns'),info=document.getElementById('ftr-info');
  if(G.phase==='WAVE_PREVIEW'){
    ftr.innerHTML=`<button class="btn btn-primary" onclick="startBattle()">âš” Begin Trial ${G.wave}</button>`;
    info.textContent=`á›‹ ${G.gold} ${LEX.sagaMarks} Â· ${G.wave<G.maxWaves?'Next: Trial '+(G.wave+1):'Final Trial!'}`;
  }else if(G.phase==='BATTLE'){
    ftr.innerHTML=`<span style="color:var(--txt3);font-size:12px;animation:pulse2 1.2s infinite">âš” Battle in progress...</span>`;
    info.textContent=`Tick:${G.tick} Â· Enemies:${G.enemies.filter(e=>!e.dead).length}/${G.enemies.length}`;
  }else if(G.phase==='REWARDS'){
    ftr.innerHTML=`<span style="color:var(--txt3);font-size:12px">Choose a Rune-Gift or use the offerings.</span>`;
    info.textContent=`á›‹ ${G.gold}`;
  }else{
    ftr.innerHTML='';info.textContent='';
  }
}

// â•â•â• LEGACY SCREEN â•â•â•
let currentLegacyTab='pool';
function showLegacy(){
  closeDrawers();
  document.getElementById('legacy-screen').style.display='flex';
  setLegacyTab(currentLegacyTab);
  updateMetaHeader();
  syncChromeHeights();
}
function hideLegacy(){
  document.getElementById('legacy-screen').style.display='none';
  closeDrawers();
  syncChromeHeights();
}
function setLegacyTab(tab){
  currentLegacyTab=tab;
  ['pool','breed','fallen','tree','upgrades','codex'].forEach(t=>{
    document.getElementById('ltab-'+t).className='ltab'+(t===tab?' active':'');
  });
  const lc=document.getElementById('legacy-content');
  if(tab==='pool')lc.innerHTML=renderRetiredPool();
  else if(tab==='breed')lc.innerHTML=renderBreeding();
  else if(tab==='fallen')lc.innerHTML=renderFallenLedger();
  else if(tab==='tree')renderFamilyTree();
  else if(tab==='upgrades')lc.innerHTML=renderRunesmith();
  else if(tab==='codex')lc.innerHTML=codexHTML();
}

// â”€â”€â”€ RETIRED POOL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function evColor(k){return{hp:'#40e078',atk:'#f0a828',def:'#4878f0',spd:'#c080ff',crit:'#f0a828',eva:'#30d0c0',acc:'#30d0c0',ls:'#d070d8'}[k]||'#888';}

function toggleBreedSelect(id){
  const idx=BREED_SELECTED.indexOf(id);
  if(idx>=0)BREED_SELECTED.splice(idx,1);
  else{if(BREED_SELECTED.length>=2)BREED_SELECTED.shift();BREED_SELECTED.push(id);}
  setLegacyTab('pool');
}

function renderRetiredPool(){
  const heroes=META.retiredPool.map(id=>META.family[id]).map(r=>{if(r){const u=getBreedUses(r);if(typeof r.breedUsesMax!=='number' || r.breedUsesMax<=0){r.breedUsesMax=u.max; r.breedUsesLeft=u.left;} } return r;}).filter(r=>r && canHeroBreed(r.id));
  if(!heroes.length){
    return `<div style="text-align:center;padding:40px;color:var(--txt3)">
      <div style="font-size:32px;margin-bottom:12px">ðŸ›</div>
      <div style="font-size:13px">No retired heroes yet.</div>
      <div style="font-size:11px;margin-top:6px">Complete a saga and choose to retire your hero instead of fighting on.</div>
    </div>`;
  }
  let h=`<div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div>
        <div style="font-size:16px;font-weight:700;color:var(--gold)">Chosen of the Hall</div>
        <div style="font-size:11px;color:var(--txt3);margin-top:2px">${heroes.length}/${poolMax()} heroes Â· Select two to breed</div>
      </div>
      <button class="btn btn-green btn-sm" onclick="setLegacyTab('breed')">âš— Breed â†’</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px">`;
  heroes.forEach(rec=>{
    const sel=BREED_SELECTED.includes(rec.id);
    const selIdx=BREED_SELECTED.indexOf(rec.id);
    const selClass=selIdx===0?' hc-parent-a':selIdx===1?' hc-parent-b':'';
    const derived=evDerived(rec.evs);
    const uses=getBreedUses(rec);
    h+=`<div class="hero-card${sel?selClass:''}" onclick="toggleBreedSelect('${rec.id}')">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:5px">
        <div>
          <div class="hc-gen">GEN ${rec.gen}${sel?' â€” PARENT '+(selIdx===0?'A':'B'):''}</div>
          <div class="hc-name">${rec.name}</div>
        </div>
        ${sel?`<div style="font-size:18px;color:${selIdx===0?'#4878f0':'var(--violet)'}">â˜…</div>`:''}
        <button onclick="removeFromRetiredPool(event,'${rec.id}')" title="Remove from pool" style="background:rgba(224,64,64,.12);border:1px solid rgba(224,64,64,.35);color:var(--red);padding:2px 6px;border-radius:4px;font-size:10px;cursor:pointer">âœ•</button>
      </div>
      <div class="hc-stats">HP:${derived.maxHP} ATK:${Math.round(derived.atk)} DEF:${Math.round(derived.def)} SPD:${derived.spd}</div>
      <div class="hc-stats">CRIT:${Math.round(derived.critChance*100)}% EVA:${Math.round(derived.evasion*100)}%</div>
      <div class="hc-stats" style="margin-top:3px">Breeds left: <span style="color:var(--gold);font-weight:800">${uses.left}/${uses.max}</span></div>
      ${rec.equippedGear&&Object.values(rec.equippedGear).some(Boolean)?`<div style="font-size:9px;color:var(--txt3);margin-top:4px">âš’ ${Object.values(rec.equippedGear).filter(Boolean).map(i=>`<span style="color:${rarityColor(i.rarity)}">${i.name}</span>`).join(', ')} bequeathed</div>`:''}
      ${rec.traits.length?`<div style="display:flex;flex-wrap:wrap;gap:2px;margin-top:5px">${rec.traits.map(tk=>{const gt=GTRAITS[tk];return gt?`<span class="gtrait" title="${gt.desc}">${gt.icon} ${gt.name}</span>`:''}).join('')}</div>`:''}
      <div style="margin-top:8px">
        ${EV_KEYS.map(k=>`<div style="display:flex;align-items:center;gap:5px;margin:2px 0">
          <div style="font-size:9px;color:var(--txt3);width:28px;text-transform:uppercase">${k}</div>
          <div class="ev-bar" style="flex:1"><div class="ev-fill" style="width:${Math.round((rec.evs[k]||0)/evCap()*100)}%;background:${evColor(k)}"></div></div>
          <div style="font-size:9px;color:var(--txt3);width:22px;text-align:right">${rec.evs[k]||0}</div>
        </div>`).join('')}
      </div>
      ${rec.runResult?`<div style="font-size:10px;color:var(--txt3);margin-top:5px;border-top:1px solid var(--border);padding-top:4px">Trial ${rec.runResult.wave} Â· ${rec.runResult.boons?.length||0} Rune-Gifts Â· Lv.${rec.runResult.level||1}</div>`:''}
    </div>`;
  });
  h+=`</div></div>`;
  return h;
}

// â”€â”€â”€ BREEDING PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBreeding(){
  if(BREED_SELECTED.length<2){
    return `<div style="text-align:center;padding:40px;color:var(--txt3)">
      <div style="font-size:32px;margin-bottom:12px">âš—</div>
      <div style="font-size:13px">Select two heroes from the Chosen of the Hall first.</div>
      <button class="btn btn-gold btn-sm" style="margin-top:14px" onclick="setLegacyTab('pool')">â† Chosen of the Hall</button>
    </div>`;
  }
  const recA=META.family[BREED_SELECTED[0]],recB=META.family[BREED_SELECTED[1]];
  if(!recA||!recB||isFallenHero(recA.id)||isFallenHero(recB.id))return `<div style="color:var(--red);padding:20px">A fallen hero cannot enter the Breeding Chamber. Their saga is closed.</div>`;
  const usesA=getBreedUses(recA), usesB=getBreedUses(recB);

  const cap=evCap();
  const previewEVs={};EV_KEYS.forEach(k=>previewEVs[k]=Math.min(cap,Math.round(((recA.evs[k]||0)+(recB.evs[k]||0))/2)));
  const derived=evDerived(previewEVs);
  const sharedTraits=recA.traits.filter(t=>recB.traits.includes(t));
  const allTraits=[...new Set([...recA.traits,...recB.traits])];

  let h=`<div>
    <div style="font-size:11px;color:var(--txt3);font-style:italic;margin-bottom:12px">
      You choose the next thread.
    </div>
    <div style="font-size:16px;font-weight:700;color:var(--gold);margin-bottom:16px">âš— Breeding Chamber</div>
    <div style="display:grid;grid-template-columns:1fr 40px 1fr;gap:10px;align-items:center;margin-bottom:20px">
      <div class="child-preview" style="background:rgba(72,120,240,.08);border-color:rgba(72,120,240,.4)">
        <div style="font-size:10px;color:#80a8ff;letter-spacing:2px;margin-bottom:5px">PARENT A</div>
        <div style="font-weight:700;font-size:14px">${recA.name}</div>
        <div style="font-size:10px;color:var(--txt3)">Gen ${recA.gen}</div><div style="font-size:10px;color:var(--txt3);margin-top:2px">Breeds left: <span style="color:#80a8ff;font-weight:800">${usesA.left}/${usesA.max}</span></div>
        <div style="margin-top:5px;display:flex;flex-wrap:wrap;gap:2px">${recA.traits.map(tk=>{const gt=GTRAITS[tk];return gt?`<span class="gtrait">${gt.icon}</span>`:''}).join('')}</div>
      </div>
      <div style="text-align:center;font-size:20px;color:var(--violet)">âš—</div>
      <div class="child-preview" style="background:rgba(144,80,232,.08);border-color:rgba(144,80,232,.4)">
        <div style="font-size:10px;color:#c080ff;letter-spacing:2px;margin-bottom:5px">PARENT B</div>
        <div style="font-weight:700;font-size:14px">${recB.name}</div>
        <div style="font-size:10px;color:var(--txt3)">Gen ${recB.gen}</div><div style="font-size:10px;color:var(--txt3);margin-top:2px">Breeds left: <span style="color:#c080ff;font-weight:800">${usesB.left}/${usesB.max}</span></div>
        <div style="margin-top:5px;display:flex;flex-wrap:wrap;gap:2px">${recB.traits.map(tk=>{const gt=GTRAITS[tk];return gt?`<span class="gtrait">${gt.icon}</span>`:''}).join('')}</div>
      </div>
    </div>

    <div class="child-preview" style="margin-bottom:20px">
      <div style="font-size:11px;color:var(--violet);letter-spacing:2px;margin-bottom:8px">CHILD PREVIEW (approximate)</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <div style="font-size:10px;color:var(--txt3);margin-bottom:6px">DERIVED STATS</div>
          ${[['MaxHP',derived.maxHP],['ATK',Math.round(derived.atk)],['DEF',Math.round(derived.def)],['SPD',derived.spd],['Crit',Math.round(derived.critChance*100)+'%'],['Eva',Math.round(derived.evasion*100)+'%']]
            .map(([l,v])=>`<div class="srow"><span class="sl" style="font-size:11px">${l}</span><span class="sv" style="font-size:11px">${v}</span></div>`).join('')}
        </div>
        <div>
          <div style="font-size:10px;color:var(--txt3);margin-bottom:6px">EV INHERITANCE</div>
          ${EV_KEYS.map(k=>`<div style="display:flex;align-items:center;gap:4px;margin:2px 0">
            <div style="font-size:9px;color:var(--txt3);width:26px;text-transform:uppercase">${k}</div>
            <div class="ev-bar" style="flex:1"><div class="ev-fill" style="width:${Math.round(previewEVs[k]/cap*100)}%;background:${evColor(k)}"></div></div>
            <div style="font-size:9px;color:var(--txt3);width:20px;text-align:right">~${previewEVs[k]}</div>
          </div>`).join('')}
        </div>
      </div>

      <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:10px">
        <div style="font-size:10px;color:var(--txt3);margin-bottom:5px">TRAIT INHERITANCE CHANCES</div>
        <div style="display:flex;flex-wrap:wrap;gap:5px">
          ${allTraits.map(tk=>{
            const gt=GTRAITS[tk];if(!gt)return '';
            const shared=sharedTraits.includes(tk);
            const ch=shared?.75:.45;
            return `<div style="background:rgba(160,80,220,.15);border:1px solid rgba(160,80,220,.3);border-radius:3px;padding:4px 8px;font-size:10px">
              <span style="color:#d090ff">${gt.icon} ${gt.name}</span>
              <span style="color:var(--txt3);margin-left:6px">${Math.round(ch*100)}%${shared?' (shared)':''}</span>
            </div>`;
          }).join('')}
          <div style="background:rgba(40,180,80,.1);border:1px solid rgba(40,180,80,.3);border-radius:3px;padding:4px 8px;font-size:10px;color:var(--green)">ðŸ§¬ Mutation ${Math.round(mutationRate()*100)}%</div>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:10px;align-items:center">
      <button class="btn btn-primary" onclick="doBreed()">âš— Begin Breeding</button>
      <button class="btn btn-sm btn-ghost" onclick="BREED_SELECTED=[];setLegacyTab('pool')">âœ• Clear Selection</button>
    </div>
  </div>`;
  return h;
}

function doBreed(){
  if(BREED_SELECTED.length<2){alert('Select 2 heroes first.');return;}
  const a=BREED_SELECTED[0], b=BREED_SELECTED[1];
  const ua=getBreedUses(META.family[a]), ub=getBreedUses(META.family[b]);
  if(ua.left<=0||ub.left<=0){alert('One of the selected parents has no breeding uses left.');return;}
  const childRec=breedHeroes(a,b);
  if(!childRec)return;
  consumeBreedUse(a);
  consumeBreedUse(b);
  saveMeta();
  BREED_SELECTED=[];
  const lc=document.getElementById('legacy-content');
  const derived=evDerived(childRec.evs);
  lc.innerHTML=`<div class="slide-in" style="text-align:center;padding:30px">
    <div style="font-size:22px;margin-bottom:8px">ðŸ§¬</div>
    <div style="font-family:'Orbitron',sans-serif;font-size:18px;font-weight:900;color:var(--violet);margin-bottom:6px">${childRec.name}</div>
    <div style="color:var(--txt3);font-size:12px;margin-bottom:18px">Generation ${childRec.gen} Â· Born of legacy</div>
    <div style="display:inline-block;background:var(--bg2);border:1px solid var(--border2);border-radius:6px;padding:14px 20px;margin-bottom:18px;text-align:left;min-width:240px">
      <div style="font-size:10px;color:var(--txt3);letter-spacing:2px;margin-bottom:8px">GENETIC STATS</div>
      ${[['MaxHP',derived.maxHP],['ATK',Math.round(derived.atk)],['DEF',Math.round(derived.def)],['SPD',derived.spd],['Crit',Math.round(derived.critChance*100)+'%']]
        .map(([l,v])=>`<div class="srow"><span class="sl" style="font-size:12px">${l}</span><span class="sv" style="font-size:12px;color:var(--green)">${v}</span></div>`).join('')}
      ${childRec.traits.length?`<div style="margin-top:10px;border-top:1px solid var(--border);padding-top:8px;display:flex;flex-wrap:wrap;gap:3px">${childRec.traits.map(tk=>{const gt=GTRAITS[tk];return gt?`<span class="gtrait">${gt.icon} ${gt.name}</span>`:''}).join('')}</div>`:`<div style="margin-top:8px;color:var(--txt3);font-size:10px">No genetic traits inherited.</div>`}
    </div>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn btn-primary" onclick="hideLegacy();startWithChild('${childRec.id}')">â–¶ Continue Saga with ${childRec.name}</button>
      <button class="btn btn-sm btn-ghost" onclick="setLegacyTab('pool')">â† Back</button>
    </div>
  </div>`;
}

function inheritGearFromParent(childId,parentId){
  const parentRec=META.family[parentId];
  const childRec=META.family[childId];
  if(!parentRec||!childRec||isFallenHero(parentId))return;
  if(!parentRec.equippedGear)return;
  childRec.inheritedGear={};
  Object.entries(parentRec.equippedGear).forEach(([slot,item])=>{
    if(!item)return;
    const copy=JSON.parse(JSON.stringify(item));
    copy.sagaHistory=copy.sagaHistory||[];
    if(copy.sagaHistory.length>=3)copy.sagaHistory.shift();
    copy.sagaHistory.push(`Inherited by ${childRec.name}`);
    childRec.inheritedGear[slot]=copy;
  });
  META.family[childId]=childRec;
}

function startWithChild(heroId){
  const rec=META.family[heroId];if(!rec)return;
  if(rec.parentIds&&rec.parentIds.length){
    const bestParentId=rec.parentIds.reduce((best,pid)=>{
      const p=META.family[pid], b=META.family[best];
      const pWave=(p?.runResult?.wave||0), bWave=(b?.runResult?.wave||0);
      const pFallen=isFallenHero(pid), bFallen=isFallenHero(best);
      if(bFallen&&!pFallen)return pid;
      if(!bFallen&&pFallen)return best;
      return pWave>=bWave?pid:best;
    },rec.parentIds[0]);
    inheritGearFromParent(heroId,bestParentId);
  }
  initGame(null,rec.evs,rec.traits,rec);
}

// â”€â”€â”€ FALLEN LEDGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFallenLedger(){
  const fallen=META.fallenLedger.map(id=>META.family[id]).filter(Boolean).reverse();
  let h=`<div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div>
        <div style="font-size:16px;font-weight:700;color:var(--red)">áš± Fallen Saga</div>
        <div style="font-size:11px;color:var(--txt3);margin-top:2px">${fallen.length} fallen heroes Â· áš±${META.salvage} Rune-Shards available</div>
      </div>
    </div>`;
  if(!fallen.length){
    h+=`<div style="color:var(--txt3);font-size:12px;text-align:center;padding:30px">No fallen heroes yet. The lineage lives on.</div></div>`;
    return h;
  }
  h+=`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px">`;
  fallen.forEach(rec=>{
    const rr=rec.runResult||{};
    const sal=rr.salvageEarned||0;
    h+=`<div class="hero-card hc-dead">
      <div class="hc-gen">GEN ${rec.gen} Â· SAGA CLOSED</div>
      <div class="hc-name">â˜  ${rec.name}</div>
      <div style="font-size:10px;color:var(--txt3);font-style:italic;margin:3px 0">
        "What remained was taken by the root."
      </div>
      ${rec.traits.length?`<div style="display:flex;flex-wrap:wrap;gap:2px;margin:4px 0">${rec.traits.map(tk=>{const gt=GTRAITS[tk];return gt?`<span class="gtrait" style="font-size:9px">${gt.icon} ${gt.name}</span>`:''}).join('')}</div>`:''}
      <div class="hc-stats">Trial ${rr.wave||'?'} Â· ${(rr.boons?.length||0)} Rune-Gifts Â· Lv.${rr.level||1}</div>
      ${rr.axioms?.length?`<div style="font-size:10px;color:#d050ff;margin-top:3px">Runes: ${rr.axioms.length}</div>`:''}
      <div style="margin-top:8px;font-size:10px;color:var(--salvage)">+áš±${sal} Rune-Shards recovered</div>
    </div>`;
  });
  h+=`</div></div>`;
  return h;
}

const ELITE_NAME_PREFIXES={
  midgard:['Ulf','Bjorn','Sigr','Hrafn','Dag','Leif','Tor'],
  niflheim:['Grym','Skoll','Hati','Mist','Yng','Hvel'],
  jotunheim:['Thrym','Ymir','Berg','Sten','Fjord','Hymir'],
  muspelheim:['Brand','Eldr','Askr','Surla','Logi'],
  helheim:['NÃ¡l','Garm','Hod','VÃ¡nr'],
};
const ELITE_EPITHETS_BY_OUTCOME={
  barely:['the Unbroken','the Relentless','the Patient','the Stubborn'],
  crit:['the Exposed','the Unlucky','the Keen'],
  easy:['the Persistent','the Wary','the Watchful'],
  default:['the Remembered','the Scarred','the Returned','the Enduring'],
};
function generateEliteName(archId,lastOutcome){
  const arch=ARCHETYPES.find(a=>a.id===archId);
  const realm=arch?.realmTier||'midgard';
  const prefixPool=ELITE_NAME_PREFIXES[realm]||ELITE_NAME_PREFIXES.midgard;
  const prefix=rpick(prefixPool);
  const epithets=ELITE_EPITHETS_BY_OUTCOME[lastOutcome]||ELITE_EPITHETS_BY_OUTCOME.default;
  const epithet=rpick(epithets);
  return `${prefix} ${epithet}`;
}
function recordEliteEncounter(archId,playerSurvived,wasNearDeath,critLanded){
  normalizeMeta();
  if(!META.eliteRoster[archId]){
    META.eliteRoster[archId]={name:generateEliteName(archId,'default'),survivedByPlayer:false,encounterCount:0,lastOutcome:'default'};
  }
  const entry=META.eliteRoster[archId];
  entry.encounterCount++;
  if(playerSurvived){
    entry.survivedByPlayer=true;
    let outcome='easy';
    if(wasNearDeath)outcome='barely';
    else if(critLanded)outcome='crit';
    entry.lastOutcome=outcome;
    entry.name=generateEliteName(archId,outcome);
  }
  saveMeta();
}
function checkForNamedEliteReturn(archId){
  const ragnarÃ¶kTier=META.ragnarÃ¶kActive||0;
  if(ragnarÃ¶kTier<10)return null;
  if(!G.tierFlags||!G.tierFlags.namedElitesActive)return null;
  const entry=META.eliteRoster[archId];
  if(!entry||!entry.survivedByPlayer)return null;
  const chance=0.12+(ragnarÃ¶kTier>=10?0.08:0);
  if(rng()>chance)return null;
  return entry;
}

// â”€â”€â”€ FAMILY TREE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFamilyTree(){
  const lc=document.getElementById('legacy-content');
  const allHeroes=Object.values(META.family);
  if(!allHeroes.length){
    lc.innerHTML=`<div style="text-align:center;padding:40px;color:var(--txt3)"><div style="font-size:32px;margin-bottom:12px">ðŸŒ³</div><div>No heroes in the lineage yet.</div></div>`;
    return;
  }
  const byGen={};
  allHeroes.forEach(h=>{const g=h.gen||0;(byGen[g]||(byGen[g]=[])).push(h);});
  const maxGen=Math.max(...Object.keys(byGen).map(Number));
  const NODE_W=130,NODE_H=80,GAP_X=160,GAP_Y=100,PAD=20;
  const pos={};
  for(let g=0;g<=maxGen;g++){
    const heroes=byGen[g]||[];
    heroes.forEach((h,i)=>{pos[h.id]={x:PAD+g*GAP_X,y:PAD+i*GAP_Y};});
  }
  const canvasW=PAD*2+(maxGen)*GAP_X+NODE_W;
  const canvasH=PAD*2+Math.max(...Object.values(byGen).map(a=>a.length))*GAP_Y+NODE_H;
  let svgLines='';
  allHeroes.forEach(h=>{
    if(h.parentIds){
      h.parentIds.forEach(pid=>{
        const pp=pos[pid],cp=pos[h.id];
        if(pp&&cp){
          const x1=pp.x+NODE_W/2,y1=pp.y+NODE_H/2;
          const x2=cp.x+NODE_W/2,y2=cp.y+NODE_H/2;
          svgLines+=`<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="rgba(144,80,232,.35)" stroke-width="1.5" stroke-dasharray="4,3"/>`;
        }
      });
    }
  });
  let nodes='';
  allHeroes.forEach(h=>{
    const p=pos[h.id];if(!p)return;
    const isInPool=META.retiredPool.includes(h.id);
    const isRetiredLike=!!(h.runResult && (h.runResult.outcome==='retired' || h.runResult.outcome==='victory'));
    const isSpentRetired=(isRetiredLike && !isInPool);
    const isRetired=isInPool;
    const isFallen=META.fallenLedger.includes(h.id);
    const cls=isRetired?'tn-retired':(isSpentRetired?'tn-spent':(isFallen?'tn-dead':''));
    const statusColor=isRetired?'var(--gold)':(isSpentRetired?'var(--txt2)':(isFallen?'var(--red)':'var(--txt3)'));
    const derived=evDerived(h.evs);
    nodes+=`<div class="tree-node ${cls}" style="left:${p.x}px;top:${p.y}px;width:${NODE_W}px" onclick="showHeroDetail('${h.id}')">
      <div style="font-size:9px;color:${statusColor};letter-spacing:1px">
        G${h.gen} ${isRetired ? 'â˜… Sealed' : (isSpentRetired ? 'â˜† Spent' : (isFallen ? 'â˜  Closed' : ''))}
      </div>
      <div style="font-size:11px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${h.name}</div>
      <div style="font-size:9px;color:var(--txt3);margin-top:2px">ATK:${Math.round(derived.atk)} DEF:${Math.round(derived.def)}</div>
      ${h.traits.length?`<div style="margin-top:3px">${h.traits.slice(0,2).map(tk=>{const gt=GTRAITS[tk];return gt?`<span style="font-size:10px">${gt.icon}</span>`:''}).join('')}</div>`:''}
    </div>`;
  });
  lc.innerHTML=`<div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div>
        <div style="font-size:16px;font-weight:700;color:var(--gold)">ðŸŒ³ Family Tree</div>
        <div style="font-size:11px;color:var(--txt3);margin-top:2px">${allHeroes.length} heroes across ${maxGen+1} generations</div>
      </div>
      <div style="font-size:10px;color:var(--txt3)"><span style="color:var(--gold)">â˜…</span> Sealed &nbsp; <span style="color:var(--txt2)">â˜†</span> Spent &nbsp; <span style="color:var(--red)">â˜ </span> Closed &nbsp; Click node for details</div>
    </div>
    <div style="position:relative;overflow:auto;background:var(--bg2);border:1px solid var(--border);border-radius:6px;min-height:200px">
      <svg style="position:absolute;top:0;left:0;width:${canvasW}px;height:${canvasH}px;pointer-events:none">${svgLines}</svg>
      <div style="position:relative;width:${canvasW}px;height:${canvasH}px">${nodes}</div>
    </div>
    <div id="hero-detail-panel" style="margin-top:14px"></div>
  </div>`;
}

function generateSagaPage(rec) {
  if (!rec || !rec.runResult) {
    return `${rec?.name || 'Unknown'} â€” Saga unwritten.`;
  }
  const rr      = rec.runResult;
  const outcome = rr.outcome;
  const wave    = rr.wave    || '?';
  const level   = rr.level   || 1;
  const boonCount  = rr.boons?.length  || 0;
  const axiomCount = rr.axioms?.length || 0;

  const tagCounts = {};
  (rr.boons || []).forEach(boonId => {
    const boon = BOONS.find(b => b.id === boonId);
    if (boon) boon.tags.forEach(t => { tagCounts[t] = (tagCounts[t] || 0) + 1; });
  });
  const topTag = Object.entries(tagCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || null;

  const topTrait = rec.traits?.[0] ? GTRAITS[rec.traits[0]]?.name : null;

  const gearItems = rec.equippedGear ? Object.values(rec.equippedGear).filter(Boolean) : [];
  const gearNote  = gearItems.length
    ? `Left behind ${gearItems.map(i => i.name).join(' and ')}.`
    : '';

  let harvestNote = '';
  if (rr.harvest) {
    if (rr.harvest.startsWith('scar:')) {
      const sk = rr.harvest.split(':')[1];
      harvestNote = `Scar of ${GTRAITS[sk]?.name || 'the fallen'} endures.`;
    } else if (rr.harvest.startsWith('relic:')) {
      harvestNote = 'Mastery preserved as Relic.';
    }
  }

  const tierNote = rec.ragnarÃ¶kStamp ? `Root Depth ${rec.ragnarÃ¶kStamp} witnessed.` : '';
  const relicNote = rec.relicType ? `Mastery sealed as ${rec.relicType.replace('relic_','').replace(/_/g,' ')}.` : '';

  const outcomePhrase = {
    'retired': `Chose to seal the saga at Trial ${wave}.`,
    'victory': `Survived all twelve trials.`,
    'fallen':  `Fell at Trial ${wave}.`,
  }[outcome] || `Saga ended at Trial ${wave}.`;

  const parts = [
    outcomePhrase,
    topTag    ? `Carried the ${topTag} path.`           : null,
    axiomCount > 0 ? `${axiomCount} Rune Law${axiomCount > 1 ? 's' : ''} learned.` : null,
    topTrait  ? `Blood of ${topTrait}.`                 : null,
    gearNote  || null,
    relicNote || harvestNote || null,
    tierNote  || null,
  ].filter(Boolean);

  return parts.join(' ');
}

function showHeroDetail(id){
  const rec=META.family[id];if(!rec)return;
  const derived=evDerived(rec.evs);
  const rr=rec.runResult||{};
  const sagaPage=generateSagaPage(rec);
  const isRetired=META.retiredPool.includes(id);
  const isFallen=META.fallenLedger.includes(id);
  const status=isRetired?'Retired â˜…':isFallen?'Fallen â˜ ':'Active';
  const statusColor=isRetired?'var(--gold)':isFallen?'var(--red)':'var(--cyan)';
  const gearItems=rec.equippedGear?Object.entries(rec.equippedGear).filter(([s,item])=>item):[];
  document.getElementById('hero-detail-panel').innerHTML=`<div class="slide-in" style="background:var(--bg2);border:1px solid var(--border2);border-radius:6px;padding:16px">
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div style="font-size:10px;color:var(--txt3)">Generation ${rec.gen} Â· <span style="color:${statusColor}">${status}</span></div>
        <div style="font-size:18px;font-weight:700;margin-top:2px">${rec.name}</div>
      </div>
      <button onclick="document.getElementById('hero-detail-panel').innerHTML=''" style="background:none;border:none;color:var(--txt3);cursor:pointer;font-size:16px">âœ•</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:12px">
      <div>
        <div style="font-size:10px;color:var(--txt3);margin-bottom:5px">DERIVED STATS</div>
        ${[['HP',derived.maxHP],['ATK',Math.round(derived.atk)],['DEF',Math.round(derived.def)],['SPD',derived.spd],['CRIT',Math.round(derived.critChance*100)+'%'],['EVA',Math.round(derived.evasion*100)+'%']]
          .map(([l,v])=>`<div class="srow"><span class="sl" style="font-size:11px">${l}</span><span class="sv" style="font-size:11px">${v}</span></div>`).join('')}
      </div>
      <div>
        <div style="font-size:10px;color:var(--txt3);margin-bottom:5px">EV PROFILE</div>
        ${EV_KEYS.map(k=>`<div style="display:flex;align-items:center;gap:4px;margin:2px 0">
          <div style="font-size:9px;color:var(--txt3);width:26px;text-transform:uppercase">${k}</div>
          <div class="ev-bar" style="flex:1"><div class="ev-fill" style="width:${Math.round((rec.evs[k]||0)/evCap()*100)}%;background:${evColor(k)}"></div></div>
          <div style="font-size:9px;color:var(--txt3);width:20px;text-align:right">${rec.evs[k]||0}</div>
        </div>`).join('')}
      </div>
      <div>
        <div style="font-size:10px;color:var(--txt3);margin-bottom:5px">TRAITS</div>
        ${rec.traits.length?rec.traits.map(tk=>{const gt=GTRAITS[tk];return gt?`<div class="gtrait" style="display:flex;margin:3px 0">${gt.icon} ${gt.name}</div>`:''}).join(''):`<div style="color:var(--txt3);font-size:11px">None</div>`}
        ${rr.wave?`<div style="margin-top:8px;border-top:1px solid var(--border);padding-top:6px">
          <div style="font-size:10px;color:var(--txt3)">Saga: Trial ${rr.wave} Â· ${(rr.boons?.length||0)} Rune-Gifts Â· Lv.${rr.level||1}</div>
          ${rr.axioms?.length?`<div style="font-size:10px;color:#d050ff;margin-top:2px">Runes: ${rr.axioms.length}</div>`:''}
        </div>`:''}
      </div>
    </div>
    <div style="margin-top:10px;font-size:10px;color:var(--txt3)">Parents: ${rec.parentIds?.length?rec.parentIds.map(pid=>META.family[pid]?.name||'Unknown').join(' Ã— '):'Founder hero'}</div>
    <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:10px">
      <div style="font-size:9px;color:var(--txt3);letter-spacing:2px;margin-bottom:4px">SAGA PAGE</div>
      <div style="font-size:11px;color:var(--txt2);font-style:italic;line-height:1.6">
        "${sagaPage}"
      </div>
    </div>
    ${gearItems.length?`
      <div style="margin-top:10px;border-top:1px solid var(--border);padding-top:8px">
        <div style="font-size:9px;color:var(--txt3);letter-spacing:2px;margin-bottom:5px">BEQUEATHED GEAR</div>
        ${gearItems.map(([slot,item])=>`
          <div style="font-size:10px;color:${rarityColor(item.rarity)};margin:3px 0">
            âš’ ${item.name}
            ${item.sagaHistory?.length?`<span style="color:var(--txt3);font-style:italic"> â€” "${item.sagaHistory[item.sagaHistory.length-1]}"</span>`:''}
            ${item.passiveBonus?`<span style="color:var(--green)"> Â· ${item.passiveBonus.label}</span>`:''}
          </div>
        `).join('')}
      </div>
    `:''}
  </div>`;
}

const CODEX_ENTRIES=[
  {id:'yggdrasil',term:'Yggdrasil',subtitle:'The World Tree',body:'The great ash tree at the center of Norse cosmology, connecting the Nine Realms. Its roots reach into Niflheim, Jotunheim, and the realm of the dead. Its branches hold ÃsgarÃ°r above and touch the outer void. The tree is alive â€” and currently dying.',unlockedBy:'always'},
  {id:'allfather',term:'Allfather',subtitle:'Odin â€” God of Wisdom, War, and Sacrifice',body:'The Allfather sacrificed one eye for wisdom, hung nine days on Yggdrasil to learn the runes, and sends the Valkyries to choose the worthy dead. He does not offer trials without reason. Whether his reason serves the tree or only himself is a question the sagas never answer cleanly.',unlockedBy:'always'},
  {id:'valhalla',term:'Valhalla',subtitle:"The Allfather's Hall of the Chosen Slain",body:"Warriors chosen by the Valkyries feast and fight in Valhalla, dying each day and rising whole each morning. They train for RagnarÃ¶k. Whether your bloodline's fallen reach Valhalla or are taken by the root is not yet known.",unlockedBy:'always'},
  {id:'saga',term:'Saga',subtitle:'A life worth recording',body:'In the Norse tradition, a saga is a prose narrative of heroic deeds â€” something worthy of being written down and remembered. Your runs are sagas. Not all are long. All are recorded.',unlockedBy:'always'},
  {id:'rune',term:'Rune',subtitle:'A letter, a mystery, a power',body:'The Elder Futhark runes are simultaneously an alphabet, a set of cosmological forces, and a magical system. Odin learned them through sacrifice. The runes that appear throughout the trials are not decorative â€” they are the alphabet of fate itself.',unlockedBy:'always'},
  {id:'norns',term:'The Norns',subtitle:'UrÃ°r, VerÃ°andi, Skuld â€” Past, Present, Future',body:'The three Norns sit at the base of Yggdrasil and weave the fate of gods and mortals alike. UrÃ°r (What Was) spins the thread. VerÃ°andi (What Is) measures it. Skuld (What Shall Be) cuts it. Even Odin cannot undo what the Norns have woven â€” he can only try to weave alongside them. The breeding system is your attempt to do the same.',unlockedBy:'always'},
  {id:'einherjar',term:'Einherjar',subtitle:'The Chosen Dead',body:'The warriors selected by Valkyries to dwell in Valhalla, training endlessly for the final battle of RagnarÃ¶k. They appear in the trials as the Veteran Shield archetype â€” the iron-willed dead who have already died once and lost nothing they were not prepared to lose.',unlockedBy:'firstRetire'},
  {id:'vÃ¶lva',term:'VÃ¶lva',subtitle:'A Norse Seeress',body:"A vÃ¶lva was a wandering prophetess in Norse society, practicing seiÃ°r â€” a form of shamanic magic used to divine the future or alter fate. In the trials, the Curse-Weaver is a vÃ¶lva whose threads have been corrupted by what gnaws at the root. Odin himself consulted a vÃ¶lva's ghost to learn RagnarÃ¶k's shape.",unlockedBy:'firstRetire'},
  {id:'wyrd',term:'Wyrd',subtitle:'Fate as a woven thread',body:"Old Norse: urÃ°r. The concept that fate is not a fixed destination but a living, woven thing â€” shaped by past deeds as much as by the will of the Norns. Your breeding system is wyrd made mechanical: each hero's thread is woven from those who came before. The deeds of the dead literally shape the living.",unlockedBy:'firstBreed'},
  {id:'dvergar',term:'Dvergar',subtitle:'The Norse Dwarves â€” Master Smiths',body:"In Norse myth, the dvergar forged the greatest artifacts in the Nine Realms: MjÃ¶lnir (Thor's hammer), Gungnir (Odin's spear), Gleipnir (the chain that bound Fenrir), Draupnir (the self-replicating ring). In the trials, the Rune-Smith archetype represents a dvergar whose overcharged runic devices have been turned against the living.",unlockedBy:'firstRetire'},
  {id:'fimbulwinter',term:'Fimbulwinter',subtitle:'The Great Winter Before RagnarÃ¶k',body:'Three successive winters with no summer between them, described in the Prose Edda as the precursor to RagnarÃ¶k. Ice, starvation, and the breakdown of social order. When RagnarÃ¶k Tier 11 is active, Fimbulwinter has arrived â€” the trials are colder, slower, and every warmth matters more.',unlockedBy:'tier11'},
  {id:'eitr',term:'Eitr',subtitle:'The World-Venom',body:'In Norse cosmology, eitr is the primordial venom that fills the rivers of Niflheim. It is the source of all poison, all corruption, and â€” paradoxically â€” all life, since the first living things were formed from its interaction with heat. At RagnarÃ¶k Tier 13, eitr has risen into the air of the trials. It kills. It also concentrates into a weapon for those who can use it.',unlockedBy:'tier13'},
  {id:'nidhoggr',term:'NÃ­Ã°hÃ¶ggr',subtitle:'The Gnawer â€” Corpse-Gnawer of NÃ¡strÃ¶nd',body:'The great serpent (or dragon) who gnaws eternally at the roots of Yggdrasil. In the Poetic Edda, NÃ­Ã°hÃ¶ggr survives RagnarÃ¶k and rises at the end of the world with corpses in its wings. In the trials, NÃ­Ã°hÃ¶ggr is not a distant myth. The corruption you have felt since Trial 1 is its work. What lies at the deepest root â€” what True RagnarÃ¶k faces â€” is something that has been awake and eating for a very long time.',unlockedBy:'tier15'},
  {id:'ragnarÃ¶k',term:'RagnarÃ¶k',subtitle:'The Fate of the Gods â€” The Final Battle',body:"RagnarÃ¶k is not simply 'the apocalypse.' It is a specific, fated sequence: Fimbulwinter, the breaking of Fenrir's chain, JÃ¶rmungandr rising from the sea, Surtr marching from Muspelheim with fire, the BifrÃ¶st shattering. The gods know it is coming and prepare anyway. Your bloodline runs the same trials: knowing failure is possible, running regardless, hoping that the right thread survives.",unlockedBy:'tier5'},
];
function unlockCodexEntry(id){
  normalizeMeta();
  if(!META.codexUnlocked.includes(id)){META.codexUnlocked.push(id);saveMeta();}
}
function checkCodexUnlocks(){
  const tier=META.ragnarÃ¶kTier||0;
  if(tier>=5)unlockCodexEntry('ragnarÃ¶k');
  if(tier>=11)unlockCodexEntry('fimbulwinter');
  if(tier>=13)unlockCodexEntry('eitr');
  if(tier>=15)unlockCodexEntry('nidhoggr');
  if(META.retiredPool&&META.retiredPool.length>0){unlockCodexEntry('einherjar');unlockCodexEntry('vÃ¶lva');unlockCodexEntry('dvergar');}
  if(META.family&&Object.keys(META.family).some(id=>{const r=META.family[id];return r&&r.parentIds&&r.parentIds.length>0;}))unlockCodexEntry('wyrd');
}
function codexHTML(){
  checkCodexUnlocks();
  const unlocked=new Set(META.codexUnlocked||[]);
  const visible=CODEX_ENTRIES.filter(e=>unlocked.has(e.id));
  const locked=CODEX_ENTRIES.filter(e=>!unlocked.has(e.id));
  let h=`<div style="padding:10px 0"><div style="font-size:10px;color:var(--txt3);margin-bottom:12px;font-style:italic">Terms revealed as your bloodline discovers them. ${locked.length>0?`${locked.length} entry${locked.length>1?'s':''} yet to be found.`:'All entries revealed.'}</div><div style="display:flex;flex-direction:column;gap:10px">`;
  visible.forEach(entry=>{
    h+=`<div style="background:var(--bg2);border:1px solid var(--border2);border-radius:5px;padding:12px"><div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:2px"><div style="font-family:'Orbitron',sans-serif;font-size:13px;font-weight:900;color:var(--violet)">${entry.term}</div><div style="font-size:9px;color:var(--txt3);font-style:italic">${entry.subtitle}</div></div><div style="font-size:11px;color:var(--txt2);line-height:1.7;margin-top:6px">${entry.body}</div></div>`;
  });
  if(locked.length>0){
    h+=`<div style="border:1px dashed var(--border);border-radius:5px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--txt3);font-style:italic">${locked.length} entry${locked.length>1?'s':''} locked. Continue the saga to discover them.</div><div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:6px;justify-content:center">${locked.map(e=>`<div style="font-size:10px;color:var(--border2);background:var(--bg2);border:1px solid var(--border);border-radius:3px;padding:3px 8px">???</div>`).join('')}</div></div>`;
  }
  h+=`</div></div>`;
  return h;
}

// â”€â”€â”€ UPGRADES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderRunesmith(){
  const ups=[
    {id:'evCap',name:'Stronger Bloodline',icon:'ðŸ§¬',desc:`Raise EV cap by +10 (currently ${evCap()})`,cost:30},
    {id:'imprintChance',name:'Imprint Mastery',icon:'ðŸ’«',desc:`+15% imprint success chance (currently ${Math.round(imprintChance()*100)}%)`,cost:25},
    {id:'poolSize',name:'Wider Pool',icon:'ðŸ›',desc:`+2 retired pool slots (currently ${poolMax()})`,cost:20},
    {id:'mutationRate',name:'Mutation Catalyst',icon:'âš¡',desc:`+3% mutation chance (currently ${Math.round(mutationRate()*100)}%)`,cost:20},
  {id:'nursery', name:'Nursery Program', icon:'ðŸ‘¶', desc:`+15% chance retired heroes have 2 breeding uses (currently +${Math.round((META.upgrades.nursery||0)*15)}%)`, cost:25, currency:'salvage'},
];
  const unlocked=[...META.unlockedTraits];
  const locked=GTRAIT_KEYS.filter(k=>!unlocked.includes(k));
  let h=`<div>
    <div style="font-size:16px;font-weight:700;color:var(--gold);margin-bottom:4px">Legacy Runesmith</div>
    <div style="font-size:11px;color:var(--txt3);margin-bottom:16px">Spend Relics from fallen heroes to permanently improve your lineage.</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;margin-bottom:20px">
      ${ups.map(u=>`<div style="background:var(--bg2);border:1px solid var(--border2);border-radius:5px;padding:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
          <div style="font-weight:700;font-size:13px">${u.icon} ${u.name}</div>
          <div style="font-size:10px;font-weight:700;color:var(--salvage)">áš±${u.cost}</div>
        </div>
        <div style="font-size:11px;color:var(--txt2);margin-bottom:8px">${u.desc}</div>
        <div style="font-size:10px;color:var(--txt3);margin-bottom:8px">Rank: ${META.upgrades[u.id]||0}</div>
        <button class="btn btn-salvage btn-sm${META.salvage<u.cost?' sb-disabled':''}" onclick="buyUpgrade('${u.id}',${u.cost})">Purchase</button>
      </div>`).join('')}
    </div>`;
  if(locked.length){
    h+=`<div style="font-size:14px;font-weight:700;margin-bottom:10px;color:var(--cyan)">ðŸ§¬ Unlock Mutation Traits</div>
      <div style="font-size:11px;color:var(--txt3);margin-bottom:10px">Spend Relics to add new traits to your mutation pool. These can appear during breeding.</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">
        ${locked.map(tk=>{
          const gt=GTRAITS[tk];if(!gt)return '';
          const disabled=META.salvage<15;
          return `<div style="background:var(--bg2);border:1px solid var(--border2);border-radius:4px;padding:10px">
            <div style="font-weight:700;font-size:12px;color:#d090ff">${gt.icon} ${gt.name}</div>
            <div style="font-size:10px;color:var(--txt2);margin:3px 0">${gt.desc}</div>
            <button class="btn btn-sm" style="margin-top:6px;background:rgba(200,60,255,.1);border:1px solid rgba(200,60,255,.3);color:#d090ff;${disabled?'opacity:.4;cursor:not-allowed':''}" onclick="unlockTrait('${tk}')">áš±15 Unlock</button>
          </div>`;
        }).join('')}
      </div>`;
  }
  h+=`<div style="margin-top:20px;border-top:1px solid var(--border);padding-top:16px">
      <div style="font-size:14px;font-weight:700;margin-bottom:10px;color:var(--amber)">ðŸ’¾ Save Data</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-sm btn-amber" onclick="doExport()">ðŸ“¤ Export Save</button>
        <button class="btn btn-sm btn-ghost" onclick="doImport()">ðŸ“¥ Import Save</button>
        <button class="btn btn-sm btn-danger" onclick="doResetMeta()">ðŸ—‘ Reset All Data</button>
      </div>
    </div>
  </div>`;
  return h;
}
function buyUpgrade(id,cost){if(META.salvage<cost)return;META.salvage-=cost;META.upgrades[id]=(META.upgrades[id]||0)+1;saveMeta();setLegacyTab('upgrades');updateMetaHeader();}
function unlockTrait(tk){if(META.salvage<15)return;META.salvage-=15;META.unlockedTraits.add(tk);saveMeta();setLegacyTab('upgrades');updateMetaHeader();}
function doExport(){
  const s=exportSave();
  const ta=document.createElement('textarea');ta.value=s;document.body.appendChild(ta);ta.select();
  document.execCommand('copy');document.body.removeChild(ta);
  alert('Save data copied to clipboard!');
}
function doImport(){
  const s=prompt('Paste save data:');
  if(s&&importSave(s)){alert('Save imported successfully!');setLegacyTab('upgrades');updateMetaHeader();}
  else if(s)alert('Invalid save data.');
}
function doResetMeta(){
  if(!confirm('Reset ALL legacy data? This cannot be undone.'))return;
  localStorage.removeItem(META_KEY);
  META={legacyEssence:0,salvage:0,retiredPool:[],fallenLedger:[],family:{},upgrades:{evCap:0,imprintChance:0,poolSize:0,mutationRate:0,nursery:0},
    unlockedTraits:new Set(['serrated','aegis','skirmisher','venomkiss','gambler','spite','ironblood','swift_born','lucky','resilient']),nextHeroId:1,
    ragnarÃ¶kTier:0,ragnarÃ¶kActive:0,eliteRoster:{},relics:0,hasSeenOpening:false,houseName:null,aspects:{},scarTokens:{},codexUnlocked:['yggdrasil','allfather','valhalla','saga','rune','norns']};
  saveMeta();setLegacyTab('upgrades');updateMetaHeader();
}

// â•â•â• OVERLAY HELPERS â•â•â•
function showOverlayContent(html){
  document.getElementById('overlay-content').innerHTML=html;
  document.getElementById('overlay').style.display='flex';
}
function hideOverlay(){document.getElementById('overlay').style.display='none';}

function showAllFatherGift(){
  const owned=new Set(G.boons.map(b=>b.id));
  const axioms=BOONS.filter(b=>b.rarity==='axiom'&&!owned.has(b.id));
  const offered=rshuffle(axioms).slice(0,3);

  if(!offered.length){
    resumeAfterAllFatherGift();
    return;
  }

  const html=`
    <div style="font-family:'Orbitron',sans-serif;font-size:16px;font-weight:900;
                color:var(--gold);margin-bottom:8px">á›Ÿ THE ALLFATHER'S LAST GIFT</div>
    <div style="font-size:11px;color:var(--txt2);font-style:italic;margin-bottom:14px">
      "He has nothing left to withhold."
    </div>
    <div style="font-size:11px;color:var(--txt3);margin-bottom:14px">
      Choose one Rune Law. This is given freely â€” the cost is what comes next in the saga.
    </div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px">
      ${offered.map(b=>`
        <div class="boon-card rc-axiom" onclick="acceptAllFatherGift('${b.id}')">
          <div style="font-size:9px;color:#d050ff;margin-bottom:4px">RUNE LAW</div>
          <div><span style="font-size:14px">${b.icon}</span>
               <span class="boon-name">${b.name.replace('RUNE: ','')}</span></div>
          <div class="boon-desc" style="margin-top:3px">${b.desc}</div>
        </div>
      `).join('')}
    </div>
  `;
  showOverlayContent(html);
}

function acceptAllFatherGift(boonId){
  const boon=BOONS.find(b=>b.id===boonId);
  if(!boon)return;
  G.boons.push(boon);
  applyBoonEffectsOnPick(boon);
  addLog(`á›Ÿ The Allfather's gift accepted: ${boon.name}`,'laxiom');
  hideOverlay();
  resumeAfterAllFatherGift();
}

function resumeAfterAllFatherGift(){
  G.phase='BATTLE';
  applyEnemyStartTraits();
  applyBattleStartTactics();
  if(G.waveFlags.heroStartVuln){
    applyStatus(G.hero,'vulnerable',1,G.waveFlags.heroStartVuln);
    addLog(`  ðŸŽ¯ Marked Prey: Vulnerable (${G.waveFlags.heroStartVuln}s)`,'lstatus');
  }
  addLog(`âš” Trial ${G.wave} â€” ${G.enemies.length} enemies!`,'lwave');
  NarrationEngine.reset();
  const waveStartLine=MYTH_LINES.waveStart[G.wave];
  if(waveStartLine)NarrationEngine.fire('waveStart',waveStartLine,'lstatus');
  G.enemies.forEach(e=>addLog(`  ${e.icon} ${e.displayName||e.name} HP:${e.hp} ATK:${e.atk} DEF:${e.def}`,'lstatus'));
  renderAll();
  if(G.interval)clearInterval(G.interval);
  G.interval=setInterval(combatTick,100/G.speed);
}

function showRetireConfirm(){
  const rec=G.hero.record;
  const earnedEVs=computeEarnedEVs();
  let html=`
    <div style="font-family:'Orbitron',sans-serif;font-size:16px;font-weight:900;color:var(--gold);margin-bottom:8px">ðŸ› RETIRE HERO?</div>
    <p style="color:var(--txt2);font-size:12px;margin-bottom:14px">End your saga at Trial ${G.wave} and add <strong style="color:var(--gold)">${rec?.name||'your hero'}</strong> to the Chosen of the Hall for future breeding.</p>
    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:10px;margin-bottom:14px;text-align:left">
      <div style="font-size:10px;color:var(--txt3);margin-bottom:5px">EARNED EVs THIS SAGA</div>
      ${EV_KEYS.map(k=>`<div class="srow"><span class="sl" style="font-size:11px">${k.toUpperCase()}_EV</span><span class="sv sdp" style="font-size:11px">+${earnedEVs[k]||0}</span></div>`).join('')}
      <div style="margin-top:8px;font-size:11px;color:var(--gold)">+${Math.floor(G.gold*.35)+G.wave*4} Allfather's Blessing</div>
    </div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-gold" style="flex:1" onclick="hideOverlay();retireHero()">ðŸ› Retire Now</button>
      <button class="btn btn-sm btn-ghost" style="flex:1" onclick="hideOverlay()">âš” Keep Fighting</button>
    </div>`;
  showOverlayContent(html);
}

function startNewRunFromOverlay(){
  const seed=(document.getElementById('seed-input')?.value||'').trim();
  hideOverlay();
  startFirstHero(seed||null);
}

// â•â•â• CONTROLS â•â•â•
function cycleSpeed(){
  if(!G)return;
  const speeds=[1,2,4];
  const idx=speeds.indexOf(G.speed);
  G.speed=speeds[(idx+1)%speeds.length];
  document.getElementById('btn-speed').textContent=`${G.speed}Ã— Speed`;
  if(G.interval){
    clearInterval(G.interval);
    if(G.phase==='BATTLE')G.interval=setInterval(combatTick,100/G.speed);
  }
}
function confirmReset(){
  if(G&&G.phase==='BATTLE')clearInterval(G.interval);
  G=null;
  updateDifficultyUI();
  showStartScreen();
}

// â•â•â• LOG â•â•â•
function addLog(msg,cls){
  const log=document.getElementById('combat-log');
  const el=document.createElement('div');el.className=cls||'lhit';el.innerHTML=msg;
  log.appendChild(el);
  while(log.children.length>400)log.removeChild(log.firstChild);
  log.scrollTop=log.scrollHeight;
}
function clearLog(){document.getElementById('combat-log').innerHTML='';}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RESPONSIVE DRAWERS + CHROME HEIGHT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function syncChromeHeights(){
  const hd=document.getElementById('header');
  const ft=document.getElementById('footer');
  if(hd){
    const h=Math.ceil(hd.getBoundingClientRect().height);
    document.documentElement.style.setProperty('--header-h',h+'px');
  }
  if(ft){
    const f=Math.ceil(ft.getBoundingClientRect().height);
    document.documentElement.style.setProperty('--footer-h',f+'px');
  }
}
function closeDrawers(){document.body.classList.remove('drawer-hero','drawer-right');}
function toggleDrawer(which){
  const cls=(which==='hero')?'drawer-hero':'drawer-right';
  const isOn=document.body.classList.contains(cls);
  closeDrawers();
  if(!isOn)document.body.classList.add(cls);
  syncChromeHeights();
}
function applyResponsiveLayout(){
  syncChromeHeights();
  if(!window.matchMedia('(max-width: 980px)').matches)closeDrawers();
}
document.addEventListener('keydown',(e)=>{if(e.key==='Escape')closeDrawers();});
window.addEventListener('resize',applyResponsiveLayout);
window.addEventListener('orientationchange',()=>setTimeout(applyResponsiveLayout,150));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COLLAPSIBLE COMBAT LOG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setCombatLogCollapsed(collapsed){
  UI.logCollapsed=!!collapsed;
  saveUI();
  const wrap=document.getElementById('log-wrap');
  const btn=document.getElementById('btn-log-toggle');
  if(UI.logCollapsed){
    wrap.classList.add('collapsed');
    if(btn)btn.textContent='Expand';
  }else{
    wrap.classList.remove('collapsed');
    if(btn)btn.textContent='Collapse';
    const log=document.getElementById('combat-log');
    log.scrollTop=log.scrollHeight;
  }
  syncChromeHeights();
}
function toggleCombatLog(){setCombatLogCollapsed(!UI.logCollapsed);}

// â•â•â• INIT â•â•â•
window.onload=()=>{
  loadMeta();
  loadUI();
  if(typeof UI.difficulty!=='number')UI.difficulty=1;
  Object.values(META.family).forEach(h=>{if(!h.evs)h.evs=emptyEVs();});
  // Ensure retired heroes have breeding uses; remove spent/missing from pool
  Object.values(META.family).forEach(h=>{
    if(h && h.runResult && (h.runResult.outcome==='retired' || h.runResult.outcome==='victory')){
      if(typeof h.breedUsesMax!=='number' || h.breedUsesMax<=0) h.breedUsesMax=1;
      if(typeof h.breedUsesLeft!=='number') h.breedUsesLeft=h.breedUsesMax;
    }
  });
  if(Array.isArray(META.retiredPool)){
    META.retiredPool=META.retiredPool.filter(id=>{
      const r=META.family[id];
      if(!r) return false;
      const u=getBreedUses(r);
      return u.left>0;
    });
  }
  saveMeta();
  const small=window.matchMedia('(max-width: 420px)').matches;
  if(small&&localStorage.getItem(UI_KEY)===null){
    UI.logCollapsed=true;
    saveUI();
  }
  setCombatLogCollapsed(UI.logCollapsed);
  updateDifficultyUI();
  showStartScreen();
  setTimeout(applyResponsiveLayout,0);
};


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V5 PATCH â€” Aspects + Breeding Actions + Fallen Scars/Relics
// Naming â€” Generations + Blended Children
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// --- Add SCAR traits (risk/reward) ---
(function(){
  const SCARS = {
    frayed_nerves:{name:'Frayed Nerves',icon:'âš¡',desc:'+12 SPD, start battle Vulnerable (2s).',color:'#c080ff'},
    cold_iron:{name:'Cold Iron',icon:'ðŸ§Š',desc:'+6 DEF, âˆ’4% Crit Chance.',color:'#80a8ff'},
    brittle_edge:{name:'Brittle Edge',icon:'ðŸ©¶',desc:'+10% Crit Chance, âˆ’20 Max HP.',color:'#e8c048'},
    grave_salt:{name:'Grave Salt',icon:'ðŸœƒ',desc:'+8 ATK, take +10% damage.',color:'#ff7070'},
  };
  Object.assign(GTRAITS, SCARS);
  for(const k of Object.keys(SCARS)){
    if(Array.isArray(GTRAIT_KEYS) && !GTRAIT_KEYS.includes(k)) GTRAIT_KEYS.push(k);
    // Make scars unlockable via mutation only after discovered; so do NOT auto-add to unlockedTraits here.
  }
})();

// --- Aspects (lineage identity) ---
const ASPECTS = ['Steel','Gale','Venom','Execution','Axiom'];
const ASPECT_ICON = {Steel:'ðŸ›¡',Gale:'ðŸŒª',Venom:'ðŸ',Execution:'ðŸº',Axiom:'áš±'};
const ASPECT_COLOR = {Steel:'#78a8ff',Gale:'#c080ff',Venom:'#70d870',Execution:'#f0a828',Axiom:'#d050ff'};
const ASPECT_THRESH = [0, 60, 140, 260]; // rank 0..3

const TAG_ASPECT = {
  Bulwark:'Steel', Shield:'Steel', Thorns:'Steel', Sustain:'Steel',
  Tempo:'Gale',
  Bleed:'Venom', Poison:'Venom',
  Crit:'Execution', Execute:'Execution',
  Axiom:'Axiom', Arcane:'Axiom'
};

const TRAIT_ASPECT = {
  serrated:'Venom', venomkiss:'Venom',
  aegis:'Steel', ironblood:'Steel', tenacious:'Steel', spite:'Steel', resilient:'Steel',
  swift_born:'Gale', skirmisher:'Gale',
  lucky:'Execution', gambler:'Execution', predatory:'Execution', executioner_b:'Execution', vampiric_b:'Venom',
  frayed_nerves:'Gale', cold_iron:'Steel', brittle_edge:'Execution', grave_salt:'Execution',
};

function aspectRankFromXp(xp){
  const x = Math.max(0, Math.floor(xp||0));
  if(x >= ASPECT_THRESH[3]) return 3;
  if(x >= ASPECT_THRESH[2]) return 2;
  if(x >= ASPECT_THRESH[1]) return 1;
  return 0;
}
function aspectNextThreshold(rank){
  const r = Math.max(0, Math.min(3, rank|0));
  return ASPECT_THRESH[Math.min(3, r+1)] || ASPECT_THRESH[3];
}
function getAspectState(aspect){
  normalizeMeta();
  return META.aspects[aspect] || {xp:0,rank:0};
}
function getAspectRank(aspect){
  return getAspectState(aspect).rank|0;
}
function addAspectXP(aspect, amount){
  normalizeMeta();
  if(!ASPECTS.includes(aspect)) aspect = 'Steel';
  const st = META.aspects[aspect] || (META.aspects[aspect] = {xp:0,rank:0});
  const prevRank = aspectRankFromXp(st.xp);
  st.xp = Math.max(0, Math.floor((st.xp||0) + (amount||0)));
  st.rank = aspectRankFromXp(st.xp);
  if(st.rank > prevRank){
    try{ addLog(`ðŸ› LINEAGE ASCENDS: ${ASPECT_ICON[aspect]||'âœ¦'} ${aspect} Rank ${st.rank}!`,'laxiom'); }catch(e){}
  }
}
function computeRunAspectScores(){
  const s = {Steel:0,Gale:0,Venom:0,Execution:0,Axiom:0};
  if(!G) return s;
  // Boon tags
  (G.boons||[]).forEach(b=>{
    (b.tags||[]).forEach(t=>{
      const a = TAG_ASPECT[t];
      if(a) s[a] += 4;
    });
    if(b.rarity==='axiom') s.Axiom += 10;
    if(b.rarity==='legendary') s.Axiom += 2;
  });
  // Genetic traits currently expressed
  const tr = (G.hero && G.hero.traits) ? G.hero.traits : (G.hero && G.hero.record && G.hero.record.traits) ? G.hero.record.traits : [];
  (tr||[]).forEach(tk=>{
    const a = TRAIT_ASPECT[tk];
    if(a) s[a] += 3;
  });
  return s;
}
function pickTopAspects(scores){
  const entries = Object.entries(scores||{}).sort((a,b)=>b[1]-a[1]);
  const top = entries[0] && entries[0][1]>0 ? entries[0][0] : 'Steel';
  const second = entries[1] && entries[1][1]>0 ? entries[1][0] : null;
  return [top, second];
}
function awardAspectXPFromRun(outcome){
  if(!G) return;
  normalizeMeta();
  const scores = computeRunAspectScores();
  const [a1,a2] = pickTopAspects(scores);
  const base = (8 + (G.wave||1)*3 + Math.floor((G.level||1)*2));
  const mult = (outcome==='victory') ? 1.8 : (outcome==='retired') ? 1.0 : 0.6;
  const xp1 = Math.floor(base*mult);
  const xp2 = Math.floor(base*0.55*mult);
  addAspectXP(a1, xp1);
  if(a2) addAspectXP(a2, xp2);
  // Axiom spillover if any axioms in run
  const ax = (G.boons||[]).filter(b=>b.rarity==='axiom').length;
  if(ax>0) addAspectXP('Axiom', Math.floor((8+ax*8)*mult));
  // Persist
  try{ saveMeta(); updateMetaHeader(); }catch(e){}
}

// --- Generations + blended naming ---
function baseGivenFromFull(full){
  if(!full) return rpick(NAME_PREFIXES);
  // Try to find the first capitalized chunk
  const first = full.split(' ')[0] || '';
  const clean = first.replace(/[^A-Za-z]/g,'');
  return clean || rpick(NAME_PREFIXES);
}
function capName(s){
  if(!s) return s;
  return s.charAt(0).toUpperCase() + s.slice(1);
}
function blendCandidates(nameA, nameB){
  const A = baseGivenFromFull(nameA);
  const B = baseGivenFromFull(nameB);
  const cuts = [[3,3],[4,3],[3,4],[2,3]];
  const out = [];
  for(const [p,s] of cuts){
    const pA = A.slice(0, Math.min(p, A.length));
    const sB = B.slice(Math.max(0, B.length-s));
    out.push(capName(pA + sB));
    const pB = B.slice(0, Math.min(p, B.length));
    const sA = A.slice(Math.max(0, A.length-s));
    out.push(capName(pB + sA));
  }
  // Seeded fallback
  out.push(capName(A.slice(0,4) + rpick(NAME_SUFFIXES)));
  // Unique + sane lengths
  const uniq = [];
  for(const c of out){
    const v = (c||'').replace(/[^A-Za-z]/g,'');
    if(v.length<4) continue;
    if(!uniq.includes(v)) uniq.push(v);
  }
  return uniq.length ? uniq : [capName(rpick(NAME_PREFIXES)+rpick(NAME_SUFFIXES))];
}
function birthEpithet(aspect, flags){
  if(flags && flags.spliceScar) return 'the Scarred Heir';
  if(flags && flags.spliceRelic) return 'the Bound';
  if(flags && flags.mutated) return 'the Unshaped';
  const map = {
    Steel:'the Shieldbearer',
    Gale:'the Stormswift',
    Venom:'the Serpentblood',
    Execution:'the Wolfbitten',
    Axiom:'the Runebound'
  };
  return map[aspect] || 'the Ascendant';
}
function pickGivenForAspect(cands, aspect){
  const idxMap = {Steel:0,Gale:1,Venom:2,Execution:3,Axiom:4};
  const idx = idxMap[aspect] ?? 0;
  return cands[idx % cands.length];
}

// Override genName while keeping signature
function genName(gen, aspectOrTag, parentNames, flags){
  normalizeMeta();
  const house = META.houseName || genHouseName();
  const aspect = (ASPECTS.includes(aspectOrTag)) ? aspectOrTag : (TAG_ASPECT[aspectOrTag] || 'Steel');

  if(gen===0){
    const given = capName(rpick(NAME_PREFIXES) + rpick(NAME_SUFFIXES));
    return `${given} the First of House ${house}`;
  }
  const pA = parentNames && parentNames[0] ? parentNames[0] : '';
  const pB = parentNames && parentNames[1] ? parentNames[1] : '';
  const cands = blendCandidates(pA, pB);
  const given = pickGivenForAspect(cands, aspect);
  const epi = birthEpithet(aspect, flags);
  return `${given} ${epi} of House ${house}`;
}

// Override mkHeroRecord to store lineage metadata
function mkHeroRecord(name,gen,parentIds,evs,traits){
  normalizeMeta();
  return {
    id: mkHeroId(),
    name,
    gen,
    parentIds: parentIds || [],
    evs: {...(evs||emptyEVs())},
    traits: [...(traits||[])],
    runResult: null,
    house: META.houseName || '',
    birthAspect: 'Steel',
    birthFlags: {},
  };
}

function genHouseName(){
  // short & punchy: Prefix+Suffix, then title-case
  const raw = (rpick(NAME_PREFIXES) + rpick(NAME_SUFFIXES)).replace(/[^A-Za-z]/g,'');
  return capName(raw);
}
function normalizeMeta(){
  if(typeof META !== 'object' || !META) META = {};
  if(!META.houseName || typeof META.houseName !== 'string') META.houseName = genHouseName();
  if(!META.aspects || typeof META.aspects !== 'object') META.aspects = {};
  for(const a of ASPECTS){
    if(!META.aspects[a]) META.aspects[a] = {xp:0,rank:0};
    META.aspects[a].xp = Math.max(0, Math.floor(META.aspects[a].xp||0));
    META.aspects[a].rank = aspectRankFromXp(META.aspects[a].xp);
  }
  META.relics = Math.max(0, Math.floor(META.relics||0));
  if(typeof META.ragnarÃ¶kTier !== 'number') META.ragnarÃ¶kTier = 0;
  if(typeof META.ragnarÃ¶kActive !== 'number') META.ragnarÃ¶kActive = 0;
  if(!META.eliteRoster || typeof META.eliteRoster !== 'object') META.eliteRoster = {};
  if(typeof META.hasSeenOpening !== 'boolean') META.hasSeenOpening = false;
  if(!META.scarTokens || typeof META.scarTokens !== 'object') META.scarTokens = {};
  if(!META.codexUnlocked||!Array.isArray(META.codexUnlocked))META.codexUnlocked=['yggdrasil','allfather','valhalla','saga','rune','norns'];
  for(const k of Object.keys(META.scarTokens)){
    META.scarTokens[k] = Math.max(0, Math.floor(META.scarTokens[k]||0));
    if(META.scarTokens[k] <= 0) delete META.scarTokens[k];
  }
}

// --- Scar/Relic inventory helpers ---
function totalScarTokens(){
  normalizeMeta();
  return Object.values(META.scarTokens||{}).reduce((a,b)=>a+(b||0),0);
}
function scarTokenCount(k){
  normalizeMeta();
  return (META.scarTokens && META.scarTokens[k]) ? META.scarTokens[k] : 0;
}
function addScarToken(k, n){
  normalizeMeta();
  META.scarTokens[k] = Math.max(0, (META.scarTokens[k]||0) + (n||0));
  if(META.scarTokens[k] <= 0) delete META.scarTokens[k];
}

// --- Apply trait stat effects (wrap original) ---
(function(){
  const _applyGeneticTraitStats = applyGeneticTraitStats;
  applyGeneticTraitStats = function(h){
    _applyGeneticTraitStats(h);
    // Scars
    if(!h || !h.traits) return;
    if(h.traits.includes('frayed_nerves')) h.spd += 12;
    if(h.traits.includes('cold_iron')){ h.def += 6; h.critChance = Math.max(0, Math.min(0.9, h.critChance - 0.04)); }
    if(h.traits.includes('brittle_edge')){ h.critChance = Math.min(0.9, h.critChance + 0.10); h.maxHP = Math.max(30, h.maxHP - 20); h.hp = Math.min(h.hp, h.maxHP); }
    if(h.traits.includes('grave_salt')) h.atk += 8;
  };
})();

// --- Birth gifts (one-time at hero creation) ---
function applyBirthGift(hero, rec){
  if(!hero || !rec) return;
  const a = rec.birthAspect || 'Steel';
  const r = getAspectRank(a);
  if(a==='Steel'){
    hero.def += 1 + r;
    hero.maxHP += 10 + r*4; hero.hp = Math.min(hero.maxHP, hero.hp + 10 + r*4);
  }else if(a==='Gale'){
    hero.spd += 6 + r*2;
    hero.evasion = Math.min(0.6, hero.evasion + 0.02 + r*0.005);
  }else if(a==='Venom'){
    hero.atk += 2 + r;
    hero.lifesteal = Math.min(0.4, hero.lifesteal + 0.01 + r*0.004);
  }else if(a==='Execution'){
    hero.critChance = Math.min(0.9, hero.critChance + 0.03 + r*0.01);
  }else if(a==='Axiom'){
    hero.critChance = Math.min(0.9, hero.critChance + 0.02 + r*0.008);
    hero.spd += 3 + r;
  }
}

// Wrap newHero to apply birth gift
(function(){
  const _newHero = newHero;
  newHero = function(evs, traits, record){
    const h = _newHero(evs, traits, record);
    try{ if(record) applyBirthGift(h, record); }catch(e){}
    return h;
  };
})();

// --- Damage hook for grave_salt (+10% damage taken) ---
(function(){
  const _heroDmg = heroDmg;
  heroDmg = function(rawDmg, attacker, src){
    if(G && G.hero && hasTrait && hasTrait('grave_salt') && rawDmg>0) rawDmg = Math.floor(rawDmg * 1.10);
    return _heroDmg(rawDmg, attacker, src);
  };
})();

// --- Fallen scar/relic choice systems ---
const SCAR_KEYS = ['frayed_nerves','cold_iron','brittle_edge','grave_salt'];

function deriveScarCandidates(){
  const all=[...SCAR_KEYS];
  const weights={frayed_nerves:1,cold_iron:1,brittle_edge:1,grave_salt:1};
  const es=(G&&Array.isArray(G.enemies))?G.enemies:[];

  if(es.some(e=>e.archId==='frost'||e.realmTier==='niflheim')){weights.cold_iron+=3;weights.frayed_nerves+=1;}
  if(G&&G.hero&&G.hero.critChance>0.20)weights.brittle_edge+=2;
  if(G&&G._narratedNearDeath)weights.frayed_nerves+=2;
  if(es.some(e=>e.elite))weights.grave_salt+=2;

  const candidates=[];
  const pool=[...all];
  while(candidates.length<3&&pool.length>0){
    const pick=rwgt(pool,k=>weights[k]||1);
    candidates.push(pick);
    pool.splice(pool.indexOf(pick),1);
  }
  return candidates;
}

const SCAR_REASON_TEXT={
  frayed_nerves:'The pressure never let up.',
  cold_iron:'The cold found the gaps.',
  brittle_edge:'Striking harder was never the answer.',
  grave_salt:'Aggression left no room for defense.',
};

function showFallenScarChoice(heroId,salvageEarned){
  const rec=META.family[heroId];
  if(!rec){showStartScreen();return;}
  normalizeMeta();

  const candidates=deriveScarCandidates();
  const html=`
    <div style="font-family:'Orbitron',sans-serif;font-size:18px;font-weight:900;
                color:var(--red);margin-bottom:8px">â˜  SAGA CLOSED</div>
    <div style="font-size:13px;color:var(--txt2);margin-bottom:4px">
      ${rec.name} fell at Trial ${rec.runResult?.wave||'?'}.
    </div>
    <div style="font-size:11px;color:var(--txt3);font-style:italic;margin-bottom:16px">
      "The saga passed to the next."
    </div>
    <div style="font-size:12px;font-weight:700;color:var(--txt);margin-bottom:10px">
      What did this saga teach the blood?
    </div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
      ${candidates.map(scarKey=>{
        const gt=GTRAITS[scarKey];
        return `
          <div class="imprint-card" onclick="acceptScar('${heroId}','${scarKey}')">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:800;color:#d090ff">${gt?.icon||'ðŸ©¹'} ${gt?.name||scarKey}</div>
              <div style="font-size:9px;color:var(--salvage)">SCAR TOKEN +1</div>
            </div>
            <div style="font-size:10px;color:var(--txt2);margin-top:4px">${gt?.desc||''}</div>
            <div style="font-size:9px;color:var(--txt3);font-style:italic;margin-top:3px">
              ${SCAR_REASON_TEXT[scarKey]||''}
            </div>
          </div>
        `;
      }).join('')}
    </div>
    <div style="font-size:10px;color:var(--txt3);border-top:1px solid var(--border);padding-top:8px">
      áš±${salvageEarned} Rune-Shards recovered. Fallen heroes cannot breed or bequeath gear.
    </div>
  `;
  showOverlayContent(html);
}

function acceptScar(heroId,scarKey){
  const rec=META.family[heroId];
  if(!rec)return;
  normalizeMeta();
  addScarToken(scarKey,1);
  try{META.unlockedTraits.add(scarKey);}catch(e){}
  if(rec.runResult)rec.runResult.harvest='scar:'+scarKey;
  META.family[heroId]=rec;
  saveMeta();
  updateMetaHeader();
  hideOverlay();
  try{addLog(`ðŸ©¹ Scar etched: ${GTRAITS[scarKey]?.name||scarKey} â€” the blood remembers.`,'laxiom');}catch(e){}
  showStartScreen();
}

const TAG_RELIC_MAP={
  Bleed:{key:'relic_bleed_mastery',label:'Blood-Rite Mastery',icon:'ðŸ©¸',desc:'When Spliced: child has 90% chance to inherit a Bleed-related trait.'},
  Poison:{key:'relic_eitr_touch',label:'Eitr-Touch',icon:'â˜ ',desc:'When Spliced: child has 90% chance to inherit a Poison-related trait.'},
  Crit:{key:'relic_keen_eye',label:'Keen-Eye Technique',icon:'ðŸŽ¯',desc:'When Spliced: child inherits +5 bonus Crit EV.'},
  Tempo:{key:'relic_stormswift',label:'Stormswift Legacy',icon:'âš¡',desc:'When Spliced: child inherits +5 bonus SPD EV.'},
  Bulwark:{key:'relic_ironwall',label:'Iron-Wall Lineage',icon:'ðŸ›¡',desc:'When Spliced: child inherits +5 bonus DEF EV.'},
  Axiom:{key:'relic_rune_law',label:'Rune Law Fragment',icon:'áš¢',desc:'When Spliced: child has 70% chance to start with an Axiom boon in the first draft.'},
  Execute:{key:'relic_wolf_oath',label:'Wolf-Oath',icon:'ðŸº',desc:'When Spliced: child has 90% chance to inherit an Execute-related trait.'},
  Sustain:{key:'relic_lifeline',label:'Life-Root Binding',icon:'ðŸ’š',desc:'When Spliced: child inherits +5 bonus HP EV.'},
};

function deriveRelicCandidates(rec){
  const tagCounts={};
  (rec.runResult?.boons||[]).forEach(boonId=>{
    const boon=BOONS.find(b=>b.id===boonId);
    if(boon)boon.tags.forEach(t=>{tagCounts[t]=(tagCounts[t]||0)+1;});
  });
  const topTags=Object.entries(tagCounts).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([tag])=>tag);
  const results=topTags.map(tag=>TAG_RELIC_MAP[tag]).filter(Boolean);
  const allOptions=Object.values(TAG_RELIC_MAP);
  while(results.length<3){
    const fallback=allOptions.find(r=>!results.some(x=>x.key===r.key));
    if(fallback)results.push(fallback);else break;
  }
  return results.slice(0,3);
}

function showRetireRelicChoice(rec,essence){
  const candidates=deriveRelicCandidates(rec);
  const html=`
    <div style="font-family:'Orbitron',sans-serif;font-size:18px;font-weight:900;
                color:var(--gold);margin-bottom:8px">ðŸ› SAGA SEALED</div>
    <div style="font-size:13px;color:var(--txt2);margin-bottom:4px">
      ${rec.name} â€” Trial ${rec.runResult?.wave||'?'} Â· Lv.${rec.runResult?.level||1}
    </div>
    <div style="font-size:11px;color:var(--txt3);font-style:italic;margin-bottom:16px">
      "Let the blood carry the rest."
    </div>
    <div style="font-size:12px;font-weight:700;color:var(--txt);margin-bottom:10px">
      What does this saga leave behind?
    </div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:14px">
      ${candidates.map(r=>`
        <div class="imprint-card" style="border-color:rgba(212,160,23,.4)" onclick="acceptRelic('${rec.id}','${r.key}')">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800;color:var(--gold)">${r.icon} ${r.label}</div>
            <div style="font-size:9px;color:var(--amber)">RELIC +1</div>
          </div>
          <div style="font-size:10px;color:var(--txt2);margin-top:4px">${r.desc}</div>
          <div style="font-size:9px;color:var(--txt3);font-style:italic;margin-top:3px">Usable in Splice during breeding to lock this mastery into a child.</div>
        </div>
      `).join('')}
    </div>
    <div style="font-size:10px;color:var(--green)">+${essence} Allfather's Blessing Â· This hero may breed.</div>
  `;
  showOverlayContent(html);
}

function showBequeathChoice(rec,essence){
  if(!G||!G.hero||!G.hero.gear){proceedAfterBequeath(rec,essence);return;}
  const gearSlots=Object.entries(G.hero.gear).filter(([slot,item])=>item!==null);
  if(!gearSlots.length){proceedAfterBequeath(rec,essence);return;}
  const html=`
    <div style="font-family:'Orbitron',sans-serif;font-size:16px;font-weight:900;color:var(--gold);margin-bottom:8px">âš’ WHAT REMAINS</div>
    <div style="font-size:11px;color:var(--txt2);margin-bottom:14px">Choose one item to pass to your bloodline. It will be available to the next hero bred from ${rec.name}.</div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px">
      ${gearSlots.map(([slot,item])=>{
        const waveBonus=Math.min(3,Math.floor((rec.runResult?.wave||1)/6));
        const primaryStatLabel={weapon:'ATK',armor:'DEF',talisman:'EVA'}[slot]||slot;
        return `<div class="imprint-card" style="border-color:${rarityBorderColor(item.rarity)}" onclick="bequeathGear('${rec.id}','${slot}',${waveBonus})">
          <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800;color:${rarityColor(item.rarity)}">${item.name}</div><div style="font-size:9px;color:var(--txt3)">${item.rarity.toUpperCase()}</div></div>
          <div style="font-size:10px;color:var(--txt2);margin-top:3px">${(item.affixes||[]).map(a=>a.label).join(' Â· ')||'No affixes'}</div>
          ${item.sagaHistory?.length?`<div style="font-size:9px;color:var(--txt3);font-style:italic;margin-top:3px">"${item.sagaHistory[item.sagaHistory.length-1]}"</div>`:''}
          ${item.notches>0?`<div style="font-size:9px;color:var(--amber);margin-top:2px">${item.notches} Notch${item.notches>1?'es':''}${item.sundered?' â€” SUNDERED':''}</div>`:''}
          ${waveBonus>0?`<div style="font-size:9px;color:var(--green);margin-top:2px">Legacy bonus: +${waveBonus} ${primaryStatLabel} for the next wielder</div>`:''}
        </div>`;
      }).join('')}
    </div>
    <button class="btn btn-sm btn-ghost" style="width:100%" onclick="skipBequeath('${rec.id}',${essence})">Bequeath nothing â€” carry on</button>
  `;
  showOverlayContent(html);
}
function gearSlotPrimaryStat(slot){return {weapon:'atk',armor:'def',talisman:'evasion'}[slot]||'atk';}
function bequeathGear(heroId,slot,waveBonus){
  const rec=META.family[heroId];
  const item=(G&&G.hero&&G.hero.gear)?G.hero.gear[slot]:null;
  if(!rec||!item){proceedAfterBequeath(rec,META.legacyEssence);return;}
  item.sagaHistory=item.sagaHistory||[];
  if(item.sagaHistory.length>=3)item.sagaHistory.shift();
  item.sagaHistory.push(`Last wielded by ${rec.name}, Trial ${rec.runResult?.wave||'?'}`);
  const primaryStat=gearSlotPrimaryStat(slot);
  if(waveBonus>0)item.passiveBonus={stat:primaryStat,value:waveBonus,label:`+${waveBonus} legacy (${rec.name})`};
  item.forgedBy=heroId; item.forgedByName=rec.name;
  rec.equippedGear=rec.equippedGear||{};
  rec.equippedGear[slot]=JSON.parse(JSON.stringify(item));
  META.family[heroId]=rec;
  saveMeta();
  hideOverlay();
  addLog(`âš’ ${item.name} bequeathed. It will find the next worthy hand.`,'laxiom');
  proceedAfterBequeath(rec,META.legacyEssence);
}
function skipBequeath(heroId,essence){hideOverlay();proceedAfterBequeath(META.family[heroId],essence);}
function proceedAfterBequeath(rec,essence){
  const axiomBoons=G?G.boons.filter(b=>b.rarity==='axiom'):[];
  if(axiomBoons.length>0)showImprintOffer(rec,axiomBoons,essence);
  else showRetireSummary(rec,essence,null);
}

function acceptRelic(heroId,relicKey){
  const rec=META.family[heroId];
  if(!rec)return;
  normalizeMeta();
  META.relics+=1;
  rec.relicType=relicKey;
  if(rec.runResult)rec.runResult.harvest='relic:'+relicKey;
  META.family[heroId]=rec;
  saveMeta();
  updateMetaHeader();
  hideOverlay();
  try{addLog(`ðŸ—¿ Relic forged: ${relicKey} â€” the mastery endures.`,'laxiom');}catch(e){}
  showBequeathChoice(rec,META.legacyEssence);
}

// --- Breeding actions state ---
let BREED_ACTION = {mode:'none', spliceKind:'relic', traitKey:null, scarKey:null};
function resetBreedAction(){ BREED_ACTION = {mode:'none', spliceKind:'relic', traitKey:null, scarKey:null}; }

function stabilizeCost(){
  const c = 15 - getAspectRank('Steel')*2;
  return Math.max(6, c|0);
}
function catalyzeCost(){
  const c = 15 - getAspectRank('Gale')*2;
  return Math.max(6, c|0);
}
function setBreedAction(mode){
  if(mode===BREED_ACTION.mode){ resetBreedAction(); }
  else{
    BREED_ACTION.mode = mode;
    if(mode!=='splice'){ BREED_ACTION.spliceKind='relic'; BREED_ACTION.traitKey=null; BREED_ACTION.scarKey=null; }
  }
  setLegacyTab('breed');
}
function setSpliceKind(kind){
  BREED_ACTION.spliceKind = kind;
  BREED_ACTION.traitKey = null;
  BREED_ACTION.scarKey = null;
  setLegacyTab('breed');
}
function setSpliceTrait(tk){
  BREED_ACTION.traitKey = tk;
  setLegacyTab('breed');
}
function setSpliceScar(sk){
  BREED_ACTION.scarKey = sk;
  setLegacyTab('breed');
}

function breedingActionsHTML(){
  normalizeMeta();
  const mode = BREED_ACTION.mode;
  const hasEss = (META.legacyEssence||0) >= stabilizeCost();
  const hasSal = (META.salvage||0) >= catalyzeCost();
  const hasRel = (META.relics||0) > 0;
  const scars = Object.keys(META.scarTokens||{}).filter(k=>scarTokenCount(k)>0);

  const btn = (lbl, m, ok, extra) => `
    <button class="btn btn-sm ba-btn ${mode===m?'active':''} ${ok?'':'disabled'}" onclick="${ok?`setBreedAction('${m}')`:`alert('Not enough resources.')`}">
      ${lbl} ${extra||''}
    </button>
  `;

  let html = `
    <div style="margin:10px 0 16px">
      <div class="sec-title">Breeding Actions</div>
      <div class="breed-actions">
        ${btn(`ðŸ§Š Stabilize <span style="color:var(--gold);font-family:'Share Tech Mono',monospace">á›‹${stabilizeCost()}</span>`, 'stabilize', hasEss)}
        ${btn(`âš¡ Catalyze <span style="color:var(--salvage);font-family:'Share Tech Mono',monospace">áš±${catalyzeCost()}</span>`, 'catalyze', hasSal)}
        ${btn(`ðŸ§¬ Splice <span style="color:var(--amber);font-family:'Share Tech Mono',monospace">${(hasRel?`ðŸ—¿${META.relics}`:'')}${(scars.length?` Â· ðŸ©¹${totalScarTokens()}`:'')}</span>`, 'splice', (hasRel||scars.length>0))}
      </div>
  `;

  if(mode==='stabilize'){
    html += `<div class="breed-subpanel">
      <div style="font-weight:800;color:var(--gold);margin-bottom:4px">Stabilize</div>
      <div style="font-size:11px;color:var(--txt2)">Lower EV variance, higher inheritance reliability, lower mutation chance.</div>
    </div>`;
  }else if(mode==='catalyze'){
    html += `<div class="breed-subpanel">
      <div style="font-weight:800;color:var(--salvage);margin-bottom:4px">Catalyze</div>
      <div style="font-size:11px;color:var(--txt2)">Higher EV variance and mutation chance. More likely to produce an unexpected heir.</div>
    </div>`;
  }else if(mode==='splice'){
    const a = BREED_SELECTED[0], b = BREED_SELECTED[1];
    const recA = META.family[a], recB = META.family[b];
    const parentTraits = [...new Set([...(recA?.traits||[]), ...(recB?.traits||[])])];
    html += `<div class="breed-subpanel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div style="font-weight:900;color:#d090ff">Splice</div>
        <div style="font-size:10px;color:var(--txt3)">Choose a Relic-lock or implant a Scar.</div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
        ${hasRel?`<span class="choice-pill ${BREED_ACTION.spliceKind==='relic'?'active':''}" onclick="setSpliceKind('relic')">ðŸ—¿ Relic Lock</span>`:''}
        ${scars.length?`<span class="choice-pill ${BREED_ACTION.spliceKind==='scar'?'active':''}" onclick="setSpliceKind('scar')">ðŸ©¹ Scar Implant</span>`:''}
      </div>
    `;

    if(BREED_ACTION.spliceKind==='relic'){
      html += `<div style="font-size:11px;color:var(--txt2);margin-bottom:6px">Consume <strong>1 Relic</strong> to lock a parent trait into the child (high chance).</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">`;
      if(!hasRel) html += `<div style="color:var(--txt3);font-size:11px">No Rune-Shards available.</div>`;
      else if(!parentTraits.length) html += `<div style="color:var(--txt3);font-size:11px">Parents have no traits to lock.</div>`;
      else{
        html += parentTraits.map(tk=>{
          const gt = GTRAITS[tk];
          const on = (BREED_ACTION.traitKey===tk);
          return `<span class="choice-pill ${on?'active':''}" onclick="setSpliceTrait('${tk}')">${gt?gt.icon:''} ${gt?gt.name:tk}</span>`;
        }).join('');
      }
      html += `</div>`;
    }else{
      html += `<div style="font-size:11px;color:var(--txt2);margin-bottom:6px">Consume <strong>1 Scar Token</strong> to implant that scar into the child (guaranteed).</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">`;
      if(!scars.length) html += `<div style="color:var(--txt3);font-size:11px">No scar tokens available.</div>`;
      else{
        html += scars.map(sk=>{
          const gt = GTRAITS[sk];
          const on = (BREED_ACTION.scarKey===sk);
          return `<span class="choice-pill ${on?'active':''}" onclick="setSpliceScar('${sk}')">${gt?gt.icon:''} ${gt?gt.name:sk} Ã—${scarTokenCount(sk)}</span>`;
        }).join('');
      }
      html += `</div>`;
    }

    html += `</div>`;
  }

  html += `</div>`;
  return html;
}

// --- Trait inheritance bonus by aspect rank ---
function traitInheritBonus(tk){
  const a = TRAIT_ASPECT[tk];
  if(!a) return 0;
  return getAspectRank(a) * 0.03; // up to +9%
}

// Override breedHeroes to accept breeding action options + naming flags
function breedHeroes(idA, idB, opts){
  const recA = META.family[idA], recB = META.family[idB];
  if(!recA || !recB) return null;
  normalizeMeta();

  const action = (opts && opts.mode) ? opts.mode : 'none';
  const spliceKind = opts ? opts.spliceKind : null;

  let VAR = 5;
  let mutMult = 1.0;
  let inheritAdd = 0.0;
  let mutBoostChance = 0.08;

  if(action==='stabilize'){ VAR = 2; mutMult = 0.55; inheritAdd = 0.10; mutBoostChance = 0.06; }
  else if(action==='catalyze'){ VAR = 8; mutMult = 1.75; inheritAdd = -0.05; mutBoostChance = 0.18; }

  const cap = evCap();
  const childEVs = {};
  EV_KEYS.forEach(k=>{
    let val = Math.round(((recA.evs[k]||0)+(recB.evs[k]||0))/2 + ri(-VAR, VAR));
    if(Math.random() < mutBoostChance) val += ri(5, 12);
    childEVs[k] = Math.min(cap, Math.max(0, val));
  });

  const allParentTraits = [...new Set([...(recA.traits||[]), ...(recB.traits||[])])];
  const sharedTraits = (recA.traits||[]).filter(t=> (recB.traits||[]).includes(t));
  const childTraits = [];
  for(const t of allParentTraits){
    const baseChance = (sharedTraits.includes(t) ? 0.75 : 0.45) + inheritAdd + traitInheritBonus(t);
    if(Math.random() < Math.min(0.95, Math.max(0.05, baseChance))) childTraits.push(t);
  }

  let mutated = false;
  if(Math.random() < (mutationRate() * mutMult)){
    const unlocked = [...META.unlockedTraits];
    const available = unlocked.filter(t=>!childTraits.includes(t));
    if(available.length){
      const mut = rpick(available);
      childTraits.push(mut);
      mutated = true;
      try{ addLog(`ðŸ§¬ MUTATION! New trait emerged: ${GTRAITS[mut]?.name||mut}!`,'laxiom'); }catch(e){}
    }
  }

  // Splice effects
  let spliceRelic = false, spliceScar = false;
  if(action==='splice' && opts){
    if(spliceKind==='relic' && opts.traitKey){
      spliceRelic = true;
      const t = opts.traitKey;
      // High chance to include locked parent trait
      if(allParentTraits.includes(t) && Math.random() < 0.90 && !childTraits.includes(t)) childTraits.push(t);
      if(allParentTraits.includes(t) && Math.random() < 0.25 && !childTraits.includes(t)) childTraits.push(t); // small second roll if missed
    }else if(spliceKind==='scar' && opts.scarKey){
      spliceScar = true;
      const sk = opts.scarKey;
      if(!childTraits.includes(sk)) childTraits.push(sk);
    }
  }

  // Enforce max traits: scars should be kept if present
  const maxTraits = TRAIT_MAX_BASE;
  let finalTraits = [...new Set(childTraits)];
  if(finalTraits.length > maxTraits){
    // Prefer to keep spliced scar if any
    const keep = [];
    if(spliceScar && opts && opts.scarKey) keep.push(opts.scarKey);
    if(spliceRelic && opts && opts.traitKey) keep.push(opts.traitKey);
    // Build final list
    const out = [];
    for(const k of keep){ if(k && finalTraits.includes(k) && !out.includes(k)) out.push(k); }
    for(const k of finalTraits){ if(out.length>=maxTraits) break; if(!out.includes(k)) out.push(k); }
    finalTraits = out.slice(0, maxTraits);
  }else{
    finalTraits = finalTraits.slice(0, maxTraits);
  }

  if(action==='splice'&&opts&&opts.spliceKind==='relic'&&opts.traitKey){
    const relicEVBonus={
      relic_keen_eye:{ev:'crit',bonus:5},
      relic_stormswift:{ev:'spd',bonus:5},
      relic_ironwall:{ev:'def',bonus:5},
      relic_lifeline:{ev:'hp',bonus:5},
    };
    const relicBonus=relicEVBonus[opts.traitKey];
    if(relicBonus){
      childEVs[relicBonus.ev]=Math.min(cap,(childEVs[relicBonus.ev]||0)+relicBonus.bonus);
    }
  }

  // Determine child aspect (from EV + traits)
  const topEvK = EV_KEYS.reduce((a,b)=> (childEVs[a]||0) > (childEVs[b]||0) ? a : b);
  const evAspectMap = {hp:'Steel',def:'Steel',ls:'Venom',atk:'Execution',crit:'Execution',spd:'Gale',eva:'Gale',acc:'Execution'};
  let birthAspect = evAspectMap[topEvK] || 'Steel';
  // If child has an Axiom boon later, that will shift; for birth we keep genetics.
  if(finalTraits.some(t=>TRAIT_ASPECT[t]==='Axiom')) birthAspect = 'Axiom';

  const genNum = Math.max(recA.gen||0, recB.gen||0) + 1;
  const childName = genName(genNum, birthAspect, [recA.name, recB.name], {mutated, spliceRelic, spliceScar});
  const childRec = mkHeroRecord(childName, genNum, [recA.id, recB.id], childEVs, finalTraits);
  childRec.birthAspect = birthAspect;
  childRec.birthFlags = {catalyzed: action==='catalyze', mutated, spliceRelic, spliceScar};

  META.family[childRec.id] = childRec;
  saveMeta();
  return childRec;
}

// Override doBreed to apply costs + splice inventory
(function(){
  const _doBreed = doBreed;
  doBreed = function(){
    if(BREED_SELECTED.length<2){alert('Select 2 heroes first.');return;}
    normalizeMeta();
    const a = BREED_SELECTED[0], b = BREED_SELECTED[1];
    const ua = getBreedUses(META.family[a]), ub = getBreedUses(META.family[b]);
    if(ua.left<=0||ub.left<=0){alert('One of the selected parents has no breeding uses left.');return;}

    const mode = BREED_ACTION.mode;
    const opts = {mode:'none'};

    // Pay costs / consume inventory
    if(mode==='stabilize'){
      const c = stabilizeCost();
      if((META.legacyEssence||0) < c){ alert("Not enough Allfather's Blessing for Stabilize."); return; }
      META.legacyEssence -= c;
      opts.mode = 'stabilize';
    }else if(mode==='catalyze'){
      const c = catalyzeCost();
      if((META.salvage||0) < c){ alert('Not enough Rune-Shards for Catalyze.'); return; }
      META.salvage -= c;
      opts.mode = 'catalyze';
    }else if(mode==='splice'){
      opts.mode = 'splice';
      opts.spliceKind = BREED_ACTION.spliceKind;
      if(BREED_ACTION.spliceKind==='relic'){
        if((META.relics||0) <= 0){ alert('No Rune-Shards available.'); return; }
        if(!BREED_ACTION.traitKey){ alert('Choose a parent trait to lock.'); return; }
        META.relics -= 1;
        opts.traitKey = BREED_ACTION.traitKey;
      }else{
        if(!BREED_ACTION.scarKey){ alert('Choose a scar token to implant.'); return; }
        if(scarTokenCount(BREED_ACTION.scarKey) <= 0){ alert('That scar token is not available.'); return; }
        addScarToken(BREED_ACTION.scarKey, -1);
        opts.scarKey = BREED_ACTION.scarKey;
      }
    }

    const childRec = breedHeroes(a, b, opts);
    if(!childRec) return;

    const bestParentId=[a,b].reduce((best,pid)=>{
      const p=META.family[pid], bRec=META.family[best];
      const pWave=(p?.runResult?.wave||0), bWave=(bRec?.runResult?.wave||0);
      const pF=isFallenHero(pid), bF=isFallenHero(best);
      if(bF&&!pF)return pid;
      if(!bF&&pF)return best;
      return pWave>=bWave?pid:best;
    },a);
    inheritGearFromParent(childRec.id,bestParentId);

    consumeBreedUse(a);
    consumeBreedUse(b);
    saveMeta();
    BREED_SELECTED = [];
    resetBreedAction();

    const lc=document.getElementById('legacy-content');
    const derived=evDerived(childRec.evs);
    lc.innerHTML=`<div class="slide-in" style="text-align:center;padding:30px">
      <div style="font-size:11px;color:var(--violet);font-style:italic;
              letter-spacing:1px;margin-bottom:8px">You tighten the weave.</div>
      <div style="font-size:22px;margin-bottom:8px">ðŸ§¬</div>
      <div style="font-family:'Orbitron',sans-serif;font-size:18px;font-weight:900;color:var(--violet);margin-bottom:6px">${childRec.name}</div>
      <div style="color:var(--txt3);font-size:12px;margin-bottom:18px">Generation ${childRec.gen} Â· ${ASPECT_ICON[childRec.birthAspect]||'âœ¦'} ${childRec.birthAspect} lineage</div>
      <div style="display:inline-block;background:var(--bg2);border:1px solid var(--border2);border-radius:6px;padding:14px 20px;margin-bottom:18px;text-align:left;min-width:240px">
        <div style="font-size:10px;color:var(--txt3);letter-spacing:2px;margin-bottom:8px">GENETIC STATS</div>
        ${[['MaxHP',derived.maxHP],['ATK',Math.round(derived.atk)],['DEF',Math.round(derived.def)],['SPD',derived.spd],['Crit',Math.round(derived.critChance*100)+'%']].map(([l,v])=>`<div class="srow"><span class="sl" style="font-size:12px">${l}</span><span class="sv" style="font-size:12px;color:var(--green)">${v}</span></div>`).join('')}
        ${childRec.traits.length?`<div style="margin-top:10px;border-top:1px solid var(--border);padding-top:8px;display:flex;flex-wrap:wrap;gap:3px">${childRec.traits.map(tk=>{const gt=GTRAITS[tk];return gt?`<span class="gtrait">${gt.icon} ${gt.name}</span>`:''}).join('')}</div>`:`<div style="margin-top:8px;color:var(--txt3);font-size:10px">No genetic traits inherited.</div>`}
        ${childRec.inheritedGear&&Object.values(childRec.inheritedGear).some(Boolean)?`<div style="margin-top:8px;border-top:1px solid var(--border);padding-top:8px;text-align:left"><div style="font-size:9px;color:var(--txt3);letter-spacing:2px;margin-bottom:4px">INHERITED GEAR</div>${Object.values(childRec.inheritedGear).filter(Boolean).map(item=>`<div style="font-size:10px;color:${rarityColor(item.rarity)};margin:2px 0">âš’ ${item.name}${item.passiveBonus?`<span style="color:var(--green)"> Â· ${item.passiveBonus.label}</span>`:''}</div>`).join('')}</div>`:''}
      </div>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="hideLegacy();startWithChild('${childRec.id}')">You choose the next thread â€” Continue as ${childRec.name}</button>
        <button class="btn btn-sm" style="background:var(--bg2);border:1px solid var(--border2);color:var(--txt3)" onclick="setLegacyTab('pool')">â† Back</button>
      </div>
    </div>`;
  };
})();

// Inject breeding actions UI into Breeding tab (wrap renderBreeding)
(function(){
  const _renderBreeding = renderBreeding;
  renderBreeding = function(){
    const base = _renderBreeding();
    if(BREED_SELECTED.length<2) return base;
    // Insert after the "Breeding Chamber" title
    const needle = `âš— Breeding Chamber</div>`;
    if(base.includes(needle)){
      return base.replace(needle, needle + breedingActionsHTML());
    }
    // fallback: prepend
    return breedingActionsHTML() + base;
  };
})();

// --- Runesmith tab: show Generations + Aspects + inventory ---
function aspectsHTML(){
  normalizeMeta();
  const rows = ASPECTS.map(a=>{
    const st = getAspectState(a);
    const next = aspectNextThreshold(st.rank);
    const prev = ASPECT_THRESH[st.rank] || 0;
    const pct = (st.rank>=3) ? 100 : Math.max(0, Math.min(100, ((st.xp - prev) / Math.max(1, (next - prev))) * 100));
    return `<div class="aspect-row">
      <div style="width:86px;font-size:11px;font-weight:800;color:${ASPECT_COLOR[a]||'#aaa'}">${ASPECT_ICON[a]||'âœ¦'} ${a}</div>
      <div class="aspect-bar"><div class="aspect-fill" style="width:${pct}%;background:${ASPECT_COLOR[a]||'#777'}"></div></div>
      <div style="width:80px;text-align:right;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--txt3)">R${st.rank} Â· ${st.xp}${st.rank>=3?'':' / '+next}</div>
    </div>`;
  }).join('');
  return `<div style="background:rgba(20,18,40,.55);border:1px solid var(--border2);border-radius:8px;padding:12px;margin-bottom:14px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:900;color:var(--gold)">á›Ÿ House ${META.houseName}</div>
      <div style="font-size:10px;color:var(--txt3)">Relics: ðŸ—¿${META.relics} Â· Scar Tokens: ðŸ©¹${totalScarTokens()}</div>
    </div>
    <div style="font-size:10px;color:var(--txt3);margin-top:4px">
      RagnarÃ¶k: ${rootDepthIcon(META.ragnarÃ¶kTier)} Tier ${META.ragnarÃ¶kTier || 0} unlocked
      ${META.ragnarÃ¶kTier > 0 ? `Â· "${rootDepthLabel(META.ragnarÃ¶kTier)}"` : 'Â· No tier unlocked yet'}
    </div>
    <div style="font-size:10px;color:var(--txt3);margin-bottom:8px">Rename House:</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
      <input id="house-name-input" value="${(META.houseName||'')}" style="flex:1;min-width:180px;background:var(--bg2);border:1px solid var(--border2);color:var(--txt);padding:8px 10px;border-radius:6px;font-size:12px;font-family:'Share Tech Mono',monospace;outline:none">
      <button class="btn btn-sm btn-amber" onclick="setHouseNameFromInput()">Save</button>
    </div>
    <div class="sec-title" style="margin-top:0">Bloodline Aspects</div>
    ${rows}
    <div style="font-size:10px;color:var(--txt3);margin-top:8px">Earn Aspect XP by retiring or winning. Each family develops a distinct identity over generations. (Venom aspect lore: Venom (Eitr))</div>
  </div>`;
}
function setHouseNameFromInput(){
  const el = document.getElementById('house-name-input');
  if(!el) return;
  const v = (el.value||'').trim().replace(/[^A-Za-z0-9_-]/g,'').slice(0,18);
  if(!v){ alert('Family name cannot be empty.'); return; }
  normalizeMeta();
  META.houseName = v;
  saveMeta();
  setLegacyTab('upgrades');
}

(function(){
  const _renderRunesmith = renderRunesmith;
  renderRunesmith = function(){
    const base = _renderRunesmith();
    // Insert our house/aspects panel at the top of the tab
    const needle = `<div style="font-size:16px;font-weight:700;color:var(--gold);margin-bottom:4px">Legacy Runesmith</div>`;
    if(base.includes(needle)){
      return base.replace(needle, aspectsHTML() + needle);
    }
    return aspectsHTML() + base;
  };
})();


function rootDepthIcon(tier){
  // Returns a colored áš¢ rune representing RagnarÃ¶k depth
  const t=Math.max(0,Math.min(15,tier||0));
  let color;
  if(t===0) color='var(--txt3)';
  else if(t<=3) color='#c8cce8';
  else if(t<=7) color='var(--amber)';
  else if(t<=11) color='#c07810';
  else color='#8a1010';
  const glow=t>=12?';text-shadow:0 0 6px rgba(180,20,20,.5)':'';
  return `<span style="color:${color}${glow};font-size:14px">áš¢</span>`;
}

function rootDepthLabel(tier){
  if(!tier||tier===0) return '';
  const TIER_NAMES=[
    '',
    'First Root Darkens','The Wolves Stir','Mist Thickens',
    'The Dead Remember','JÃ¶rmungandr Stirs','The Norns Bargain',
    'Surtr Sends Scouts','BifrÃ¶st Cracks','Root Harvest',
    'Elites Without Season','Fimbulwinter Arrives',"The Gnawer's Influence Spreads",
    'Eitr in the Air','Twilight Accelerates','True RagnarÃ¶k'
  ];
  return TIER_NAMES[tier]||`Tier ${tier}`;
}

function updateRootDepthHeader(){
  const el=document.getElementById('hdr-root-depth');
  if(!el)return;
  const tier=META.ragnarÃ¶kActive||0;
  if(tier===0){el.innerHTML='';el.title='';return;}
  const tierDef=(typeof RAGNARÃ–K_TIERS!=='undefined')?RAGNARÃ–K_TIERS[tier-1]:null;
  const tierName=rootDepthLabel(tier);
  const omen=tierDef?.omen||'';
  el.innerHTML=`${rootDepthIcon(tier)} <span style="font-family:'Share Tech Mono',monospace;font-size:10px">R${tier}</span>`;
  el.title=`${tierName}
"${omen}"`;
  el.style.cursor='help';
}

function showOpeningNarrative(){
  // Mark as seen immediately so a crash during the overlay doesn't re-show it
  META.hasSeenOpening=true;
  saveMeta();

  const lines=[
    'The World Tree is sick.',
    'Something moves in the roots. The branches thin. The realms that hang from Yggdrasil grow colder, stranger, more dangerous â€” as though something beneath is feeding.',
    'The Allfather has no answer yet. Only a belief: that the right bloodline, shaped across enough trials, might reach the source.',
    'You are not the hero. You are the line itself â€” the thread that persists when each champion falls. You choose who carries it next. You decide what each saga leaves behind.',
  ];

  const lineHTML=lines.map((l,i)=>`
    <p style="
      color:${i===3?'var(--txt)':'var(--txt2)'};
      font-size:${i===3?'13px':'12px'};
      line-height:1.8;
      margin-bottom:${i===3?'0':'14px'};
      font-weight:${i===3?'700':'400'};
      opacity:0;
      animation: fadeInLine .6s ease forwards;
      animation-delay:${(i+1)*1.1}s;
    ">${l}</p>
  `).join('');

  const html=`
    <div style="text-align:center;padding:8px 0 20px">
      <div style="
        font-size:28px;
        color:var(--txt3);
        margin-bottom:28px;
        opacity:0;
        animation: fadeInLine 1.2s ease forwards;
        animation-delay:.2s;
      ">áš¢</div>
      <div style="text-align:left;margin-bottom:28px">
        ${lineHTML}
      </div>
      <button id="opening-begin-btn" class="btn btn-primary" disabled style="
        opacity:0;
        animation: fadeInLine .6s ease forwards;
        animation-delay:${(lines.length+1)*1.1}s;
        padding:10px 32px;
        font-size:14px;
      " onclick="hideOverlay();showStartScreen()">Begin</button>
    </div>
  `;

  if(!document.getElementById('narrative-style')){
    const style=document.createElement('style');
    style.id='narrative-style';
    style.textContent=`@keyframes fadeInLine { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none} }`;
    document.head.appendChild(style);
  }

  showOverlayContent(html);
  const enableAfter=((lines.length+1)*1.1+0.65)*1000;
  setTimeout(()=>{
    const btn=document.getElementById('opening-begin-btn');
    if(btn) btn.disabled=false;
  },enableAfter);
}

// --- Show house on start screen (override) ---
function showStartScreen(){
  normalizeMeta();

  // Gate: show opening narrative on first ever launch
  if(!META.hasSeenOpening){
    showOpeningNarrative();
    return;
  }

  closeDrawers();

  const hasRetired=META.retiredPool&&META.retiredPool.length>0;
  const retiredCount=META.retiredPool?META.retiredPool.length:0;
  const fallenCount=META.fallenLedger?META.fallenLedger.length:0;
  const activeTier=META.ragnarÃ¶kActive||0;
  const maxTier=META.ragnarÃ¶kTier||0;
  const tierName=rootDepthLabel(activeTier);
  const tierOmen=(typeof RAGNARÃ–K_TIERS!=='undefined'&&activeTier>0)
    ? ((RAGNARÃ–K_TIERS[activeTier-1]&&RAGNARÃ–K_TIERS[activeTier-1].omen)||'') : '';

  let html=`
    <div style="text-align:center;margin-bottom:4px">
      <div style="font-family:'Orbitron',sans-serif;font-size:20px;font-weight:900;
                  color:var(--violet);text-shadow:0 0 20px rgba(144,80,232,.6)">áš  RUNESAGA</div>
    </div>

    <div style="background:rgba(212,160,23,.06);border:1px solid rgba(212,160,23,.2);
                border-radius:6px;padding:10px 14px;margin:10px 0 14px;text-align:left">
      <div style="font-family:'Orbitron',sans-serif;font-size:13px;font-weight:900;
                  color:var(--gold);letter-spacing:1px">á›Ÿ House ${META.houseName}</div>
      <div style="font-size:10px;color:var(--txt3);margin-top:4px;font-family:'Share Tech Mono',monospace">
        ${fallenCount} saga${fallenCount!==1?'s':''} closed Â· ${retiredCount} thread${retiredCount!==1?'s':''} endure
      </div>
      ${activeTier>0?`
        <div style="margin-top:6px;display:flex;align-items:center;gap:6px">
          ${rootDepthIcon(activeTier)}
          <span style="font-size:11px;font-weight:700;color:var(--amber)">${tierName}</span>
        </div>
        ${tierOmen?`<div style="font-size:10px;color:var(--txt3);font-style:italic;margin-top:3px">"${tierOmen}"</div>`:''}
      `:`
        <div style="font-size:10px;color:var(--txt3);margin-top:4px;font-style:italic">
          The root is uncharted. No depth selected.
        </div>
      `}
    </div>
  `;

  if(hasRetired){
    html+=`
      <div style="background:rgba(64,224,120,.06);border:1px solid rgba(64,224,120,.2);
                  border-radius:5px;padding:8px 12px;margin-bottom:12px;font-size:11px;color:var(--txt2)">
        ðŸ› ${retiredCount} hero${retiredCount!==1?'es':''} await in the Hall. The thread grows stronger.
      </div>
    `;
  }

  if(maxTier>0){
    html+=`
      <div style="margin-bottom:14px">
        <div style="font-size:10px;color:var(--txt3);letter-spacing:1px;text-transform:uppercase;
                    margin-bottom:6px">Root Depth â€” Choose how deep</div>
        <div style="display:flex;align-items:center;gap:10px">
          <button class="btn btn-sm btn-ghost" onclick="adjustRagnarÃ¶kActive(-1)"
                  ${activeTier<=0?'disabled style="opacity:.4"':''}>â—€</button>
          <div style="flex:1;text-align:center">
            ${rootDepthIcon(activeTier)}
            <span style="font-family:'Share Tech Mono',monospace;font-size:12px;
                         color:var(--gold);margin-left:6px">${activeTier===0?'Surface (Tier 0)':`Tier ${activeTier}: ${tierName}`}</span>
          </div>
          <button class="btn btn-sm btn-ghost" onclick="adjustRagnarÃ¶kActive(1)"
                  ${activeTier>=maxTier?'disabled style="opacity:.4"':''}>â–¶</button>
        </div>
        ${activeTier>0?`
          <div style="font-size:10px;color:var(--txt3);text-align:center;margin-top:4px;font-style:italic">
            "You descend the root."
          </div>
        `:''}
      </div>
    `;
  }

  html+=`
    <div style="margin-bottom:14px">
      <button class="btn btn-sm btn-ghost" style="width:100%;font-size:10px"
              onclick="document.getElementById('seed-wrap').style.display=(document.getElementById('seed-wrap').style.display==='none'?'block':'none')">
        Advanced â–¾
      </button>
      <div id="seed-wrap" style="display:none;margin-top:8px">
        <label style="font-size:10px;color:var(--txt3);display:block;margin-bottom:4px;
                       letter-spacing:1px;text-transform:uppercase">Saga Seed (optional)</label>
        <input id="seed-input" type="text" placeholder="Leave blank for random"
          style="width:100%;background:var(--bg2);border:1px solid var(--border2);
                 color:var(--txt);padding:8px 12px;border-radius:4px;font-size:12px;
                 font-family:'Share Tech Mono',monospace;text-align:center;outline:none">
      </div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-primary" style="flex:2;min-width:180px;padding:11px"
              onclick="startNewRunFromOverlay()">â–¶ Begin New Saga</button>
      <button class="btn btn-gold" style="flex:1;min-width:120px;padding:11px"
              onclick="hideOverlay();showLegacy()">á›Ÿ Hero Hall</button>
    </div>
  `;

  showOverlayContent(html);
  updateDifficultyUI();
  syncChromeHeights();
}

function adjustRagnarÃ¶kActive(delta){
  normalizeMeta();
  const maxTier=META.ragnarÃ¶kTier||0;
  const prevTier=META.ragnarÃ¶kActive||0;
  META.ragnarÃ¶kActive=Math.max(0,Math.min(maxTier,prevTier+delta));
  saveMeta();
  updateRootDepthHeader();
  showStartScreen();
}

// --- Ensure founder record uses house + aspect naming ---
function startFirstHero(){
  normalizeMeta();
  const founder=mkHeroRecord(genName(0,'Steel',null,null),0,[],emptyEVs(),[]);
  founder.birthAspect='Steel';
  founder.birthFlags={};
  META.family[founder.id]=founder;
  saveMeta();
  initGame(null,emptyEVs(),[],founder);
}

// --- Award aspect XP on retire/victory/fallen, and show fallen harvest ---
(function(){
  const _retireHero = retireHero;
  retireHero = function(){
    try{ awardAspectXPFromRun('retired'); }catch(e){}
    try{ checkRagnarÃ¶kUnlock(); }catch(e){}
    _retireHero();
    // ensure persisted
    try{ saveMeta(); }catch(e){}
  };

  const _pickBoon = pickBoon;
  pickBoon = function(id){
    const wasFinal = !!(G && G.wave>=G.maxWaves);
    _pickBoon(id);
    if(wasFinal && G && G.phase==='VICTORY'){
      try{ awardAspectXPFromRun('victory'); }catch(e){}
    }
  };

  const _heroFell = heroFell;
  heroFell = function(){
    _heroFell();
    try{ awardAspectXPFromRun('fallen'); }catch(e){}
    // Offer harvest choice overlay
    try{
      const rec = (G && G.hero && G.hero.record) ? G.hero.record : null;
      if(rec && rec.id){
        const saved = META.family[rec.id];
        const sal = saved?.runResult?.salvageEarned || 0;
        showFallenScarChoice(rec.id, sal);
      }
    }catch(e){}
  };
})();

// --- Re-assert a clean onload so normalizeMeta is always applied first ---
window.onload = ()=>{
  loadMeta();
  normalizeMeta();
  Object.values(META.family||{}).forEach(h=>{
    if(!h.evs) h.evs=emptyEVs();
    if(!h.traits) h.traits=[];
    if(!h.birthAspect) h.birthAspect='Steel';
    if(!h.birthFlags) h.birthFlags={};
  });
  if(Array.isArray(META.retiredPool)){
    META.retiredPool=META.retiredPool.filter(id=>{
      const r=META.family[id];
      if(!r) return false;
      return getBreedUses(r).left>0;
    });
  }
  saveMeta();
  const small=window.matchMedia('(max-width: 420px)').matches;
  if(small&&localStorage.getItem(UI_KEY)===null){
    UI.logCollapsed=true;
    saveUI();
  }
  loadUI();
  if(typeof UI.difficulty!=='number') UI.difficulty=1;
  setCombatLogCollapsed(UI.logCollapsed);
  updateDifficultyUI();
  updateRootDepthHeader();
  showStartScreen(); // Handles opening narrative gate internally
  setTimeout(applyResponsiveLayout,0);
};


// --- V5: Breeding-use calculation considers Catalyze + Gale Aspect ---
function calcBreedUsesForRetire(rec){
  normalizeMeta();
  const n = (META.upgrades && META.upgrades.nursery) ? META.upgrades.nursery : 0;
  let p2 = 0.10 + n*0.07;
  if(n>=5) p2 += 0.05;
  // small randomness per retire
  if(rng()<0.12) p2 += 0.08;
  // Catalyzed births tend to be more "fertile"
  if(rec && rec.birthFlags && rec.birthFlags.catalyzed) p2 += 0.12;
  // Gale aspect subtly increases second-breed odds across the house
  p2 += getAspectRank('Gale') * 0.02;
  // Stabilized (not tracked) would lower, but we keep it simple.
  p2 = Math.max(0.02, Math.min(0.85, p2));
  return (rng() < p2) ? 2 : 1;
}

</script>
</body>
</html>
